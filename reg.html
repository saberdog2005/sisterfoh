<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #121212; color: #e0e0e0; }
        .container { max-width: 800px; margin: 0 auto; background: #1e1e1e; padding: 20px; border-radius: 5px; }
        button { margin: 5px; padding: 10px; background: #333; color: #fff; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #555; }
        .cash { background: #4caf50; }
        .cc { background: #f44336; }
        .ticket { background: #2196f3; }
        .comp { background: #ff9800; }
        #currentItems { margin: 10px 0; }
        .item { padding: 5px; background: #2a2a2a; margin: 5px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="color: #bb86fc;">Sales Register</h1>
        <button id="startSession">Start Session</button>
        <button id="endSession">End Session</button>
        <div>
            <button class="cash" data-item="CASH $20" data-price="20">CASH $20</button>
            <button class="cash" data-item="CASH $10" data-price="10">CASH $10</button>
            <button class="cc" data-item="CC TRANS" data-price="0">CC TRANS</button>
            <button class="ticket" data-item="TICKET" data-price="0">TICKET</button>
            <button class="comp" data-item="COMP" data-price="0">COMP</button>
            <input id="customCash" type="number" placeholder="Custom Cash Amount" step="0.01">
            <button id="addCustomCash">Add Custom Cash</button>
        </div>
        <div id="currentItems"></div>
        <p>Total Cash: $<span id="cashTotal">0.00</span> | Thru Door: <span id="doorCount">0</span></p>
        <button id="logSale">Log Sale</button>
    </div>

    <script>
        class SalesApp {
            constructor() {
                this.state = {
                    cashTotal: 0,
                    doorCount: 0,
                    currentItems: new Map(),
                    activeSessionId: null
                };
                this.elements = {
                    cashTotal: document.getElementById('cashTotal'),
                    doorCount: document.getElementById('doorCount'),
                    currentItems: document.getElementById('currentItems'),
                    startSession: document.getElementById('startSession'),
                    endSession: document.getElementById('endSession'),
                    logSale: document.getElementById('logSale'),
                    customCash: document.getElementById('customCash'),
                    addCustomCash: document.getElementById('addCustomCash')
                };
                this.db = null;
                this.initDB();
                this.bindEvents();
                this.loadSession();
            }

            initDB() {
                const request = indexedDB.open('SalesDB', 2);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('transactions')) {
                        db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                };
                request.onerror = (event) => console.error('Database error:', event.target.error);
            }

            bindEvents() {
                document.querySelectorAll('button[data-item]').forEach(btn => {
                    btn.addEventListener('click', () => this.handleIncrement(btn.dataset.item, parseFloat(btn.dataset.price)));
                });
                this.elements.startSession.addEventListener('click', () => this.startSession());
                this.elements.endSession.addEventListener('click', () => this.endSession());
                this.elements.logSale.addEventListener('click', () => this.logSale());
                this.elements.addCustomCash.addEventListener('click', () => this.handleCustomCash());
                this.elements.currentItems.addEventListener('click', (e) => {
                    if (e.target.classList.contains('decrement')) {
                        this.handleDecrement(e.target.dataset.item, parseFloat(e.target.dataset.price));
                    }
                });
            }

            loadSession() {
                const sessionId = localStorage.getItem('activeSessionId');
                if (sessionId) {
                    this.state.activeSessionId = sessionId;
                    this.elements.startSession.disabled = true;
                    this.elements.endSession.disabled = false;
                } else {
                    this.elements.startSession.disabled = false;
                    this.elements.endSession.disabled = true;
                }
            }

            startSession() {
                this.state.activeSessionId = Date.now().toString();
                localStorage.setItem('activeSessionId', this.state.activeSessionId);
                this.elements.startSession.disabled = true;
                this.elements.endSession.disabled = false;
            }

            endSession() {
                localStorage.removeItem('activeSessionId');
                this.state.activeSessionId = null;
                this.state.cashTotal = 0;
                this.state.doorCount = 0;
                this.state.currentItems.clear();
                this.updateDisplay();
                this.elements.startSession.disabled = false;
                this.elements.endSession.disabled = true;
            }

            updateTotals(priceDelta, countDelta, item) {
                if (item.startsWith('CASH')) {
                    this.state.cashTotal += priceDelta;
                }
                this.state.doorCount += countDelta; // Increment doorCount for all types, including COMP
                this.elements.cashTotal.textContent = this.state.cashTotal.toFixed(2);
                this.elements.doorCount.textContent = this.state.doorCount;
            }

            handleIncrement(item, price) {
                const current = this.state.currentItems.get(item) || { count: 0, price };
                current.count += 1;
                this.state.currentItems.set(item, current);
                this.updateTotals(price, 1, item);
                this.updateDisplay();
            }

            handleDecrement(item, price) {
                const current = this.state.currentItems.get(item);
                if (current && current.count > 0) {
                    current.count -= 1;
                    this.updateTotals(-price, -1, item);
                    if (current.count === 0) this.state.currentItems.delete(item);
                    this.updateDisplay();
                }
            }

            handleCustomCash() {
                const amount = parseFloat(this.elements.customCash.value);
                if (amount > 0) {
                    const item = `CASH $${amount}`;
                    this.updateTotals(amount, 1, item);
                    const current = this.state.currentItems.get(item) || { count: 0, price: amount };
                    current.count += 1;
                    this.state.currentItems.set(item, current);
                    this.updateDisplay();
                    this.elements.customCash.value = '';
                }
            }

            updateDisplay() {
                this.elements.currentItems.innerHTML = Array.from(this.state.currentItems.entries())
                    .map(([item, { count, price }]) => `
                        <div class="item">
                            ${item}: ${count} <button class="decrement" data-item="${item}" data-price="${price}">-</button>
                        </div>
                    `).join('');
            }

            logSale() {
                if (!this.state.activeSessionId) {
                    alert('No active session');
                    return;
                }
                if (this.state.currentItems.size === 0) {
                    alert('No items to log');
                    return;
                }
                const transaction = {
                    sessionId: this.state.activeSessionId,
                    timestamp: new Date().toISOString(),
                    items: Array.from(this.state.currentItems.entries())
                        .map(([key, { count, price }]) => `${key}: ${count} @ $${price.toFixed(2)}`)
                        .join(', '),
                    cashTotal: this.state.cashTotal,
                    doorCount: this.state.doorCount
                };
                const tx = this.db.transaction(['transactions'], 'readwrite');
                const store = tx.objectStore('transactions');
                store.add(transaction);
                tx.oncomplete = () => {
                    console.log('Transaction logged');
                    this.state.currentItems.clear();
                    this.updateDisplay();
                };
                tx.onerror = (event) => console.error('Transaction error:', event.target.error);
            }
        }

        new SalesApp();
    </script>
</body>
</html>
