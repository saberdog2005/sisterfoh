<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://code.jquery.com 'unsafe-inline'; object-src 'none';">
    <title>Sister Bar Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        /* Existing styles remain unchanged */
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <label for="eventDate">Date:</label>
            <input type="date" id="eventDate" required>
            <label for="eventVenue">Venue:</label>
            <input type="text" id="eventVenue" value="Sister Bar" required>
            <label for="eventName">Event Name:</label>
            <input type="text" id="eventName" placeholder="Event Name">
            <label for="cashierName">Cashier Name:</label>
            <input type="text" id="cashierName" placeholder="Cashier" required>
        </header>
        <main class="container">
            <div id="editInstructions" class="hidden">Drag buttons to reorder or click to toggle active state. Click 'Save Layout' when done.</div>
            <div class="button-container">
                <!-- Product buttons remain unchanged -->
            </div>
            <div class="note-section">
                <label for="noteInput">Add a note...</label>
                <textarea id="noteInput" placeholder="Add a note..."></textarea>
            </div>
            <div id="addButtonForm">
                <h3>Add New Button</h3>
                <select id="newButtonType" required>
                    <option value="">Select Type</option>
                    <option value="CASH">CASH</option>
                    <option value="CC TRANS">CC TRANS</option>
                    <option value="TICKET">TICKET</option>
                    <option value="COMP">COMP</option>
                </select>
                <input type="text" id="newButtonName" placeholder="Name (e.g., CASH $20)">
                <input type="number" id="newButtonValue" step="0.01" min="0" placeholder="Value">
                <button id="submitNewButton">Submit</button>
                <button id="cancelNewButton">Cancel</button>
            </div>
            <button id="logSaleBtn">Log Sale</button>
        </main>
        <footer class="footer">
            <div class="totals-container">
                <h3>Cash Total: $<span id="cashTotal" class="total-value">0.00</span></h3>
                <h3>Total Thru Door: <span id="sessionDoorCount" class="total-value">0</span></h3>
            </div>
            <div class="footer-right">
                <button id="toggleSalesBtn" class="open-btn">Open Sales</button>
                <button id="editLayoutBtn" class="edit-btn">Edit Layout</button>
                <div id="successMessage" aria-live="polite"></div>
                <div id="errorMessage" aria-live="polite"></div>
            </div>
        </footer>
        <div id="pinModal" class="modal">
            <div class="modal-content">
                <h2>Enter PIN to Close Sales</h2>
                <input type="password" id="pinInput" placeholder="PIN">
                <button id="submitPinBtn">Submit</button>
                <button id="cancelPinBtn">Cancel</button>
                <p id="pinError" style="color: red;"></p>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nnbevkohcjnzyxgkzgna.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uYmV2a29oY2puenl4Z2t6Z25hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5OTU5NTksImV4cCI6MjA1NzU3MTk1OX0.azv5XuUBxoyvr19-eGxnl37X7u0GOlCRj3L0jZ_8JHY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        const DEFAULT_PIN = '0000';
        const channel = new BroadcastChannel('transaction_channel');

        class Register {
            constructor() {
                // Load last event name and cashier name from localStorage
                this.elements = {
                    eventName: document.getElementById('eventName'),
                    cashierName: document.getElementById('cashierName'),
                    toggleSalesBtn: document.getElementById('toggleSalesBtn'),
                    editLayoutBtn: document.getElementById('editLayoutBtn'),
                    // Other elements...
                };
                this.state = {
                    sessionStarted: false,
                    sessionId: null,
                    currentItems: new Map(),
                    cashTotal: 0,
                    doorCount: 0,
                    sessionDoorCount: 0,
                    isEditing: false,
                    activeButtons: new Map(Object.entries(JSON.parse(localStorage.getItem('activeButtons')) || {})),
                    isLogging: false,
                    lastLogTime: 0
                };
                this.elements.eventName.value = localStorage.getItem('lastEventName') || '';
                this.elements.cashierName.value = localStorage.getItem('lastCashierName') || '';

                // Bind events
                this.elements.toggleSalesBtn.addEventListener('click', () => this.toggleSales());
                this.elements.editLayoutBtn.addEventListener('click', () => this.toggleEditMode());
                // Other bindings...

                // Initial checks
                this.checkSessionStatus();
                this.loadSessionDoorCount();
                this.initializeButtonStates();
                this.loadButtonPositions();
            }

            // Other methods...

            toggleSales = () => {
                if (!this.state.sessionStarted) {
                    this.startSession();
                } else {
                    this.elements.pinModal.style.display = 'block';
                }
            }

            startSession = () => {
                if (!this.elements.eventDate.value || !this.elements.eventVenue.value || !this.elements.cashierName.value) {
                    this.showError('Please fill in all required fields');
                    return;
                }
                // Save last event name and cashier name
                localStorage.setItem('lastEventName', this.elements.eventName.value);
                localStorage.setItem('lastCashierName', this.elements.cashierName.value);
                this.state.sessionStarted = true;
                this.state.sessionId = `${this.elements.eventDate.value}-${this.elements.eventVenue.value}-${this.elements.cashierName.value}-${Date.now()}`;
                this.state.sessionDoorCount = 0;
                this.elements.sessionDoorCount.textContent = '0';
                this.elements.toggleSalesBtn.textContent = 'Close Sales';
                this.elements.toggleSalesBtn.classList.remove('open-btn');
                this.elements.toggleSalesBtn.classList.add('close-btn');
                this.showSuccess('Session started');
                this.checkSessionStatus(); // Update UI
            }

            confirmCloseSales = () => {
                if (this.elements.pinInput.value === DEFAULT_PIN) {
                    this.closeSession();
                } else {
                    this.elements.pinError.textContent = 'Incorrect PIN';
                }
            }

            closeSession = () => {
                this.logSale(true);
                this.state.sessionStarted = false;
                this.state.sessionId = null;
                this.state.currentItems.clear();
                this.state.cashTotal = 0;
                this.state.doorCount = 0;
                this.state.sessionDoorCount = 0;
                localStorage.setItem('sessionDoorCount', '0');
                this.elements.counts.forEach(count => count.textContent = '0');
                this.elements.cashTotal.textContent = '0.00';
                this.elements.sessionDoorCount.textContent = '0';
                this.elements.toggleSalesBtn.textContent = 'Open Sales';
                this.elements.toggleSalesBtn.classList.remove('close-btn');
                this.elements.toggleSalesBtn.classList.add('open-btn');
                this.elements.pinModal.style.display = 'none';
                this.elements.pinInput.value = '';
                this.elements.pinError.textContent = '';
                this.showSuccess('Session closed');
                this.checkSessionStatus(); // Update UI
            }

            toggleEditMode = () => {
                if (this.state.sessionStarted) {
                    alert('Cannot edit layout while sales session is active');
                    return;
                }
                this.state.isEditing = !this.state.isEditing;
                if (!this.state.isEditing) {
                    this.saveButtonLayout();
                }
                this.elements.editLayoutBtn.textContent = this.state.isEditing ? 'Save Layout' : 'Edit Layout';
                // Add logic to show/hide edit controls based on isEditing
            }

            saveButtonLayout = () => {
                const layout = { /* Your button configuration */ };
                localStorage.setItem('buttonLayout', JSON.stringify(layout));
            }

            loadButtonLayout = () => {
                const layout = JSON.parse(localStorage.getItem('buttonLayout') || '{}');
                // Apply layout to UI
            }

            checkSessionStatus = () => {
                if (this.state.sessionStarted) {
                    this.elements.toggleSalesBtn.textContent = 'Close Sales';
                    this.elements.toggleSalesBtn.classList.remove('open-btn');
                    this.elements.toggleSalesBtn.classList.add('close-btn');
                    this.elements.editLayoutBtn.style.display = 'none';
                    // Disable header inputs
                    const inputs = [this.elements.eventName, this.elements.cashierName];
                    inputs.forEach(input => input.disabled = true);
                } else {
                    this.elements.toggleSalesBtn.textContent = 'Open Sales';
                    this.elements.toggleSalesBtn.classList.remove('close-btn');
                    this.elements.toggleSalesBtn.classList.add('open-btn');
                    this.elements.editLayoutBtn.style.display = 'block';
                    // Enable header inputs
                    const inputs = [this.elements.eventName, this.elements.cashierName];
                    inputs.forEach(input => input.disabled = false);
                }
            }

            // Other methods remain unchanged
        }

        document.addEventListener('DOMContentLoaded', () => new Register());
    </script>
</body>
</html>
