<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://code.jquery.com https://unpkg.com 'unsafe-inline'; object-src 'none';">
    <title>Sister Bar Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* Your existing CSS remains unchanged */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 5px;
            background-color: #1e1e1e;
            color: #e0e0e0;
            font-size: 16px;
            height: 100vh;
            overflow: hidden;
        }
        /* ... (rest of your CSS) ... */
    </style>
</head>
<body>
    <div class="container">
        <!-- Your existing HTML structure remains unchanged -->
        <header class="header">
            <label for="eventDate">Date:</label>
            <input type="date" id="eventDate" required>
            <label for="eventVenue">Venue:</label>
            <input type="text" id="eventVenue" value="Sister Bar" required>
            <label for="eventName">Event Name:</label>
            <input type="text" id="eventName" placeholder="Event Name">
            <label for="cashierName">Cashier Name:</label>
            <input type="text" id="cashierName" placeholder="Cashier" required>
        </header>
        <main class="container">
            <div id="editInstructions" class="hidden">Click buttons to toggle active state. Drag to reorder. Click 'Save Layout' when done.</div>
            <div class="button-container">
                <!-- Product items will be dynamically loaded here -->
            </div>
            <div class="note-section">
                <label for="noteInput">Add a note...</label>
                <textarea id="noteInput" placeholder="Add a note..."></textarea>
            </div>
            <button id="logSaleBtn">Log Sale</button>
            <div class="totals-container">
                <h3 style="color: white;">Cash Total: $<span id="cashTotal">0.00</span></h3>
                <h3 style="color: white;">Thru Door: <span id="doorCount">0</span></h3>
            </div>
        </main>
        <footer class="footer">
            <div class="totals">
                <span id="successMessage" aria-live="polite"></span>
                <span id="errorMessage" aria-live="polite"></span>
            </div>
            <div class="buttons">
                <button id="toggleSalesBtn" class="open-btn">Open Sales</button>
                <button id="editLayoutBtn" class="edit-btn">Edit Layout</button>
            </div>
        </footer>

        <!-- Modals and forms remain unchanged -->
        <div id="pinModal" class="modal">
            <div class="modal-content">
                <h2>Enter PIN to Close Sales</h2>
                <input type="password" id="pinInput" placeholder="PIN">
                <button id="submitPinBtn">Submit</button>
                <button id="cancelPinBtn">Cancel</button>
                <p id="pinError" style="color: red;"></p>
            </div>
        </div>

        <div id="addButtonForm">
            <h3>Add New Button</h3>
            <select id="newButtonType">
                <option value="">Select Type</option>
                <option value="CASH">CASH</option>
                <option value="CC">CC</option>
                <option value="TICKET">TICKET</option>
                <option value="COMP">COMP</option>
            </select>
            <input type="text" id="newButtonName" placeholder="Name (e.g., CASH $20)">
            <input type="number" id="newButtonValue" step="0.01" min="0" placeholder="Value">
            <button id="submitNewButton">Submit</button>
            <button id="cancelNewButton">Cancel</button>
        </div>
    </div>

    <script>
        const SERVER_URL = 'https://nnbevkohcjnzyxgkzgna.supabase.co/rest/v1/transactions';
        const API_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uYmV2a29oY2puenl4Z2t6Z25hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5OTU5NTksImV4cCI6MjA1NzU3MTk1OX0.azv5XuUBxoyvr19-eGxnl37X7u0GOlCRj3L0jZ_8JHY';
        const DEFAULT_PIN = '0000';
        const channel = new BroadcastChannel('transaction_channel');

        class SalesApp {
            constructor() {
                this.state = {
                    sessionStarted: false,
                    sessionId: null,
                    currentItems: new Map(),
                    cashTotal: 0,
                    doorCount: 0,
                    sessionDoorCount: 0,
                    isEditing: false,
                    activeButtons: new Map(),
                    isLogging: false,
                    lastLogTime: 0
                };
                this.elements = {
                    buttonContainer: document.querySelector('.button-container'),
                    transactionButtons: [],
                    counts: new Map(),
                    eventDate: document.getElementById('eventDate'),
                    eventVenue: document.getElementById('eventVenue'),
                    eventName: document.getElementById('eventName'),
                    cashierName: document.getElementById('cashierName'),
                    toggleSalesBtn: document.getElementById('toggleSalesBtn'),
                    editLayoutBtn: document.getElementById('editLayoutBtn'),
                    logSaleBtn: document.getElementById('logSaleBtn'),
                    cashTotal: document.getElementById('cashTotal'),
                    doorCount: document.getElementById('doorCount'),
                    noteInput: document.getElementById('noteInput'),
                    addButtonForm: document.getElementById('addButtonForm'),
                    newButtonType: document.getElementById('newButtonType'),
                    newButtonName: document.getElementById('newButtonName'),
                    newButtonValue: document.getElementById('newButtonValue'),
                    submitNewButton: document.getElementById('submitNewButton'),
                    cancelNewButton: document.getElementById('cancelNewButton'),
                    pinModal: document.getElementById('pinModal'),
                    pinInput: document.getElementById('pinInput'),
                    submitPinBtn: document.getElementById('submitPinBtn'),
                    cancelPinBtn: document.getElementById('cancelPinBtn'),
                    pinError: document.getElementById('pinError'),
                    editInstructions: document.getElementById('editInstructions'),
                    successMessage: document.getElementById('successMessage'),
                    errorMessage: document.getElementById('errorMessage')
                };
                this.elements.eventDate.value = new Date().toISOString().split('T')[0];
                this.loadLayout();
                this.checkSessionStatus();
                this.loadSessionDoorCount();
                this.enableDragAndDrop();
                this.bindEvents();
            }

            // Other methods remain unchanged unless specified
            loadLayout() { /* Unchanged */ }
            createProductItem(itemData) { /* Unchanged */ }
            bindEvents() { /* Unchanged */ }
            enableDragAndDrop() { /* Unchanged */ }
            saveLayout() { /* Unchanged */ }
            toggleEditMode() { /* Unchanged */ }
            toggleButtonState(btn) { /* Unchanged */ }
            addNewButton() { /* Unchanged */ }
            cancelAddButton() { /* Unchanged */ }
            handleIncrement(btn) { /* Unchanged */ }
            handleDecrement(btn) { /* Unchanged */ }
            updateTotals(priceDelta, countDelta, type) { /* Unchanged */ }

            async logSale() {
                if (!this.state.sessionStarted || this.state.isLogging) return;
                this.state.isLogging = true;
                this.elements.logSaleBtn.disabled = true;

                // Prepare transaction data
                const items = Array.from(this.state.currentItems.entries())
                    .filter(([_, value]) => value.count > 0)
                    .map(([key, value]) => `${value.type.toUpperCase()} ${key}: ${value.count} @ $${value.price.toFixed(2)}`)
                    .join('; ');

                const transaction = {
                    event_date: this.elements.eventDate.value,
                    event_venue: this.elements.eventVenue.value,
                    event_name: this.elements.eventName.value,
                    cashier_name: this.elements.cashierName.value,
                    items: items || 'No items',
                    cash_total: Number(this.state.cashTotal), // Ensure numeric type
                    door_count: Number(this.state.sessionDoorCount), // Ensure numeric type
                    note: this.elements.noteInput.value,
                    session_id: this.state.sessionId,
                    timestamp: new Date().toISOString()
                };

                // Log transaction data for debugging
                console.log('Transaction data:', transaction);

                try {
                    const response = await fetch(SERVER_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': API_KEY,
                            'Authorization': `Bearer ${API_KEY}`
                        },
                        body: JSON.stringify(transaction)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Server error:', errorData);
                        throw new Error(`Failed to log sale: ${errorData.message || 'Unknown error'}`);
                    }

                    channel.postMessage({ type: 'transaction', data: transaction });
                    this.resetCurrentItems();
                    this.elements.noteInput.value = '';
                    this.showSuccess('Sale logged successfully');
                } catch (error) {
                    console.error('Error logging sale:', error);
                    this.showError('Failed to log sale');
                } finally {
                    this.state.isLogging = false;
                    this.elements.logSaleBtn.disabled = false;
                }
            }

            debounceLogSale() { /* Unchanged */ }
            resetCurrentItems() { /* Unchanged */ }
            toggleSales() { /* Unchanged */ }
            startSession() { /* Unchanged */ }
            async confirmCloseSales() { /* Unchanged */ }
            async closeSession() { /* Unchanged */ }
            cancelPinModal() { /* Unchanged */ }
            checkSessionStatus() { /* Unchanged */ }
            loadSessionDoorCount() { /* Unchanged */ }
            showSuccess(message) { /* Unchanged */ }
            showError(message) { /* Unchanged */ }
        }

        document.addEventListener('DOMContentLoaded', () => new SalesApp());
    </script>
</body>
</html>
