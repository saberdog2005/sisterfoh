<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1e1e1e;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 800px;
            width: 100%;
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        h1 {
            text-align: center;
            color: #bb86fc;
        }
        .controls, .totals {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            opacity: 0.9;
        }
        .cash-btn { background-color: #2e7d32; color: white; }
        .cc-btn { background-color: #d32f2f; color: white; }
        .ticket-btn { background-color: #1a73e8; color: white; }
        .comp-btn { background-color: #ffa500; color: white; }
        .control-btn { background-color: #bb86fc; color: #1e1e1e; }
        .totals span {
            font-size: 18px;
        }
        input[type="number"] {
            padding: 8px;
            margin: 5px;
            border-radius: 4px;
            border: 1px solid #555;
            background-color: #3c3c3c;
            color: #e0e0e0;
        }
        #current-items {
            margin-top: 20px;
            padding: 10px;
            background-color: #3c3c3c;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Register</h1>
        <div class="controls">
            <button id="cash-20" class="cash-btn" data-item="CASH $20" data-price="20">CASH $20</button>
            <button id="cc-trans" class="cc-btn" data-item="CC TRANS" data-price="0">CC TRANS</button>
            <button id="ticket" class="ticket-btn" data-item="TICKET" data-price="0">TICKET</button>
            <button id="comp" class="comp-btn" data-item="COMP" data-price="0">COMP</button>
        </div>
        <div class="controls">
            <input type="number" id="custom-cash" placeholder="Custom Cash Amount" step="0.01" min="0">
            <button id="add-custom" class="cash-btn">Add Custom Cash</button>
        </div>
        <div class="controls">
            <button id="log-sale" class="control-btn">Log Sale</button>
            <button id="toggle-sales" class="control-btn">Open Sales</button>
        </div>
        <div class="totals">
            <span>Cash Total: $<span id="cash-total">0.00</span></span>
            <span>Thru Door: <span id="door-count">0</span></span>
        </div>
        <div id="current-items"></div>
    </div>

    <script>
        class Register {
            constructor() {
                this.state = {
                    cashTotal: 0,
                    doorCount: 0,
                    currentItems: {},
                    sessionStarted: false,
                    sessionId: null
                };
                this.elements = {
                    cashTotal: document.getElementById('cash-total'),
                    doorCount: document.getElementById('door-count'),
                    currentItems: document.getElementById('current-items'),
                    toggleSales: document.getElementById('toggle-sales')
                };
                this.db = null;
                this.initDB();
                this.bindEvents();
            }

            initDB() {
                const request = indexedDB.open('SalesDB', 1);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                };
                request.onsuccess = () => this.db = request.result;
                request.onerror = () => console.error('Database error');
            }

            bindEvents() {
                document.querySelectorAll('[data-item]').forEach(btn => {
                    btn.addEventListener('click', () => this.handleIncrement(btn.dataset.item, parseFloat(btn.dataset.price)));
                });
                document.getElementById('add-custom').addEventListener('click', () => this.handleCustomCash());
                document.getElementById('log-sale').addEventListener('click', () => this.logSale());
                this.elements.toggleSales.addEventListener('click', () => this.toggleSales());
            }

            handleIncrement(item, price) {
                if (!this.state.sessionStarted) return;
                this.state.currentItems[item] = (this.state.currentItems[item] || 0) + 1;
                this.updateTotals(price, item, 1);
                this.updateCurrentItems();
            }

            handleDecrement(item, price) {
                if (!this.state.sessionStarted || !this.state.currentItems[item]) return;
                this.state.currentItems[item]--;
                if (this.state.currentItems[item] === 0) delete this.state.currentItems[item];
                this.updateTotals(-price, item, -1);
                this.updateCurrentItems();
            }

            handleCustomCash() {
                if (!this.state.sessionStarted) return;
                const amount = parseFloat(document.getElementById('custom-cash').value);
                if (isNaN(amount) || amount <= 0) return;
                const item = `CASH $${amount.toFixed(2)}`;
                this.state.currentItems[item] = (this.state.currentItems[item] || 0) + 1;
                this.updateTotals(amount, item, 1);
                this.updateCurrentItems();
                document.getElementById('custom-cash').value = '';
            }

            updateTotals(amount, item, doorChange) {
                if (item.startsWith('CASH')) this.state.cashTotal += amount;
                this.state.doorCount += doorChange;
                this.elements.cashTotal.textContent = this.state.cashTotal.toFixed(2);
                this.elements.doorCount.textContent = this.state.doorCount;
            }

            updateCurrentItems() {
                const items = Object.entries(this.state.currentItems)
                    .map(([item, count]) => `${item}: ${count}`)
                    .join(', ');
                this.elements.currentItems.textContent = items || 'No items added';
            }

            async logSale() {
                if (!this.state.sessionStarted || Object.keys(this.state.currentItems).length === 0) return;
                const transaction = {
                    sessionId: this.state.sessionId,
                    items: Object.entries(this.state.currentItems)
                        .map(([item, count]) => `${item}: ${count} @ $${(item.startsWith('CASH') ? parseFloat(item.split('$')[1]) : 0).toFixed(2)}`)
                        .join(', '),
                    cashTotal: this.state.cashTotal,
                    doorCount: this.state.doorCount,
                    timestamp: Date.now()
                };
                const tx = this.db.transaction('transactions', 'readwrite');
                const store = tx.objectStore('transactions');
                await store.add(transaction);
                this.resetForm();
            }

            resetForm() {
                this.state.currentItems = {};
                this.state.cashTotal = 0;
                // Do not reset doorCount here; it persists until session ends
                this.elements.cashTotal.textContent = '0.00';
                this.updateCurrentItems();
            }

            toggleSales() {
                if (!this.state.sessionStarted) {
                    this.state.sessionStarted = true;
                    this.state.sessionId = Date.now();
                    this.state.doorCount = 0; // Reset doorCount for new session
                    this.elements.doorCount.textContent = '0';
                    this.elements.toggleSales.textContent = 'Close Sales';
                } else {
                    this.state.sessionStarted = false;
                    this.state.sessionId = null;
                    this.elements.toggleSales.textContent = 'Open Sales';
                    // Final doorCount is preserved in the last transaction
                }
            }
        }

        new Register();
    </script>
</body>
</html>
