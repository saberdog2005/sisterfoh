<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://code.jquery.com https://www.googleapis.com 'unsafe-inline'; object-src 'none';">
    <title>Sister Bar Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .product-item { background: #fff; padding: 10px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .button-group { display: flex; gap: 5px; margin-top: 5px; }
        button { padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; }
        .increment-btn { background-color: #4CAF50; color: white; }
        .minus { background-color: #f44336; color: white; }
        .add-custom { background-color: #2196F3; color: white; }
        .controls { margin: 20px 0; }
        .hidden { display: none; }
        #cashTotal, #doorCount { font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sister Bar Register</h1>
        <div class="controls">
            <input type="date" id="eventDate">
            <button id="toggleSalesBtn">Open Sales</button>
            <button id="editLayoutBtn">Edit Layout</button>
            <button id="logSaleBtn">Log Sale</button>
            <input type="text" id="noteInput" placeholder="Add a note">
        </div>
        <div id="cashTotal">Cash Total: $0.00</div>
        <div id="doorCount">Thru Door: 0</div>
        <div class="product-grid">
            <div class="product-item" data-item="CASH $5" data-price="5" data-door-count="1">
                <div>CASH $5 (<span class="count">0</span>)</div>
                <div class="button-group">
                    <button class="increment-btn">+</button>
                    <button class="minus">-</button>
                </div>
            </div>
            <div class="product-item" data-item="CASH $10" data-price="10" data-door-count="1">
                <div>CASH $10 (<span class="count">0</span>)</div>
                <div class="button-group">
                    <button class="increment-btn">+</button>
                    <button class="minus">-</button>
                </div>
            </div>
            <div class="product-item" data-item="CC TRANS" data-price="0" data-door-count="1">
                <div>CC TRANS (<span class="count">0</span>)</div>
                <div class="button-group">
                    <button class="increment-btn">+</button>
                    <button class="minus">-</button>
                </div>
            </div>
            <div class="product-item" data-item="TICKET" data-price="0" data-door-count="1">
                <div>TICKET (<span class="count">0</span>)</div>
                <div class="button-group">
                    <button class="increment-btn">+</button>
                    <button class="minus">-</button>
                </div>
            </div>
            <div class="product-item" data-item="COMP" data-price="0" data-door-count="0">
                <div>COMP (<span class="count">0</span>)</div>
                <div class="button-group">
                    <button class="increment-btn">+</button>
                    <button class="minus">-</button>
                </div>
            </div>
            <div class="product-item" data-item="CASH CUSTOM" data-price="0" data-door-count="1">
                <div>CASH CUSTOM (<span class="count">0</span>)</div>
                <div class="button-group">
                    <input type="number" class="custom-cash" placeholder="$" step="0.01" min="0">
                    <button class="add-custom">Add</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyP47ePXyvUOxBPOE0iG2bHsNs5EOa7hlznqZrTiv4f8cjHDTCz3yb9mg-2cqo3lwAk/exec';

        class SalesApp {
            constructor() {
                this.state = {
                    sessionStarted: false,
                    sessionId: null,
                    currentItems: new Map(),
                    cashTotal: 0,
                    doorCount: 0,
                    isEditing: false,
                    activeButtons: new Map(Object.entries(JSON.parse(localStorage.getItem('activeButtons')) || {})),
                    db: null
                };
                this.elements = {
                    transactionButtons: document.querySelectorAll('.product-item'),
                    counts: new Map(),
                    eventDate: document.getElementById('eventDate'),
                    toggleSalesBtn: document.getElementById('toggleSalesBtn'),
                    editLayoutBtn: document.getElementById('editLayoutBtn'),
                    logSaleBtn: document.getElementById('logSaleBtn'),
                    cashTotal: document.getElementById('cashTotal'),
                    doorCount: document.getElementById('doorCount'),
                    noteInput: document.getElementById('noteInput')
                };
                this.elements.eventDate.value = new Date().toISOString().split('T')[0];
                this.initDB().then(() => {
                    this.checkSessionStatus();
                    this.initializeButtonStates();
                    this.bindEvents();
                }).catch(error => this.showError('Database initialization failed: ' + error));
            }

            async initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('SalesDB', 2);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('transactions')) {
                            db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                    request.onsuccess = (event) => {
                        this.state.db = event.target.result;
                        resolve();
                    };
                    request.onerror = (event) => reject(event.target.error);
                });
            }

            bindEvents() {
                this.elements.transactionButtons.forEach(btn => {
                    const incrementBtn = btn.querySelector('.increment-btn');
                    const minusBtn = btn.querySelector('.minus');
                    const customInput = btn.querySelector('.custom-cash');
                    const addCustomBtn = btn.querySelector('.add-custom');
                    if (incrementBtn) incrementBtn.addEventListener('click', () => this.handleIncrement(btn));
                    if (minusBtn) minusBtn.addEventListener('click', () => this.handleDecrement(btn));
                    if (addCustomBtn && customInput) addCustomBtn.addEventListener('click', () => this.handleCustomCash(customInput));
                });
                this.elements.toggleSalesBtn.addEventListener('click', () => this.toggleSales());
                this.elements.editLayoutBtn.addEventListener('click', () => this.toggleEditMode());
                this.elements.logSaleBtn.addEventListener('click', () => this.logSale());
            }

            handleIncrement(btn) {
                const item = btn.dataset.item;
                const price = parseFloat(btn.dataset.price);
                const doorCount = parseInt(btn.dataset.doorCount);
                const count = (this.state.currentItems.get(item) || 0) + 1;
                this.state.currentItems.set(item, count);
                this.state.cashTotal += price;
                this.state.doorCount += doorCount;
                this.updateUI(btn);
            }

            handleDecrement(btn) {
                const item = btn.dataset.item;
                const price = parseFloat(btn.dataset.price);
                const doorCount = parseInt(btn.dataset.doorCount);
                const count = (this.state.currentItems.get(item) || 0) - 1;
                if (count >= 0) {
                    this.state.currentItems.set(item, count);
                    this.state.cashTotal -= price;
                    this.state.doorCount -= doorCount;
                    this.updateUI(btn);
                }
            }

            handleCustomCash(input) {
                const price = parseFloat(input.value) || 0;
                if (price > 0) {
                    const btn = input.closest('.product-item');
                    const item = btn.dataset.item;
                    const count = (this.state.currentItems.get(item) || 0) + 1;
                    this.state.currentItems.set(item, count);
                    this.state.cashTotal += price;
                    this.state.doorCount += 1;
                    this.updateUI(btn);
                    input.value = '';
                }
            }

            updateUI(btn) {
                const item = btn.dataset.item;
                const count = this.state.currentItems.get(item) || 0;
                this.elements.counts.set(item, btn.querySelector('.count'));
                this.elements.counts.get(item).textContent = count;
                this.elements.cashTotal.textContent = `Cash Total: $${this.state.cashTotal.toFixed(2)}`;
                this.elements.doorCount.textContent = `Thru Door: ${this.state.doorCount}`;
            }

            toggleSales() {
                this.state.sessionStarted = !this.state.sessionStarted;
                localStorage.setItem('sessionActive', this.state.sessionStarted);
                if (this.state.sessionStarted) {
                    this.state.sessionId = `${this.elements.eventDate.value}-${Date.now()}`;
                    localStorage.setItem('activeSessionId', this.state.sessionId);
                } else {
                    this.state.currentItems.clear();
                    this.state.cashTotal = 0;
                    this.state.doorCount = 0;
                    this.elements.transactionButtons.forEach(btn => this.updateUI(btn));
                }
                this.checkSessionStatus();
            }

            async logSale() {
                if (!this.state.sessionStarted || this.state.currentItems.size === 0) return;
                const transaction = {
                    sessionId: this.state.sessionId,
                    timestamp: new Date().toISOString(),
                    items: Array.from(this.state.currentItems.entries()).map(([item, count]) => `${item}: ${count}`).join(', '),
                    cashTotal: this.state.cashTotal,
                    doorCount: this.state.doorCount,
                    note: this.elements.noteInput.value
                };
                const tx = this.state.db.transaction(['transactions'], 'readwrite');
                const store = tx.objectStore('transactions');
                store.add(transaction);
                await $.post(APPS_SCRIPT_URL, JSON.stringify(transaction));
                this.state.currentItems.clear();
                this.state.cashTotal = 0;
                this.state.doorCount = 0;
                this.elements.transactionButtons.forEach(btn => this.updateUI(btn));
                this.elements.noteInput.value = '';
            }

            checkSessionStatus() {
                this.state.sessionStarted = localStorage.getItem('sessionActive') === 'true';
                this.state.sessionId = localStorage.getItem('activeSessionId');
                this.elements.toggleSalesBtn.textContent = this.state.sessionStarted ? 'Close Sales' : 'Open Sales';
                this.elements.transactionButtons.forEach(btn => {
                    const incrementBtn = btn.querySelector('.increment-btn');
                    const minusBtn = btn.querySelector('.minus');
                    const addCustomBtn = btn.querySelector('.add-custom');
                    if (incrementBtn) incrementBtn.disabled = !this.state.sessionStarted;
                    if (minusBtn) minusBtn.disabled = !this.state.sessionStarted;
                    if (addCustomBtn) addCustomBtn.disabled = !this.state.sessionStarted;
                });
                if (this.state.sessionStarted) {
                    this.elements.editLayoutBtn.classList.add('hidden');
                } else {
                    this.elements.editLayoutBtn.classList.remove('hidden');
                }
            }

            initializeButtonStates() {
                this.elements.transactionButtons.forEach(btn => this.updateUI(btn));
            }

            toggleEditMode() {
                // Placeholder for edit mode functionality
                this.state.isEditing = !this.state.isEditing;
            }

            showError(message) {
                alert(message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => new SalesApp());
    </script>
</body>
</html>
