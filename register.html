<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sister Bar Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body{font-family:Arial,sans-serif;background:#1e1e1e;color:#e0e0e0;margin:0;padding:10px;font-size:18px;overflow-x:hidden}
        .header{display:flex;justify-content:space-between;align-items:center;background:#2d2d2d;padding:10px;border-radius:8px;margin-bottom:10px;flex-wrap:wrap}
        .header label{margin-right:5px;font-weight:bold}
        .header input{padding:8px;background:#3c3c3c;border:1px solid #555;color:#e0e0e0;border-radius:4px;font-size:1em;width:18%;margin:0 5px}
        .toggle-btn{padding:8px 16px;font-size:1em;border:none;border-radius:4px;cursor:pointer;color:white;width:15%;background:#388e3c}
        .container{max-width:85%;margin:0 auto;background:#2d2d2d;padding:20px;border-radius:8px;min-height:600px}
        .button-container{display:grid;grid-template-columns:repeat(5,1fr);gap:15px;margin-top:20px}
        .product-item{background:#3c3c3c;padding:10px;border-radius:4px;text-align:center}
        .increment-btn{width:100%;height:60px;border:none;border-radius:4px;cursor:pointer;font-size:1.2em;color:white;font-weight:bold;margin-bottom:5px}
        .decrement-btn{width:40px;height:40px;border:none;border-radius:4px;cursor:pointer;font-size:1.5em;color:white;background:#d32f2f}
        .increment-btn.cash{background:#2e7d32}
        .increment-btn.cc{background:#d32f2f}
        .increment-btn.ticket{background:#1a73e8}
        .increment-btn.comp{background:#ffa500}
        .control-row{display:flex;justify-content:center;align-items:center;gap:10px;margin-top:5px}
        .count{font-size:1.5em;width:40px;height:40px;line-height:40px;font-weight:bold;background:#000;color:white;border-radius:50%;text-align:center}
        .totals-container{display:flex;justify-content:space-between;align-items:center;margin:20px 0;background:#3c3c3c;padding:10px;border-radius:4px}
        .cash-total{font-size:2em;font-weight:bold}
        .door-count{font-size:1.5em;font-weight:bold}
        #logSaleBtn{display:block;margin:20px auto;padding:15px 30px;font-size:1.5em;background:#388e3c;color:white;border:none;border-radius:4px;cursor:pointer}
        #noteInput{width:80%;padding:10px;background:#444;border:1px solid #666;color:#e0e0e0;border-radius:4px;font-size:1em}
    </style>
</head>
<body>
    <div class="header">
        <label for="eventDate">Date:</label>
        <input type="date" id="eventDate">
        <label for="eventVenue">Venue:</label>
        <input type="text" id="eventVenue" value="Sister">
        <label for="eventName">Event Name:</label>
        <input type="text" id="eventName" value="Open Mic">
        <label for="cashierName">Cashier Name:</label>
        <input type="text" id="cashierName" value="dddd">
        <button id="toggleSalesBtn" class="toggle-btn">Open Sales</button>
    </div>
    <div class="container">
        <div class="button-container">
            <div class="product-item" data-item="CASH $20" data-price="20">
                <button class="increment-btn cash">CASH $20</button>
                <div class="control-row"><span class="count">0</span><button class="decrement-btn">-</button></div>
            </div>
            <div class="product-item" data-item="CC $20" data-price="20">
                <button class="increment-btn cc">CARD $20</button>
                <div class="control-row"><span class="count">0</span><button class="decrement-btn">-</button></div>
            </div>
            <div class="product-item" data-item="TICKET" data-price="10">
                <button class="increment-btn ticket">TICKET</button>
                <div class="control-row"><span class="count">0</span><button class="decrement-btn">-</button></div>
            </div>
            <div class="product-item" data-item="COMP" data-price="0">
                <button class="increment-btn comp">COMP</button>
                <div class="control-row"><span class="count">0</span><button class="decrement-btn">-</button></div>
            </div>
        </div>
        <div class="totals-container">
            <div class="cash-total">Cash Total: $<span id="cashTotal">0.00</span></div>
            <div class="door-count">Thru Door: <span id="doorCount">0</span></div>
        </div>
        <textarea id="noteInput" placeholder="Add a note..."></textarea>
        <button id="logSaleBtn">Log Sale</button>
    </div>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzdoFgive1pD6OhgFEEZJiiFGZRGeLylu-qI99MhzS-2mLtMQ4uTceyXJU6dnDVv-PV/exec';
        class SalesApp {
            constructor() {
                this.db = null;
                this.sessionStarted = false;
                this.sessionId = null;
                this.currentItems = [];
                this.total = 0;
                this.doorCount = 0;
            }
            init() {
                const request = indexedDB.open('SalesDB', 2);
                request.onupgradeneeded = e => {
                    this.db = e.target.result;
                    if (!this.db.objectStoreNames.contains('sessions')) this.db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
                    if (!this.db.objectStoreNames.contains('transactions')) this.db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true }).createIndex('sessionId', 'sessionId', { unique: false });
                };
                request.onsuccess = e => { this.db = e.target.result; this.bindEvents(); };
                request.onerror = () => alert('Database error');
            }
            bindEvents() {
                $('#toggleSalesBtn').click(() => this.toggleSales());
                $('.increment-btn').click(e => this.incrementItem($(e.target).parent()));
                $('.decrement-btn').click(e => this.decrementItem($(e.target).parent()));
                $('#logSaleBtn').click(() => this.logSale());
            }
            toggleSales() {
                this.sessionStarted = !this.sessionStarted;
                $('#toggleSalesBtn').text(this.sessionStarted ? 'Close Sales' : 'Open Sales').css('background', this.sessionStarted ? '#d32f2f' : '#388e3c');
                if (this.sessionStarted) {
                    this.sessionId = Date.now();
                    const session = { id: this.sessionId, date: $('#eventDate').val(), venue: $('#eventVenue').val(), eventName: $('#eventName').val(), cashier: $('#cashierName').val(), status: 'open' };
                    this.db.transaction(['sessions'], 'readwrite').objectStore('sessions').add(session);
                }
            }
            incrementItem($item) {
                if (!this.sessionStarted) return;
                const item = $item.data('item');
                const price = parseFloat($item.data('price'));
                const $count = $item.find('.count');
                let count = parseInt($count.text()) + 1;
                $count.text(count);
                const existing = this.currentItems.find(i => i.item === item);
                if (existing) existing.quantity = count;
                else this.currentItems.push({ item, price, quantity: count });
                this.updateTotals();
            }
            decrementItem($item) {
                const item = $item.data('item');
                const $count = $item.find('.count');
                let count = parseInt($count.text());
                if (count > 0) {
                    count--;
                    $count.text(count);
                    const existing = this.currentItems.find(i => i.item === item);
                    if (existing) existing.quantity = count;
                    if (count === 0) this.currentItems = this.currentItems.filter(i => i.item !== item);
                    this.updateTotals();
                }
            }
            updateTotals() {
                this.total = this.currentItems.reduce((sum, i) => sum + i.price * i.quantity, 0);
                this.doorCount = this.currentItems.reduce((sum, i) => sum + (i.item === 'TICKET' || i.item === 'COMP' ? i.quantity : 0), 0);
                $('#cashTotal').text(this.total.toFixed(2));
                $('#doorCount').text(this.doorCount);
            }
            logSale() {
                if (!this.sessionStarted || !this.currentItems.length) return;
                const transaction = {
                    sessionId: this.sessionId,
                    timestamp: new Date().toISOString(),
                    time: new Date().toLocaleTimeString(),
                    itemList: this.currentItems.map(item => ({ ...item, type: this.getItemType(item.item) })),
                    total: this.total,
                    note: $('#noteInput').val(),
                    doorCount: this.doorCount
                };
                const tx = this.db.transaction(['transactions'], 'readwrite');
                tx.objectStore('transactions').add(transaction).onsuccess = () => {
                    this.sendToGoogleSheet(transaction);
                    this.resetSale();
                };
            }
            getItemType(itemName) {
                if (itemName.startsWith('CASH')) return 'CASH';
                if (itemName.startsWith('CC')) return 'CARD';
                if (itemName === 'TICKET') return 'Tickets';
                if (itemName === 'COMP') return 'COMP';
                return 'Other';
            }
            sendToGoogleSheet(transaction) {
                const data = {
                    sheet: 'Sister Live Register',
                    rows: transaction.itemList.map(item => [
                        transaction.sessionId,
                        transaction.timestamp,
                        item.type,
                        item.item,
                        item.quantity,
                        item.price,
                        transaction.total,
                        transaction.note
                    ])
                };
                $.post(API_URL, JSON.stringify(data));
            }
            resetSale() {
                this.currentItems = [];
                this.total = 0;
                this.doorCount = 0;
                $('.count').text('0');
                $('#cashTotal').text('0.00');
                $('#doorCount').text('0');
                $('#noteInput').val('');
            }
        }
        const app = new SalesApp();
        app.init();
    </script>
</body>
</html>
