<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .product-item { margin: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="my-4">Register</h1>
        <div id="salesClosed" class="alert alert-warning">
            Sales are closed. Please enter cashier name to open sales:
            <input type="text" id="cashierName" class="form-control my-2" placeholder="Cashier Name">
            <button id="openSalesBtn" class="btn btn-primary">Open Sales</button>
        </div>
        <div id="salesOpen" style="display: none;">
            <h2>Cashier: <span id="currentCashier"></span></h2>
            <div class="row">
                <div class="col-md-6">
                    <div class="product-item" data-item="CASH $20">
                        <button class="btn btn-success btn-lg w-100">CASH $20</button>
                    </div>
                    <div class="product-item" data-item="CASH $15">
                        <button class="btn btn-success btn-lg w-100">CASH $15</button>
                    </div>
                    <div class="product-item" data-item="CASH $12">
                        <button class="btn btn-success btn-lg w-100">CASH $12</button>
                    </div>
                    <div class="product-item" data-item="CASH $10">
                        <button class="btn btn-success btn-lg w-100">CASH $10</button>
                    </div>
                    <div class="product-item" data-item="CC TRANS">
                        <button class="btn btn-primary btn-lg w-100">CC TRANS</button>
                    </div>
                    <div class="product-item" data-item="TICKET">
                        <button class="btn btn-info btn-lg w-100">TICKET</button>
                    </div>
                    <div class="product-item" data-item="COMP">
                        <button class="btn btn-warning btn-lg w-100">COMP</button>
                    </div>
                    <div class="product-item" data-item="CASH (CUSTOM)">
                        <input type="number" class="form-control d-inline-block w-50" id="customCash" placeholder="Custom Cash">
                        <button class="btn btn-success w-25">Add</button>
                    </div>
                </div>
                <div class="col-md-6">
                    <h3>Current Sale</h3>
                    <ul id="currentSale" class="list-group"></ul>
                    <p>Total: $<span id="totalAmount">0</span></p>
                    <button id="logSaleBtn" class="btn btn-primary mt-2">Log Sale</button>
                    <button id="closeSalesBtn" class="btn btn-danger mt-2">Close Sales</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class SalesApp {
            constructor() {
                this.db = null;
                this.currentSessionId = null;
                this.total = 0;
                this.currentSaleItems = [];
            }

            init() {
                const request = indexedDB.open('SalesDB', 2); // Version 2 for new stores
                request.onupgradeneeded = (event) => {
                    this.db = event.target.result;
                    if (!this.db.objectStoreNames.contains('sessions')) {
                        this.db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!this.db.objectStoreNames.contains('transactions')) {
                        const transactionStore = this.db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        transactionStore.createIndex('sessionId', 'sessionId', { unique: false });
                    }
                    if (!this.db.objectStoreNames.contains('permissions')) {
                        this.db.createObjectStore('permissions', { keyPath: 'username' });
                    }
                    if (!this.db.objectStoreNames.contains('buttonVisibility')) {
                        this.db.createObjectStore('buttonVisibility', { keyPath: 'item' });
                    }
                };

                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    this.checkSessionStatus();
                    this.applyButtonVisibility();
                };

                request.onerror = () => alert('Failed to open database.');
            }

            applyButtonVisibility() {
                const tx = this.db.transaction(['buttonVisibility'], 'readonly');
                const store = tx.objectStore('buttonVisibility');
                const request = store.getAll();
                request.onsuccess = (event) => {
                    const visibilityMap = {};
                    event.target.result.forEach(entry => {
                        visibilityMap[entry.item] = entry.visible;
                    });
                    $('.product-item').each(function() {
                        const item = $(this).data('item');
                        if (visibilityMap[item] === false) {
                            $(this).addClass('hidden');
                        } else {
                            $(this).removeClass('hidden');
                        }
                    });
                };
            }

            checkSessionStatus() {
                const tx = this.db.transaction('sessions', 'readonly');
                const store = tx.objectStore('sessions');
                const request = store.getAll();
                request.onsuccess = (event) => {
                    const sessions = event.target.result;
                    const openSession = sessions.find(s => !s.endTime);
                    if (openSession) {
                        this.currentSessionId = openSession.id;
                        $('#currentCashier').text(openSession.cashier);
                        $('#salesClosed').hide();
                        $('#salesOpen').show();
                        this.bindEvents();
                    } else {
                        $('#salesClosed').show();
                        $('#salesOpen').hide();
                        $('#openSalesBtn').on('click', () => this.openSales());
                    }
                };
            }

            openSales() {
                const cashier = $('#cashierName').val().trim();
                if (!cashier) {
                    alert('Please enter a cashier name.');
                    return;
                }
                const tx = this.db.transaction('sessions', 'readwrite');
                const store = tx.objectStore('sessions');
                const session = { cashier: cashier, startTime: new Date().toISOString() };
                const request = store.add(session);
                request.onsuccess = (event) => {
                    this.currentSessionId = event.target.result;
                    $('#currentCashier').text(cashier);
                    $('#salesClosed').hide();
                    $('#salesOpen').show();
                    this.bindEvents();
                };
            }

            bindEvents() {
                $('.product-item button').off('click').on('click', (e) => {
                    const $item = $(e.target).closest('.product-item');
                    const item = $item.data('item');
                    let amount = 0;
                    if (item === 'CASH (CUSTOM)') {
                        amount = parseFloat($('#customCash').val()) || 0;
                    } else if (item.startsWith('CASH $')) {
                        amount = parseFloat(item.replace('CASH $', ''));
                    }
                    this.addToSale(item, amount);
                });

                $('#logSaleBtn').off('click').on('click', () => this.logSale());
                $('#closeSalesBtn').off('click').on('click', () => this.closeSales());
            }

            addToSale(item, amount) {
                this.currentSaleItems.push({ item, amount });
                this.total += amount;
                this.updateCurrentSale();
            }

            updateCurrentSale() {
                const $list = $('#currentSale').empty();
                this.currentSaleItems.forEach(item => {
                    $list.append(`<li class="list-group-item">${item.item}: $${item.amount.toFixed(2)}</li>`);
                });
                $('#totalAmount').text(this.total.toFixed(2));
            }

            logSale() {
                if (this.currentSaleItems.length === 0) {
                    alert('No items to log.');
                    return;
                }
                const tx = this.db.transaction('transactions', 'readwrite');
                const store = tx.objectStore('transactions');
                const transaction = {
                    sessionId: this.currentSessionId,
                    items: this.currentSaleItems,
                    total: this.total,
                    timestamp: new Date().toISOString()
                };
                store.add(transaction).onsuccess = () => {
                    this.currentSaleItems = [];
                    this.total = 0;
                    this.updateCurrentSale();
                };
            }

            closeSales() {
                const tx = this.db.transaction('sessions', 'readwrite');
                const store = tx.objectStore('sessions');
                const request = store.get(this.currentSessionId);
                request.onsuccess = (event) => {
                    const session = event.target.result;
                    session.endTime = new Date().toISOString();
                    store.put(session).onsuccess = () => {
                        this.currentSessionId = null;
                        $('#salesOpen').hide();
                        $('#salesClosed').show();
                    };
                };
            }
        }

        $(document).ready(() => {
            const app = new SalesApp();
            app.init();
        });
    </script>
</body>
</html>
