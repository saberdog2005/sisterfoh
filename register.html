<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: #e0e0e0;
            font-size: 18px;
        }
        .container {
            background: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            max-width: 600px;
            margin: 0 auto;
        }
        h1, h2 {
            margin-top: 0;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        input, select {
            padding: 8px;
            margin: 5px;
            background: #34495e;
            color: #e0e0e0;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
        }
        .cart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .cart-item {
            background: #2c3e50;
            padding: 10px;
            border-radius: 5px;
        }
        #doorCount {
            color: #800080; /* Purple for "thru door" */
            font-weight: bold;
        }
        #cartTotal {
            font-size: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sales Register</h1>
        <div>
            <label>Date: <input type="date" id="sessionDate"></label>
            <label>Venue: <input type="text" id="sessionVenue" placeholder="Venue"></label>
            <label>Event: <input type="text" id="sessionEvent" placeholder="Event"></label>
            <label>Cashier: <input type="text" id="sessionCashier" placeholder="Cashier"></label>
            <button id="startSessionBtn">Start Session</button>
            <button id="endSessionBtn" style="background: #e74c3c; display: none;">End Session</button>
        </div>
        <h2>Cart</h2>
        <div id="cartItems" class="cart-grid"></div>
        <div>
            <select id="itemSelect">
                <option value="">Select Item</option>
                <option value="Ticket ($10)">Ticket ($10)</option>
                <option value="Comp ($0)">Comp ($0)</option>
            </select>
            <input type="number" id="itemQuantity" min="1" value="1" style="width: 60px;">
            <button id="addItemBtn">Add to Cart</button>
        </div>
        <div>
            Total: $<span id="cartTotal">0.00</span>
            <br>
            Thru Door: <span id="doorCount">0</span>
            <br>
            <button id="incrementDoor">+1 Thru Door</button>
            <button id="decrementDoor">-1 Thru Door</button>
        </div>
        <div>
            <button id="cashBtn">Cash</button>
            <button id="cardBtn">Card</button>
            <button id="clearCartBtn" style="background: #e74c3c;">Clear Cart</button>
        </div>
    </div>
    <script>
        const SPREADSHEET_ID = '1dJ0NuByJCDgnIRKhsmKrWFyBtCHRgR7ujfGDRb9jhMY';
        const CLIENT_ID = '251850742586-mqcsongr4qc28peshpejmhd5iuiak835.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAS_wlduCCcRSDA3Hjt3hMPRg3olegY2Ic';
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

        class SalesApp {
            constructor() {
                this.cart = [];
                this.sessionId = '';
                this.doorCount = parseInt(localStorage.getItem('doorCount') || '0');
                this.updateDisplay();
            }

            startSession(date, venue, event, cashier) {
                this.sessionId = `${date}_${venue}_${event}_${cashier}`;
                localStorage.setItem('sessionId', this.sessionId);
                gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A1',
                    valueInputOption: 'RAW',
                    resource: { values: [['SALES OPEN', this.sessionId, new Date().toISOString()]] }
                }).then(() => {
                    $('#startSessionBtn').hide();
                    $('#endSessionBtn').show();
                });
            }

            endSession() {
                gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A1',
                    valueInputOption: 'RAW',
                    resource: { values: [['CLOSED', this.sessionId, new Date().toISOString()]] }
                }).then(() => {
                    localStorage.removeItem('sessionId');
                    localStorage.setItem('doorCount', '0');
                    this.sessionId = '';
                    this.doorCount = 0;
                    this.cart = [];
                    this.updateDisplay();
                    $('#startSessionBtn').show();
                    $('#endSessionBtn').hide();
                });
            }

            addItem(item, price, quantity, type) {
                this.cart.push({ item, price, quantity, type });
                this.updateDisplay();
            }

            clearCart() {
                this.cart = [];
                this.updateDisplay();
            }

            incrementDoorCount() {
                this.doorCount++;
                localStorage.setItem('doorCount', this.doorCount);
                this.updateDisplay();
            }

            decrementDoorCount() {
                if (this.doorCount > 0) {
                    this.doorCount--;
                    localStorage.setItem('doorCount', this.doorCount);
                    this.updateDisplay();
                }
            }

            processSale(paymentType) {
                if (!this.cart.length || !this.sessionId) return;
                const total = this.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const itemsJson = JSON.stringify(this.cart);
                const timestamp = new Date().toISOString();
                const note = paymentType === 'cash' ? 'Cash Payment' : 'Card Payment';
                gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['TRANSACTION', this.sessionId, timestamp, timestamp.slice(11, 19), itemsJson, total.toFixed(2), note, this.doorCount]]
                    }
                }).then(() => this.clearCart());
            }

            updateDisplay() {
                const total = this.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
                $('#cartTotal').text(total.toFixed(2));
                $('#doorCount').text(this.doorCount);
                const cartItems = $('#cartItems').empty();
                this.cart.forEach((item, index) => {
                    cartItems.append(`<div class="cart-item">${item.item} x${item.quantity} = $${(item.price * item.quantity).toFixed(2)}</div>`);
                });
            }
        }

        const app = new SalesApp();

        function handleClientLoad() {
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS
                }).then(() => {
                    if (localStorage.getItem('sessionId')) {
                        app.sessionId = localStorage.getItem('sessionId');
                        $('#startSessionBtn').hide();
                        $('#endSessionBtn').show();
                    }
                });
            });
        }

        $(document).ready(() => {
            handleClientLoad();
            $('#startSessionBtn').on('click', () => {
                const date = $('#sessionDate').val();
                const venue = $('#sessionVenue').val().trim();
                const event = $('#sessionEvent').val().trim();
                const cashier = $('#sessionCashier').val().trim();
                if (date && venue && event && cashier) app.startSession(date, venue, event, cashier);
            });
            $('#endSessionBtn').on('click', () => app.endSession());
            $('#addItemBtn').on('click', () => {
                const itemText = $('#itemSelect').val();
                const quantity = parseInt($('#itemQuantity').val());
                if (itemText && quantity > 0) {
                    const price = itemText.includes('Ticket') ? 10 : 0;
                    const type = itemText.includes('Ticket') ? 'ticket' : 'comp';
                    app.addItem(itemText, price, quantity, type);
                }
            });
            $('#cashBtn').on('click', () => app.processSale('cash'));
            $('#cardBtn').on('click', () => app.processSale('card'));
            $('#clearCartBtn').on('click', () => app.clearCart());
            $('#incrementDoor').on('click', () => app.incrementDoorCount());
            $('#decrementDoor').on('click', () => app.decrementDoorCount());
        });
    </script>
</body>
</html>
