<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        .container { max-width: 800px; margin: 20px auto; font-family: Arial, sans-serif; }
        .header { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .transaction-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .transaction-grid button { padding: 15px; font-size: 16px; cursor: pointer; }
        .custom-cash { margin-bottom: 20px; }
        .custom-cash input { padding: 5px; width: 100px; }
        .custom-cash button { padding: 5px 10px; }
        .summary { margin-bottom: 20px; }
        .note-section textarea { width: 100%; height: 50px; margin-bottom: 10px; }
        .closed { background-color: #ff4444; color: white; }
        .inactive { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <label>Date: <input type="date" id="sessionDate"></label>
            <label>Venue: <input type="text" id="sessionVenue" placeholder="Venue"></label>
            <label>Event: <input type="text" id="sessionEvent" placeholder="Event"></label>
            <label>Cashier: <input type="text" id="sessionCashier" placeholder="Cashier"></label>
            <button id="toggleSalesBtn">Open Sales</button>
            <button id="editLayoutBtn">Edit Layout</button>
        </div>
        <div class="transaction-grid" id="transactionGrid">
            <button class="cash-btn" data-type="cash" data-amount="20">$20</button>
            <button class="cash-btn" data-type="cash" data-amount="15">$15</button>
            <button class="cash-btn" data-type="cash" data-amount="12">$12</button>
            <button class="cash-btn" data-type="cash" data-amount="10">$10</button>
            <button class="cash-btn" data-type="cash" data-amount="7">$7</button>
            <button class="cash-btn" data-type="cash" data-amount="5">$5</button>
            <button class="cc-btn" data-type="card" data-amount="0">CC TRANS</button>
            <button class="ticket-btn" data-type="ticket" data-amount="0">TICKET</button>
            <button class="comp-btn" data-type="comp" data-amount="0">COMP</button>
        </div>
        <div class="custom-cash">
            <input type="number" id="customCashInput" placeholder="Custom Amount">
            <button id="addCustomCashBtn">Add</button>
        </div>
        <div class="summary">
            <div>Cash Total: $<span id="cashTotal">0.00</span></div>
            <div>Thru Door: <span id="doorCount">0</span></div>
        </div>
        <div class="note-section">
            <textarea id="noteInput" placeholder="Add a note..."></textarea>
            <button id="logSaleBtn">Log Sale</button>
        </div>
    </div>
    <script>
        const SPREADSHEET_ID = '1dJ0NuByJCDgnIRKhsmKrWFyBtCHRgR7ujfGDRb9jhMY';
        const CLIENT_ID = '251850742586-mqcsongr4qc28peshpejmhd5iuiak835.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyAS_wlduCCcRSDA3Hjt3hMPRg3olegY2Ic';
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

        class SalesApp {
            constructor() {
                this.cart = [];
                this.sessionId = localStorage.getItem('sessionId') || '';
                this.doorCount = parseInt(localStorage.getItem('doorCount') || '0');
                this.cashTotal = 0;
                this.isEditing = false;
                this.activeButtons = JSON.parse(localStorage.getItem('activeButtons')) || {};
                this.transactionButtons = $('#transactionGrid button');

                // Initialize button states
                this.transactionButtons.each((_, btn) => {
                    const key = $(btn).data('type') + $(btn).data('amount');
                    if (!(key in this.activeButtons)) this.activeButtons[key] = true;
                    if (!this.activeButtons[key]) $(btn).addClass('inactive');
                });

                this.updateDisplay();
                if (this.sessionId) {
                    $('#toggleSalesBtn').text('Close Sales').addClass('closed');
                }
            }

            toggleEditMode() {
                if (this.isEditing) {
                    // Save layout
                    this.transactionButtons.each((_, btn) => {
                        const key = $(btn).data('type') + $(btn).data('amount');
                        this.activeButtons[key] = !$(btn).hasClass('inactive');
                    });
                    localStorage.setItem('activeButtons', JSON.stringify(this.activeButtons));
                    this.isEditing = false;
                    $('#editLayoutBtn').text('Edit Layout');
                    // Apply saved states
                    this.transactionButtons.each((_, btn) => {
                        const key = $(btn).data('type') + $(btn).data('amount');
                        $(btn).toggleClass('inactive', !this.activeButtons[key]);
                    });
                } else {
                    this.isEditing = true;
                    $('#editLayoutBtn').text('Save Layout');
                }
            }

            startSession(date, venue, event, cashier) {
                this.sessionId = `${date}_${venue}_${event}_${cashier}`;
                localStorage.setItem('sessionId', this.sessionId);
                gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A1',
                    valueInputOption: 'RAW',
                    resource: { values: [['SALES OPEN', this.sessionId, new Date().toISOString()]] }
                }).then(() => {
                    $('#toggleSalesBtn').text('Close Sales').addClass('closed');
                }).catch(err => alert('Error starting session: ' + err.message));
            }

            endSession() {
                gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A1',
                    valueInputOption: 'RAW',
                    resource: { values: [['CLOSED', this.sessionId, new Date().toISOString()]] }
                }).then(() => {
                    localStorage.removeItem('sessionId');
                    localStorage.setItem('doorCount', '0');
                    this.sessionId = '';
                    this.doorCount = 0;
                    this.cart = [];
                    this.cashTotal = 0;
                    this.updateDisplay();
                    $('#toggleSalesBtn').text('Open Sales').removeClass('closed');
                }).catch(err => alert('Error closing session: ' + err.message));
            }

            addTransaction(type, amount) {
                if (!this.sessionId) {
                    alert('Please open a sales session first.');
                    return;
                }
                this.cart.push({ type, amount });
                if (type === 'cash') this.cashTotal += amount;
                this.doorCount++;
                this.updateDisplay();
            }

            addCustomCashTransaction(amount) {
                this.addTransaction('cash', amount);
            }

            logSale() {
                if (!this.cart.length || !this.sessionId) {
                    alert('No transactions to log or session not started.');
                    return;
                }
                const timestamp = new Date().toISOString();
                const note = $('#noteInput').val().trim();
                const itemsJson = JSON.stringify(this.cart);
                gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A1',
                    valueInputOption: 'RAW',
                    resource: {
                        values: [['TRANSACTION', this.sessionId, timestamp, timestamp.slice(11, 19), itemsJson, this.cashTotal.toFixed(2), note, this.doorCount]]
                    }
                }).then(() => {
                    this.cart = [];
                    this.cashTotal = 0;
                    $('#noteInput').val('');
                    this.updateDisplay();
                }).catch(err => alert('Error logging sale: ' + err.message));
            }

            updateDisplay() {
                $('#cashTotal').text(this.cashTotal.toFixed(2));
                $('#doorCount').text(this.doorCount);
                localStorage.setItem('doorCount', this.doorCount);
            }
        }

        const app = new SalesApp();

        function handleClientLoad() {
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS
                }).then(() => console.log('Google API initialized')).catch(err => alert('API init failed: ' + err.message));
            });
        }

        $(document).ready(() => {
            handleClientLoad();

            $('#editLayoutBtn').on('click', () => app.toggleEditMode());

            app.transactionButtons.on('click', function() {
                if (app.isEditing) {
                    $(this).toggleClass('inactive');
                } else if (!$(this).hasClass('inactive')) {
                    const type = $(this).data('type');
                    const amount = parseFloat($(this).data('amount'));
                    app.addTransaction(type, amount);
                }
            });

            $('#addCustomCashBtn').on('click', () => {
                const amount = parseFloat($('#customCashInput').val());
                if (!isNaN(amount) && amount > 0) {
                    app.addCustomCashTransaction(amount);
                    $('#customCashInput').val('');
                }
            });

            $('#logSaleBtn').on('click', () => app.logSale());

            $('#toggleSalesBtn').on('click', () => {
                if (app.sessionId) {
                    app.endSession();
                } else {
                    const date = $('#sessionDate').val();
                    const venue = $('#sessionVenue').val().trim();
                    const event = $('#sessionEvent').val().trim();
                    const cashier = $('#sessionCashier').val().trim();
                    if (date && venue && event && cashier) {
                        app.startSession(date, venue, event, cashier);
                    } else {
                        alert('Please fill all session fields.');
                    }
                }
            });
        });
    </script>
</body>
</html>
