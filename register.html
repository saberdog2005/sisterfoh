<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sister Bar Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { background: #1c2526; color: #e0e0e0; font-family: Arial, sans-serif; margin: 0; padding: 10px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #2c3e50; padding: 10px; border-radius: 5px; }
        #sessionInfo label { margin-right: 5px; }
        #sessionInfo input { margin-right: 15px; background: #34495e; color: #e0e0e0; border: 1px solid #e0e0e0; padding: 5px; }
        .toggle-section { display: flex; align-items: center; }
        .toggle-btn { background: #3498db; color: white; border: none; padding: 8px 15px; cursor: pointer; border-radius: 5px; }
        .toggle-btn.active { background: #e74c3c; }
        #adminControls { margin: 10px 0; }
        #adminControls button { background: #3498db; color: white; border: none; padding: 8px 15px; margin-right: 10px; cursor: pointer; }
        #confirmLayoutBtn { display: none; background: #2ecc71; }
        .container { display: flex; flex-direction: column; gap: 15px; }
        .button-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
        .item-btn { background: #34495e; color: #e0e0e0; border: 1px solid #e0e0e0; padding: 15px; cursor: pointer; text-align: center; border-radius: 5px; }
        .item-btn.active { background: #3498db; }
        .totals-container { display: flex; justify-content: space-between; background: #2c3e50; padding: 10px; border-radius: 5px; }
        .cash-total, .door-count { font-size: 1.2em; }
        .note-section textarea { width: 100%; height: 50px; background: #34495e; color: #e0e0e0; border: 1px solid #e0e0e0; padding: 5px; }
        #logSaleBtn { background: #2ecc71; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 5px; }
        #logSaleBtn:disabled { background: #7f8c8d; cursor: not-allowed; }
        .message { color: #2ecc71; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <div id="sessionInfo">
            <label>Date:</label><input type="date" id="eventDate">
            <label>Venue:</label><input type="text" id="eventVenue" value="Sister">
            <label>Event:</label><input type="text" id="eventName" value="Open Mic">
        </div>
        <div class="toggle-section">
            <label>Cashier:</label><input type="text" id="cashierName" value="Default">
            <button id="toggleSalesBtn" class="toggle-btn">Open Sales</button>
        </div>
    </div>
    <div id="adminControls">
        <button id="editLayoutBtn">Edit Layout</button>
        <button id="confirmLayoutBtn">Confirm Layout</button>
    </div>
    <div class="container">
        <div class="button-container" id="buttonContainer"></div>
        <div class="totals-container">
            <div class="cash-total">Cash Total: $<span id="cashTotal">0.00</span></div>
            <div class="door-count">Thru Door: <span id="doorCount">0</span></div>
        </div>
        <div class="note-section">
            <textarea id="noteInput" placeholder="Add a note..."></textarea>
        </div>
        <button id="logSaleBtn" disabled>Log Sale</button>
        <div id="message" class="message"></div>
    </div>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzdoFgive1pD6OhgFEEZJiiFGZRGeLylu-qI99MhzS-2mLtMQ4uTceyXJU6dnDVv-PV/exec'; // Replace with your deployed script URL

        const itemConfig = {
            'CASH $20': { price: 20, class: 'item-cash' },
            'CASH $15': { price: 15, class: 'item-cash' },
            'CASH $10': { price: 10, class: 'item-cash' },
            'CASH $5': { price: 5, class: 'item-cash' },
            'CASH (CUSTOM)': { price: 0, class: 'item-cash' },
            'CC TRANS': { price: 0, class: 'item-card' },
            'TICKET': { price: 10, class: 'item-tickets' },
            'COMP': { price: 0, class: 'item-comp' }
        };

        let salesOpen = false;
        let items = {};
        let cashTotal = 0;
        let doorCount = 0;

        $(document).ready(() => {
            loadButtons();
            $('#eventDate').val(new Date().toISOString().split('T')[0]);
            $('#toggleSalesBtn').on('click', toggleSales);
            $('#logSaleBtn').on('click', logSale);
            $('#editLayoutBtn').on('click', () => {
                Sortable.create(document.getElementById('buttonContainer'), { animation: 150 });
                $('#editLayoutBtn').hide();
                $('#confirmLayoutBtn').show();
            });
            $('#confirmLayoutBtn').on('click', () => {
                $('#editLayoutBtn').show();
                $('#confirmLayoutBtn').hide();
                Sortable.get(document.getElementById('buttonContainer')).destroy();
            });
        });

        function loadButtons() {
            const container = $('#buttonContainer');
            Object.keys(itemConfig).forEach(item => {
                const btn = $('<button>').addClass('item-btn').text(item).data('item', item);
                btn.on('click', () => increment(item));
                container.append(btn);
            });
        }

        function toggleSales() {
            salesOpen = !salesOpen;
            $('#toggleSalesBtn').text(salesOpen ? 'Close Sales' : 'Open Sales').toggleClass('active');
            if (salesOpen) {
                const sessionId = `${$('#eventDate').val()}-${$('#eventVenue').val()}-${$('#eventName').val()}`.replace(/[^a-zA-Z0-9-]/g, '');
                $.post(WEB_APP_URL, JSON.stringify({
                    type: 'TITLE',
                    data: ['TITLE', sessionId, new Date().toISOString(), $('#cashierName').val()]
                }));
            }
        }

        function increment(item) {
            if (!salesOpen) return;
            const config = itemConfig[item];
            let price = config.price;
            if (item === 'CASH (CUSTOM)' || item === 'CC TRANS') {
                price = parseFloat(prompt('Enter amount:') || 0);
                if (isNaN(price) || price < 0) return;
            }
            items[item] = (items[item] || 0) + 1;
            if (price > 0) cashTotal += price;
            doorCount++; // Increment door count for any button press
            updateDisplay();
        }

        function updateDisplay() {
            $('#cashTotal').text(cashTotal.toFixed(2));
            $('#doorCount').text(doorCount);
            $('#logSaleBtn').prop('disabled', Object.keys(items).length === 0);
            $('.item-btn').each(function() {
                const item = $(this).data('item');
                $(this).toggleClass('active', items[item] > 0).text(`${item}${items[item] ? ` (${items[item]})` : ''}`);
            });
        }

        function logSale() {
            if (!salesOpen || Object.keys(items).length === 0) return;
            const sessionId = `${$('#eventDate').val()}-${$('#eventVenue').val()}-${$('#eventName').val()}`.replace(/[^a-zA-Z0-9-]/g, '');
            const itemList = Object.entries(items).map(([item, qty]) => ({
                name: item,
                quantity: qty,
                price: itemConfig[item].price,
                type: itemConfig[item].class.replace('item-', '')
            }));
            const note = $('#noteInput').val().trim();
            $.post(WEB_APP_URL, JSON.stringify({
                type: 'TRANSACTION',
                sessionId: sessionId,
                timestamp: new Date().toISOString(),
                time: new Date().toLocaleTimeString(),
                itemList: itemList,
                total: cashTotal,
                note: note,
                doorCount: doorCount
            }), () => {
                $('#message').text('Sale logged successfully!').fadeIn().delay(2000).fadeOut();
                resetSale();
            }).fail(() => alert('Error logging sale'));
        }

        function resetSale() {
            items = {};
            cashTotal = 0;
            doorCount = 0;
            $('#noteInput').val('');
            updateDisplay();
        }
    </script>
</body>
</html>
