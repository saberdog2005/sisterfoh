<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sister Bar Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style> 
        body { font-family: Arial, sans-serif; background: #1e1e1e; color: #e0e0e0; margin: 0; padding: 10px; font-size: 18px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #2d2d2d; padding: 10px; border-radius: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        #sessionInfo { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .toggle-section { display: flex; align-items: center; gap: 10px; }
        .toggle-btn { padding: 8px 16px; font-size: 1em; border: none; border-radius: 4px; cursor: pointer; color: white; width: 150px; background: #388e3c; }
        .container { max-width: 85%; margin: 0 auto; background: #2d2d2d; padding: 20px; border-radius: 8px; min-height: 600px; }
        input[readonly] { background: #424242; color: #a0a0a0; }
        label { margin-right: 5px; }
        .message { color: #ff6b6b; margin-top: 10px; }
    </style>
</head>
<body>
    <div class="header">
        <div id="sessionInfo">
            <label for="eventDate">Date:</label><input type="date" id="eventDate">
            <label for="eventVenue">Venue:</label><input type="text" id="eventVenue" value="Sister">
            <label for="eventName">Event Name:</label><input type="text" id="eventName" value="Open Mic">
        </div>
        <div class="toggle-section">
            <label for="cashierName">Cashier Name:</label><input type="text" id="cashierName" value="Default">
            <button id="toggleSalesBtn" class="toggle-btn">Open Sales</button>
        </div>
    </div>
    <div class="container">
        <button id="logSaleBtn" disabled>Log Sample Sale</button>
        <p>Session Total: $<span id="sessionTotalDisplay">0.00</span></p>
        <div id="message" class="message"></div>
    </div>
    <script>
        class SalesApp {
            constructor() {
                this.sessionOpen = false;
                this.sessionId = null;
                this.sessionTotal = 0;
                this.WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzdoFgive1pD6OhgFEEZJiiFGZRGeLylu-qI99MhzS-2mLtMQ4uTceyXJU6dnDVv-PV/exec'; // Replace with your Apps Script URL
            }

            init() {
                this.checkSessionStatus();
                $('#toggleSalesBtn').on('click', () => this.toggleSales());
                $('#logSaleBtn').on('click', () => this.logSampleSale());
            }

            checkSessionStatus() {
                const sessionId = localStorage.getItem('activeSessionId');
                if (sessionId) {
                    this.sessionOpen = true;
                    this.sessionId = sessionId;
                    this.sessionTotal = parseFloat(localStorage.getItem('sessionTotal') || '0');
                    this.updateUIForOpenSession();
                } else {
                    this.updateUIForClosedSession();
                }
                this.updateTotalDisplay();
            }

            updateUIForOpenSession() {
                $('#eventDate, #eventVenue, #eventName, #cashierName').prop('readonly', true);
                $('#toggleSalesBtn').text('Close Sales').css('background', '#d32f2f');
                $('#logSaleBtn').prop('disabled', false);
            }

            updateUIForClosedSession() {
                $('#eventDate, #eventVenue, #eventName, #cashierName').prop('readonly', false);
                $('#toggleSalesBtn').text('Open Sales').css('background', '#388e3c');
                $('#logSaleBtn').prop('disabled', true);
            }

            updateTotalDisplay() {
                $('#sessionTotalDisplay').text(this.sessionTotal.toFixed(2));
            }

            showMessage(msg) {
                $('#message').text(msg);
                setTimeout(() => $('#message').text(''), 3000);
            }

            async toggleSales() {
                if (!this.sessionOpen) {
                    const date = $('#eventDate').val();
                    const venue = $('#eventVenue').val();
                    const eventName = $('#eventName').val();
                    const cashier = $('#cashierName').val();
                    if (!date || !venue || !eventName || !cashier) {
                        this.showMessage('Please fill in all fields');
                        return;
                    }
                    this.sessionId = Date.now().toString();
                    localStorage.setItem('activeSessionId', this.sessionId);
                    localStorage.setItem('sessionTotal', '0');
                    this.sessionTotal = 0;
                    this.sessionOpen = true;
                    await this.sendSessionStart(date, venue, eventName, cashier);
                    this.updateUIForOpenSession();
                    this.showMessage('Session started successfully');
                } else {
                    const pin = prompt('Enter PIN to close sales (default: 1234)');
                    if (pin === '1234') {
                        await this.sendSessionClose();
                        localStorage.removeItem('activeSessionId');
                        localStorage.removeItem('sessionTotal');
                        this.sessionOpen = false;
                        this.sessionId = null;
                        this.sessionTotal = 0;
                        this.updateUIForClosedSession();
                        this.showMessage('Session closed successfully');
                    } else {
                        this.showMessage('Incorrect PIN');
                    }
                }
            }

            async sendSessionStart(date, venue, eventName, cashier) {
                const data = { type: 'SESSION_START', sessionId: this.sessionId, date, venue, eventName, cashier };
                await this.sendPostRequest(data);
            }

            async logSampleSale() {
                if (!this.sessionOpen) {
                    this.showMessage('Please open a session first');
                    return;
                }
                const itemList = [
                    { item: 'Coffee', price: 3.50, quantity: 1 },
                    { item: 'Pastry', price: 2.50, quantity: 1 }
                ];
                const total = itemList.reduce((sum, item) => sum + item.price * item.quantity, 0);
                const doorCount = itemList.length; // Simplified for sample
                const note = 'Sample sale';
                await this.sendTransaction(itemList, total, note, doorCount);
                this.sessionTotal += total;
                localStorage.setItem('sessionTotal', this.sessionTotal.toString());
                this.updateTotalDisplay();
            }

            async sendTransaction(itemList, total, note, doorCount) {
                const timestamp = new Date().toISOString();
                const time = new Date().toLocaleTimeString();
                const data = { type: 'TRANSACTION', sessionId: this.sessionId, timestamp, time, itemList, total, note, doorCount };
                await this.sendPostRequest(data);
            }

            async sendSessionClose() {
                const data = { type: 'SESSION_CLOSE', sessionId: this.sessionId, grandTotal: this.sessionTotal };
                await this.sendPostRequest(data);
            }

            async sendPostRequest(data) {
                try {
                    const response = await fetch(this.WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) throw new Error('Network response was not ok');
                    console.log('Data sent successfully:', data.type);
                } catch (error) {
                    console.error('Error sending data:', error);
                    this.showMessage('Failed to send data. Retry or check connection.');
                }
            }
        }

        const app = new SalesApp();
        $(document).ready(() => app.init());
    </script>
</body>
</html>
