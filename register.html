<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sister Bar Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1e1e1e;
            color: #e0e0e0;
            margin: 0;
            padding: 10px;
            font-size: 18px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2d2d2d;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        #sessionInfo {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
        }
        .toggle-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .toggle-btn {
            padding: 8px 16px;
            font-size: 1em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            width: 150px;
            background: #388e3c;
        }
        .container {
            max-width: 85%;
            margin: 0 auto;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            min-height: 600px;
        }
        .button-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        .product-btn {
            padding: 15px;
            font-size: 1.2em;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
        }
        .cash-btn { background: #2e7d32; }
        .card-btn { background: #d32f2f; }
        .ticket-btn { background: #1a73e8; }
        .comp-btn { background: #ffa500; }
        .custom-input {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .custom-input input {
            padding: 8px;
            font-size: 1em;
            width: 100px;
        }
        .message {
            color: #ff6b6b;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div id="sessionInfo">
            <label for="eventDate">Date:</label><input type="date" id="eventDate">
            <label for="eventVenue">Venue:</label><input type="text" id="eventVenue" value="Sister">
            <label for="eventName">Event Name:</label><input type="text" id="eventName" value="Open Mic">
        </div>
        <div class="toggle-section">
            <label for="cashierName">Cashier Name:</label><input type="text" id="cashierName" value="Default">
            <button id="toggleSalesBtn" class="toggle-btn">Open Sales</button>
        </div>
    </div>
    <div class="container">
        <div class="button-container">
            <button class="product-btn cash-btn" data-type="CASH" data-amount="20">CASH $20</button>
            <button class="product-btn cash-btn" data-type="CASH" data-amount="15">CASH $15</button>
            <button class="product-btn cash-btn" data-type="CASH" data-amount="10">CASH $10</button>
            <button class="product-btn cash-btn" data-type="CASH" data-amount="5">CASH $5</button>
            <button class="product-btn card-btn" data-type="CARD" data-amount="0">CARD TRANS</button>
            <button class="product-btn ticket-btn" data-type="TICKET" data-amount="0">TICKET</button>
            <button class="product-btn comp-btn" data-type="COMP" data-amount="0">COMP</button>
        </div>
        <div class="custom-input">
            <label for="customCash">Custom Cash:</label>
            <input type="number" id="customCash" placeholder="Amount" step="0.01">
            <button id="addCustomCashBtn">Add Custom Cash</button>
        </div>
        <button id="logSaleBtn" disabled>Log Sale</button>
        <p>Session Total: $<span id="sessionTotalDisplay">0.00</span></p>
        <div id="message" class="message"></div>
    </div>
    <script>
        class SalesApp {
            constructor() {
                this.sessionOpen = false;
                this.sessionId = null;
                this.sessionTotal = 0;
                this.currentSale = [];
                // Replace with your Web App URL
                this.WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzdoFgive1pD6OhgFEEZJiiFGZRGeLylu-qI99MhzS-2mLtMQ4uTceyXJU6dnDVv-PV/exec';
            }

            init() {
                this.checkSessionStatus();
                $('#toggleSalesBtn').on('click', () => this.toggleSales());
                $('.product-btn').on('click', (e) => this.addToSale(e.target.dataset.type, parseFloat(e.target.dataset.amount)));
                $('#addCustomCashBtn').on('click', () => {
                    const amount = parseFloat($('#customCash').val());
                    if (!isNaN(amount) && amount > 0) {
                        this.addToSale('CASH', amount);
                        $('#customCash').val('');
                    }
                });
                $('#logSaleBtn').on('click', () => this.logSale());
            }

            checkSessionStatus() {
                const sessionId = localStorage.getItem('activeSessionId');
                if (sessionId) {
                    this.sessionOpen = true;
                    this.sessionId = sessionId;
                    this.sessionTotal = parseFloat(localStorage.getItem('sessionTotal') || '0');
                    this.updateUIForOpenSession();
                } else {
                    this.updateUIForClosedSession();
                }
                this.updateTotalDisplay();
            }

            updateUIForOpenSession() {
                $('#eventDate, #eventVenue, #eventName, #cashierName').prop('readonly', true);
                $('#toggleSalesBtn').text('Close Sales').css('background', '#d32f2f');
                $('#logSaleBtn').prop('disabled', false);
            }

            updateUIForClosedSession() {
                $('#eventDate, #eventVenue, #eventName, #cashierName').prop('readonly', false);
                $('#toggleSalesBtn').text('Open Sales').css('background', '#388e3c');
                $('#logSaleBtn').prop('disabled', true);
            }

            updateTotalDisplay() {
                $('#sessionTotalDisplay').text(this.sessionTotal.toFixed(2));
            }

            showMessage(msg) {
                $('#message').text(msg);
                setTimeout(() => $('#message').text(''), 3000);
            }

            async toggleSales() {
                if (!this.sessionOpen) {
                    const date = $('#eventDate').val();
                    const venue = $('#eventVenue').val();
                    const eventName = $('#eventName').val();
                    const cashier = $('#cashierName').val();
                    if (!date || !venue || !eventName || !cashier) {
                        this.showMessage('Please fill in all fields');
                        return;
                    }
                    this.sessionId = Date.now().toString();
                    localStorage.setItem('activeSessionId', this.sessionId);
                    localStorage.setItem('sessionTotal', '0');
                    this.sessionTotal = 0;
                    this.sessionOpen = true;
                    await this.sendSessionStart(date, venue, eventName, cashier);
                    this.updateUIForOpenSession();
                    this.showMessage('Session started successfully');
                } else {
                    const pin = prompt('Enter PIN to close sales (default: 1234)');
                    if (pin === '1234') {
                        await this.sendSessionClose();
                        localStorage.removeItem('activeSessionId');
                        localStorage.removeItem('sessionTotal');
                        this.sessionOpen = false;
                        this.sessionId = null;
                        this.sessionTotal = 0;
                        this.updateUIForClosedSession();
                        this.showMessage('Session closed successfully');
                    } else {
                        this.showMessage('Incorrect PIN');
                    }
                }
            }

            async sendSessionStart(date, venue, eventName, cashier) {
                const data = { type: 'SESSION_START', sessionId: this.sessionId, date, venue, eventName, cashier };
                await this.sendPostRequest(data);
            }

            addToSale(type, amount) {
                if (!this.sessionOpen) {
                    this.showMessage('Please open a session first');
                    return;
                }
                this.currentSale.push({ type, amount });
                this.showMessage(`Added ${type} $${amount.toFixed(2)} to sale`);
            }

            async logSale() {
                if (!this.sessionOpen || this.currentSale.length === 0) {
                    this.showMessage('No items in sale or session not open');
                    return;
                }
                const total = this.currentSale.reduce((sum, item) => sum + item.amount, 0);
                const itemList = this.currentSale.map(item => ({ item: item.type, price: item.amount, quantity: 1 }));
                const doorCount = this.currentSale.filter(item => item.type === 'TICKET' || item.type === 'COMP').length;
                const note = 'Sale logged';
                await this.sendTransaction(itemList, total, note, doorCount);
                this.sessionTotal += total;
                localStorage.setItem('sessionTotal', this.sessionTotal.toString());
                this.updateTotalDisplay();
                this.currentSale = [];
                this.showMessage('Sale logged successfully');
            }

            async sendTransaction(itemList, total, note, doorCount) {
                const timestamp = new Date().toISOString();
                const time = new Date().toLocaleTimeString();
                const data = { type: 'TRANSACTION', sessionId: this.sessionId, timestamp, time, itemList, total, note, doorCount };
                await this.sendPostRequest(data);
            }

            async sendSessionClose() {
                const data = { type: 'SESSION_CLOSE', sessionId: this.sessionId, grandTotal: this.sessionTotal };
                await this.sendPostRequest(data);
            }

            async sendPostRequest(data) {
                try {
                    const response = await fetch(this.WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) throw new Error('Network response was not ok');
                    const result = await response.json();
                    if (result.status === 'error') throw new Error(result.message);
                    console.log('Data sent successfully:', data.type);
                } catch (error) {
                    console.error('Error sending data:', error);
                    this.showMessage('Failed to send data. Retry or check connection.');
                }
            }
        }

        const app = new SalesApp();
        $(document).ready(() => app.init());
    </script>
</body>
</html>
