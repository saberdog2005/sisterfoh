<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1e1e1e;
            color: #e0e0e0;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .products {
            flex: 2;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }
        .product-item {
            background: #2d2d2d;
            padding: 10px;
            text-align: center;
            border-radius: 5px;
        }
        .product-item button {
            margin: 5px;
            padding: 5px;
        }
        .totals-container {
            flex: 1;
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
        }
        #errorMessage {
            color: #d32f2f;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="products" id="products"></div>
        <div class="totals-container">
            <h2>Totals</h2>
            <p>Total: $<span id="totalAmount">0.00</span></p>
            <p>Thru Door: <span id="doorCount">0</span></p>
            <button id="logSaleBtn">Log Sale</button>
            <div id="errorMessage"></div>
        </div>
    </div>

    <script>
        let db;
        let currentItems = [];
        let doorCount = 0;

        // Open IndexedDB
        const request = indexedDB.open('SalesDB', 2);
        request.onupgradeneeded = function(event) {
            db = event.target.result;
            if (!db.objectStoreNames.contains('transactions')) {
                db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
            }
        };
        request.onsuccess = function(event) {
            db = event.target.result;
            initializeProducts();
        };

        // Product list
        const products = [
            { name: 'CASH $20', price: 20.00 },
            { name: 'TICKET', price: 0.00 }
        ];

        // Initialize product buttons
        function initializeProducts() {
            const $products = $('#products');
            products.forEach(product => {
                $products.append(`
                    <div class="product-item" data-item="${product.name}" data-price="${product.price}">
                        <span>${product.name} ($${product.price.toFixed(2)})</span>
                        <div><span class="count">0</span></div>
                        <button class="increment-btn">+</button>
                        <button class="decrement-btn">-</button>
                    </div>
                `);
            });
        }

        // Increment button handler
        $(document).on('click', '.increment-btn', function() {
            const $item = $(this).closest('.product-item');
            const itemName = $item.data('item');
            const itemPrice = parseFloat($item.data('price'));
            const $count = $item.find('.count');
            let count = parseInt($count.text()) + 1;
            $count.text(count);

            if (itemName === 'TICKET') {
                doorCount++;
                $('#doorCount').text(doorCount);
                logTicketTransaction(itemName, itemPrice, 1);
            } else {
                const existingItem = currentItems.find(i => i.item === itemName);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    currentItems.push({ item: itemName, price: itemPrice, quantity: 1 });
                }
                updateTotals();
            }
        });

        // Decrement button handler
        $(document).on('click', '.decrement-btn', function() {
            const $item = $(this).closest('.product-item');
            const itemName = $item.data('item');
            const $count = $item.find('.count');
            let count = parseInt($count.text()) - 1;
            if (count < 0) return;
            $count.text(count);

            if (itemName === 'TICKET') {
                if (doorCount > 0) doorCount--;
                $('#doorCount').text(doorCount);
            } else {
                const existingItem = currentItems.find(i => i.item === itemName);
                if (existingItem) {
                    existingItem.quantity--;
                    if (existingItem.quantity === 0) {
                        currentItems = currentItems.filter(i => i.item !== itemName);
                    }
                }
                updateTotals();
            }
        });

        // Update total for non-ticket items
        function updateTotals() {
            const total = currentItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            $('#totalAmount').text(total.toFixed(2));
        }

        // Auto-log ticket transaction
        function logTicketTransaction(itemName, itemPrice, quantity) {
            const transaction = {
                timestamp: new Date().toISOString(),
                itemList: [{ item: itemName, price: itemPrice, quantity: quantity }],
                total: itemPrice * quantity
            };

            const tx = db.transaction(['transactions'], 'readwrite');
            const store = tx.objectStore('transactions');
            store.add(transaction);
        }

        // Log sale button for non-ticket items
        $('#logSaleBtn').on('click', function() {
            if (currentItems.length === 0) {
                $('#errorMessage').text('No items to log.').show().delay(3000).hide(0);
                return;
            }

            const transaction = {
                timestamp: new Date().toISOString(),
                itemList: [...currentItems],
                total: currentItems.reduce((sum, item) => sum + (item.price * item.quantity), 0)
            };

            const tx = db.transaction(['transactions'], 'readwrite');
            const store = tx.objectStore('transactions');
            store.add(transaction);
            tx.oncomplete = function() {
                currentItems = [];
                $('#products .count').each(function() {
                    if ($(this).closest('.product-item').data('item') !== 'TICKET') {
                        $(this).text('0');
                    }
                });
                updateTotals();
            };
        });
    </script>
</body>
</html>
