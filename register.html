<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sister Bar Register</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { font-family: Arial, sans-serif; background: #1e1e1e; color: #e0e0e0; margin: 0; padding: 10px; font-size: 18px; }
        .header { display: flex; justify-content: space-between; align-items: center; background: #2d2d2d; padding: 10px; border-radius: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        #sessionInfo { display: flex; flex-wrap: wrap; align-items: center; gap: 10px; }
        .toggle-section { display: flex; align-items: center; gap: 10px; }
        .toggle-btn { padding: 8px 16px; font-size: 1em; border: none; border-radius: 4px; cursor: pointer; color: white; width: 150px; background: #388e3c; }
        .toggle-btn:hover { background: #4CAF50; }
        .container { max-width: 1024px; margin: 0 auto; background: #2d2d2d; padding: 20px; border-radius: 8px; }
        .button-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; margin-top: 20px; }
        .product-item { background: #3c3c3c; padding: 10px; border-radius: 4px; text-align: center; position: relative; }
        .cash-item { background: #006400; }
        .card-item { background: #8B0000; }
        .ticket-item { background: #00008B; }
        .comp-item { background: #CC8400; }
        .product-item.inactive { background: #555; opacity: 0.5; pointer-events: none; }
        .increment-btn { width: 100%; height: 60px; border: none; border-radius: 4px; cursor: pointer; font-size: 1.2em; color: white; font-weight: bold; background: inherit; }
        .increment-btn:hover { filter: brightness(1.1); }
        .decrement-btn { width: 40px; height: 40px; border: none; border-radius: 4px; cursor: pointer; font-size: 1.5em; color: white; background: #8B0000; }
        .decrement-btn:hover { background: #A52A2A; }
        .control-row { display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 5px; }
        .count { font-size: 1.5em; width: 40px; height: 40px; line-height: 40px; font-weight: bold; background: #000; color: white; border-radius: 50%; text-align: center; }
        .custom-input { display: flex; gap: 10px; justify-content: center; }
        .custom-input input { width: 100px; padding: 8px; background: #333; color: #e0e0e0; border: 1px solid #666; border-radius: 4px; font-size: 1.2em; }
        .add-custom { padding: 8px 16px; background: #006400; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
        .add-custom:hover { background: #008000; }
        .totals-container { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; background: #3c3c3c; padding: 10px; border-radius: 4px; }
        .cash-total { font-size: 2em; font-weight: bold; }
        .door-count { font-size: 1.5em; font-weight: bold; }
        #logSaleBtn { display: block; margin: 20px auto; padding: 15px 30px; font-size: 1.5em; background: #388e3c; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #logSaleBtn:hover { background: #4CAF50; }
        #logSaleBtn:disabled { background: #555; cursor: not-allowed; }
        .note-section { margin: 20px 0; text-align: center; }
        #noteInput { width: 80%; padding: 10px; background: #444; border: 1px solid #666; color: #e0e0e0; border-radius: 4px; font-size: 1em; }
        #adminControls { margin-bottom: 10px; display: none; }
        #editLayoutBtn, #confirmLayoutBtn { padding: 8px 16px; background: #388e3c; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px; }
        #editLayoutBtn:hover, #confirmLayoutBtn:hover { background: #4CAF50; }
        #confirmLayoutBtn { display: none; }
        .edit-controls { display: none; position: absolute; top: 5px; right: 5px; }
        .edit-btn { padding: 2px 6px; background: #555; color: white; border: none; border-radius: 2px; cursor: pointer; margin-left: 2px; }
        .edit-btn:hover { background: #777; }
        .message { color: #ff6b6b; margin-top: 10px; text-align: center; }
        @media (max-width: 1024px) { .button-container { grid-template-columns: repeat(3, 1fr); } }
    </style>
</head>
<body>
    <div class="header">
        <div id="sessionInfo">
            <label>Date:</label><input type="date" id="eventDate">
            <label>Venue:</label><input type="text" id="eventVenue" value="Sister">
            <label>Event:</label><input type="text" id="eventName" value="Open Mic">
        </div>
        <div class="toggle-section">
            <label>Cashier:</label><input type="text" id="cashierName" value="Default">
            <button id="toggleSalesBtn" class="toggle-btn">Open Sales</button>
        </div>
    </div>
    <div id="adminControls">
        <button id="editLayoutBtn">Edit Layout</button>
        <button id="confirmLayoutBtn">Confirm Layout</button>
    </div>
    <div class="container">
        <div class="button-container" id="buttonContainer"></div>
        <div class="totals-container">
            <div class="cash-total">Cash Total: $<span id="cashTotal">0.00</span></div>
            <div class="door-count">Thru Door: <span id="doorCount">0</span></div>
        </div>
        <div class="note-section">
            <textarea id="noteInput" placeholder="Add a note..."></textarea>
        </div>
        <button id="logSaleBtn" disabled>Log Sale</button>
        <div id="message" class="message"></div>
    </div>
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzdoFgive1pD6OhgFEEZJiiFGZRGeLylu-qI99MhzS-2mLtMQ4uTceyXJU6dnDVv-PV/exec'; // Replace with your deployed script URL
        const allButtons = [
            { item: 'CASH $20', enabled: false },
            { item: 'CASH $15', enabled: false },
            { item: 'CASH $12', enabled: false },
            { item: 'CASH $10', enabled: false },
            { item: 'CASH $7', enabled: false },
            { item: 'CASH $5', enabled: false },
            { item: 'CASH (CUSTOM)', enabled: false },
            { item: 'CC TRANS', enabled: false },
            { item: 'TICKET', enabled: false },
            { item: 'COMP', enabled: false }
        ];
        let layout = JSON.parse(localStorage.getItem('buttonLayout')) || allButtons.map(b => ({ ...b }));

        const itemConfig = {
            'CASH $20': { class: 'cash-item', price: 20 },
            'CASH $15': { class: 'cash-item', price: 15 },
            'CASH $12': { class: 'cash-item', price: 12 },
            'CASH $10': { class: 'cash-item', price: 10 },
            'CASH $7': { class: 'cash-item', price: 7 },
            'CASH $5': { class: 'cash-item', price: 5 },
            'CASH (CUSTOM)': { class: 'cash-item', price: 0 },
            'CC TRANS': { class: 'card-item', price: 0 },
            'TICKET': { class: 'ticket-item', price: 0 },
            'COMP': { class: 'comp-item', price: 0 }
        };

        function createButtonHTML(item, enabled) {
            const config = itemConfig[item] || {};
            const inactiveClass = enabled ? '' : 'inactive';
            const html = item === 'CASH (CUSTOM)' ? `
                <div class="product-item ${config.class} ${inactiveClass}" data-item="${item}">
                    <div class="custom-input">
                        <input type="number" step="0.01" min="0" placeholder="Amount">
                        <button class="add-custom">Add</button>
                    </div>
                    <div class="control-row"><span class="count">0</span><button class="decrement-btn">-</button></div>
                    <div class="edit-controls">
                        <button class="edit-btn enable-btn">+</button>
                        <button class="edit-btn disable-btn">-</button>
                    </div>
                </div>
            ` : `
                <div class="product-item ${config.class} ${inactiveClass}" data-item="${item}" data-price="${config.price}">
                    <button class="increment-btn">${item}</button>
                    <div class="control-row"><span class="count">0</span><button class="decrement-btn">-</button></div>
                    <div class="edit-controls">
                        <button class="edit-btn enable-btn">+</button>
                        <button class="edit-btn disable-btn">-</button>
                    </div>
                </div>
            `;
            return html;
        }

        function renderButtons(editMode = false) {
            const $container = $('#buttonContainer').empty();
            const buttonsToShow = editMode ? allButtons : layout.filter(b => b.enabled);
            buttonsToShow.forEach(config => {
                $container.append(createButtonHTML(config.item, config.enabled));
            });
            if (editMode) {
                $('.edit-controls').show();
                new Sortable(document.getElementById('buttonContainer'), {
                    animation: 150,
                    ghostClass: 'sortable-ghost'
                });
            } else {
                $('.edit-controls').hide();
            }
        }

        $('#editLayoutBtn').on('click', function() {
            renderButtons(true);
            $(this).hide();
            $('#confirmLayoutBtn').show();
        });

        $('#confirmLayoutBtn').on('click', function() {
            const newLayout = [];
            $('#buttonContainer .product-item').each(function() {
                const item = $(this).data('item');
                const enabled = !$(this).hasClass('inactive');
                newLayout.push({ item, enabled });
            });
            layout = newLayout.filter(b => b.enabled);
            localStorage.setItem('buttonLayout', JSON.stringify(layout));
            renderButtons(false);
            $(this).hide();
            $('#editLayoutBtn').show();
        });

        $(document).on('click', '.enable-btn', function() {
            $(this).closest('.product-item').removeClass('inactive');
        });

        $(document).on('click', '.disable-btn', function() {
            $(this).closest('.product-item').addClass('inactive');
        });

        if (localStorage.getItem('adminLoggedIn') === 'true') {
            $('#adminControls').show();
        }

        class SalesApp {
            constructor() {
                this.cashTotal = 0;
                this.doorCount = 0;
                this.items = {};
                this.isSalesActive = false;
                this.initEvents();
            }

            initEvents() {
                $(document).on('click', '.increment-btn', (e) => {
                    if (!this.isSalesActive) return;
                    const $item = $(e.target).closest('.product-item');
                    if ($item.hasClass('inactive')) return;
                    const item = $item.data('item');
                    const price = parseFloat($item.data('price') || 0);
                    this.increment(item, price);
                });

                $(document).on('click', '.decrement-btn', (e) => {
                    if (!this.isSalesActive) return;
                    const $item = $(e.target).closest('.product-item');
                    if ($item.hasClass('inactive')) return;
                    const item = $item.data('item');
                    const price = parseFloat($item.data('price') || 0);
                    this.decrement(item, price);
                });

                $(document).on('click', '.add-custom', () => {
                    if (!this.isSalesActive) return;
                    const $custom = $('#buttonContainer .product-item[data-item="CASH (CUSTOM)"]');
                    if ($custom.hasClass('inactive')) return;
                    const amount = parseFloat($custom.find('input').val()) || 0;
                    if (amount > 0) {
                        this.increment('CASH (CUSTOM)', amount);
                        $custom.find('input').val('');
                    }
                });

                $('#toggleSalesBtn').on('click', () => {
                    this.toggleSales();
                });

                $('#logSaleBtn').on('click', () => {
                    this.logSale();
                });
            }

            increment(item, price) {
                this.items[item] = (this.items[item] || 0) + 1;
                if (price > 0) this.cashTotal += price;
                if (item !== 'CASH (CUSTOM)') this.doorCount++;
                this.updateDisplay();
            }

            decrement(item, price) {
                if (this.items[item] > 0) {
                    this.items[item]--;
                    if (price > 0) this.cashTotal -= price;
                    if (item !== 'CASH (CUSTOM)') this.doorCount--;
                    this.updateDisplay();
                }
            }

            updateDisplay() {
                $('#cashTotal').text(this.cashTotal.toFixed(2));
                $('#doorCount').text(this.doorCount);
                $('.product-item').each((_, el) => {
                    const $el = $(el);
                    const item = $el.data('item');
                    $el.find('.count').text(this.items[item] || 0);
                });
                $('#logSaleBtn').prop('disabled', this.cashTotal <= 0 && this.doorCount <= 0);
            }

            async toggleSales() {
                this.isSalesActive = !this.isSalesActive;
                $('#toggleSalesBtn').text(this.isSalesActive ? 'Close Sales' : 'Open Sales');
                $('#message').text(this.isSalesActive ? 'Sales are now active.' : 'Sales are closed.');
                if (this.isSalesActive) {
                    const sessionId = Date.now().toString();
                    localStorage.setItem('activeSessionId', sessionId);
                    const titleRow = ['Type', 'SessionID', 'Date', 'Time', 'ItemList', 'Total', 'Note', 'DoorCount'];
                    await this.sendPostRequest({ type: 'TITLE', sessionId, data: titleRow });
                    $('#editLayoutBtn').hide();
                } else {
                    localStorage.removeItem('activeSessionId');
                    $('#editLayoutBtn').show();
                }
            }

            logSale() {
                if (!this.isSalesActive || (this.cashTotal <= 0 && this.doorCount <= 0)) return;
                const sessionId = localStorage.getItem('activeSessionId');
                const transaction = {
                    type: 'TRANSACTION',
                    sessionId,
                    timestamp: new Date().toISOString(),
                    time: new Date().toLocaleTimeString(),
                    itemList: Object.entries(this.items).map(([item, quantity]) => {
                        const price = parseFloat($(`[data-item="${item}"]`).data('price') || 0);
                        return { item, price, quantity, type: itemConfig[item].class.replace('-item', '') };
                    }),
                    total: this.cashTotal,
                    note: $('#noteInput').val().trim(),
                    doorCount: this.doorCount
                };
                this.sendPostRequest(transaction);
                this.reset();
            }

            async sendPostRequest(data) {
                try {
                    const response = await fetch(WEB_APP_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) throw new Error('Network response was not ok');
                    const result = await response.json();
                    if (result.status === 'error') throw new Error(result.message);
                    $('#message').text('Data sent successfully').css('color', '#4CAF50');
                } catch (error) {
                    console.error('Error sending data:', error);
                    $('#message').text('Failed to send data: ' + error.message).css('color', '#ff6b6b');
                }
            }

            reset() {
                this.cashTotal = 0;
                this.doorCount = 0;
                this.items = {};
                this.updateDisplay();
                $('#noteInput').val('');
            }
        }

        const app = new SalesApp();
        renderButtons();
    </script>
</body>
</html>
