<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Log</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="handleClientLoad()"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1e1e1e;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 90%;
            margin: 0 auto;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #555;
            text-align: left;
        }
        th {
            background: #3c3c3c;
        }
        .edit-btn {
            background: #1a73e8;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        #transactionChart {
            max-width: 100%;
            margin-top: 20px;
        }
        #errorMessage {
            color: #ff6b6b;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Transaction Log</h1>
        <table id="transactionTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Session ID</th>
                    <th>Timestamp</th>
                    <th>Time</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Note</th>
                    <th>Door Count</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <canvas id="transactionChart"></canvas>
        <div id="errorMessage"></div>
    </div>

    <script>
        const SPREADSHEET_ID = '1dJ0NuByJCDgnIRKhsmKrWFyBtCHRgR7ujfGDRb9jhMY';
        const CLIENT_ID = '251850742586-mqcsongr4qc28peshpejmhd5iuiak835.apps.googleusercontent.com';
        const SCOPE = 'https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;

        function handleClientLoad() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPE,
                callback: (response) => {
                    if (response.access_token) {
                        localStorage.setItem('accessToken', response.access_token);
                        gapi.client.setToken({ access_token: response.access_token });
                        gapi.client.load('sheets', 'v4', () => {
                            console.log('Google Sheets API loaded');
                            const logApp = new LogApp();
                        });
                    } else {
                        console.error('Token retrieval failed:', response);
                        $('#errorMessage').text('Authentication error: ' + response.error);
                    }
                }
            });
            tokenClient.requestAccessToken();
        }

        class LogApp {
            constructor() {
                this.db = null;
                this.initDB();
            }

            initDB() {
                const request = indexedDB.open('SalesDB', 3);
                request.onupgradeneeded = (event) => {
                    this.db = event.target.result;
                    if (!this.db.objectStoreNames.contains('transactions')) {
                        const transactionStore = this.db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        transactionStore.createIndex('sessionId', 'sessionId', { unique: false });
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    this.loadTransactions();
                };
                request.onerror = () => $('#errorMessage').text('Failed to open database.');
            }

            loadTransactions() {
                const tx = this.db.transaction(['transactions'], 'readonly');
                const store = tx.objectStore('transactions');
                const request = store.getAll();
                request.onsuccess = (event) => {
                    const transactions = event.target.result;
                    this.renderTransactions(transactions);
                    this.renderChart(transactions);
                };
            }

            renderTransactions(transactions) {
                const $tbody = $('#transactionTable tbody');
                $tbody.empty();
                transactions.forEach(t => {
                    const items = t.itemList.map(i => `${i.item} (x${i.quantity})`).join(', ');
                    $tbody.append(`
                        <tr>
                            <td>${t.id}</td>
                            <td>${t.sessionId}</td>
                            <td>${t.timestamp}</td>
                            <td>${t.time}</td>
                            <td>${items}</td>
                            <td>$${t.total.toFixed(2)}</td>
                            <td>${t.note || ''}</td>
                            <td>${t.itemList.some(i => i.item === 'TICKET') ? 1 : 0}</td>
                            <td><button class="edit-btn" data-id="${t.id}">Edit</button></td>
                        </tr>
                    `);
                });
                $('.edit-btn').on('click', (e) => this.editTransaction($(e.target).data('id')));
            }

            editTransaction(id) {
                const pin = prompt('Enter PIN to edit transaction (default: 1234)');
                if (pin !== '1234') {
                    $('#errorMessage').text('Incorrect PIN.');
                    return;
                }
                const tx = this.db.transaction(['transactions'], 'readwrite');
                const store = tx.objectStore('transactions');
                const request = store.get(id);
                request.onsuccess = (event) => {
                    const transaction = event.target.result;
                    const newNote = prompt('Edit note:', transaction.note);
                    if (newNote !== null) {
                        transaction.note = newNote;
                        store.put(transaction);
                        gapi.client.sheets.spreadsheets.values.append({
                            spreadsheetId: SPREADSHEET_ID,
                            range: 'Sheet1!A1',
                            valueInputOption: 'RAW',
                            resource: {
                                values: [['EDITED TRANSACTION', transaction.sessionId, transaction.id, new Date().toISOString(), transaction.time, JSON.stringify(transaction.itemList), transaction.total.toFixed(2), transaction.note]]
                            }
                        }).then(() => {
                            this.loadTransactions();
                            alert('Transaction updated.');
                        }).catch(err => $('#errorMessage').text('Google Sheet error: ' + err.message));
                    }
                };
            }

            renderChart(transactions) {
                const ctx = document.getElementById('transactionChart').getContext('2d');
                const cashTotals = transactions.map(t => t.total);
                const labels = transactions.map(t => t.time);
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Cash Total Over Time',
                            data: cashTotals,
                            borderColor: '#2e7d32',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>
