<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Log</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f0f0f0; }
        #main-content { max-width: 1200px; margin: auto; }
        h1 { text-align: center; }
        #session-selector { width: 100%; padding: 5px; margin-bottom: 10px; }
        button { padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #1976D2; }
        #session-details { margin: 10px 0; font-size: 1.1em; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
        th { background: #4CAF50; color: white; }
        canvas { width: 100% !important; max-height: 400px; margin: 20px 0; }
    </style>
</head>
<body>
    <div id="main-content">
        <h1>Transaction Log</h1>
        <select id="session-selector" onchange="updateSession()"></select>
        <button onclick="exportData()">Export Data</button>
        <div id="session-details"></div>
        <h3>Last 20 Transactions</h3>
        <table>
            <thead><tr><th>Time</th><th>Type</th><th>Amount</th></tr></thead>
            <tbody id="transaction-table"></tbody>
        </table>
        <canvas id="cashGraph"></canvas>
        <canvas id="doorGraph"></canvas>
    </div>

    <script>
        let db, cashChart, doorChart;

        function initDB() {
            const request = indexedDB.open('SalesDB', 3);
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('sessions')) {
                    db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
                }
                if (!db.objectStoreNames.contains('transactions')) {
                    const txStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                    txStore.createIndex('sessionId', 'sessionId', { unique: false });
                }
                if (!db.objectStoreNames.contains('tickers')) {
                    db.createObjectStore('tickers', { keyPath: 'id', autoIncrement: true });
                }
            };
            request.onsuccess = (event) => {
                db = event.target.result;
                loadSessions();
            };
            request.onerror = () => console.error('Failed to open IndexedDB');
        }

        function loadSessions() {
            const tx = db.transaction(['sessions'], 'readonly');
            const store = tx.objectStore('sessions');
            store.getAll().onsuccess = (event) => {
                const sessions = event.target.result;
                const sessionSelector = $('#session-selector');
                sessionSelector.empty().append('<option value="">Select a session</option>');
                sessions.forEach(session => {
                    sessionSelector.append(`<option value="${session.id}">${session.cashier} - ${session.date} (${session.status})</option>`);
                });
                const savedSession = localStorage.getItem('selectedSession');
                if (savedSession && sessions.some(s => s.id === Number(savedSession))) {
                    sessionSelector.val(savedSession);
                    updateSession();
                }
            };
        }

        function updateSession() {
            const selectedSession = Number($('#session-selector').val());
            if (!selectedSession) {
                $('#session-details').text('');
                $('#transaction-table').empty();
                if (cashChart) cashChart.destroy();
                if (doorChart) doorChart.destroy();
                return;
            }
            localStorage.setItem('selectedSession', selectedSession);
            const tx = db.transaction(['sessions', 'transactions'], 'readonly');
            const sessionStore = tx.objectStore('sessions');
            const transactionStore = tx.objectStore('transactions');
            sessionStore.get(selectedSession).onsuccess = (event) => {
                const session = event.target.result;
                if (!session) return;
                $('#session-details').text(`Date: ${session.date}, Venue: ${session.venue}, Event: ${session.eventName}, Cashier: ${session.cashier}, Status: ${session.status}`);
            };
            const index = transactionStore.index('sessionId');
            index.getAll(selectedSession).onsuccess = (event) => {
                const transactions = event.target.result;
                const recentTransactions = transactions.slice(-20).reverse();
                $('#transaction-table').empty().append(recentTransactions.map(t => 
                    `<tr><td>${t.time}</td><td>${t.type}</td><td>${t.total.toFixed(2)}</td></tr>`));
                const cashData = { labels: [], data: [] };
                const doorData = { labels: [], data: [] };
                let cumulativeCash = 0, cumulativeDoor = 0;
                transactions.forEach(t => {
                    cumulativeCash += t.total;
                    cumulativeDoor += t.doorCount;
                    cashData.labels.push(t.time);
                    cashData.data.push(cumulativeCash);
                    doorData.labels.push(t.time);
                    doorData.data.push(cumulativeDoor);
                });
                updateGraphs(cashData, doorData);
            };
        }

        function updateGraphs(cashData, doorData) {
            if (cashChart) cashChart.destroy();
            cashChart = new Chart($('#cashGraph'), {
                type: 'line',
                data: {
                    labels: cashData.labels,
                    datasets: [{ label: 'Cumulative Cash ($)', data: cashData.data, borderColor: '#2e7d32', fill: false }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
            if (doorChart) doorChart.destroy();
            doorChart = new Chart($('#doorGraph'), {
                type: 'line',
                data: {
                    labels: doorData.labels,
                    datasets: [{ label: 'Cumulative Door Count', data: doorData.data, borderColor: '#ab47bc', fill: false }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        function exportData() {
            const tx = db.transaction(['sessions', 'transactions'], 'readonly');
            const sessionStore = tx.objectStore('sessions');
            const transactionStore = tx.objectStore('transactions');
            sessionStore.getAll().onsuccess = (event) => {
                const sessions = event.target.result;
                const data = { sessions: [] };
                let completed = 0;
                sessions.forEach((session, index) => {
                    const sessionData = { ...session, transactions: [] };
                    const indexTx = transactionStore.index('sessionId');
                    indexTx.getAll(session.id).onsuccess = (e) => {
                        sessionData.transactions = e.target.result;
                        data.sessions[index] = sessionData;
                        completed++;
                        if (completed === sessions.length) {
                            const dataStr = JSON.stringify(data, null, 2);
                            const blob = new Blob([dataStr], { type: 'application/json' });
                            const url = URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = 'data.log';
                            a.click();
                            URL.revokeObjectURL(url);
                        }
                    };
                });
            };
        }

        $(document).ready(() => initDB());
    </script>
</body>
</html>
