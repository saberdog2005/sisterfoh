<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sister Bar Log</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1e1e1e;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            font-size: 18px;
        }
        .container {
            max-width: 95%;
            margin: 0 auto;
            background: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        h1 {
            text-align: center;
            color: #1a73e8;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #3c3c3c;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #555;
        }
        th {
            background: #1a73e8;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background: #444;
        }
        .error-message {
            color: #ff6b6b;
            text-align: center;
            margin-top: 20px;
            font-size: 1.1em;
            display: none;
        }
        .local-table {
            margin-top: 40px;
        }
        .local-table th {
            background: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sister Bar Transaction Log</h1>
        <table id="logTable">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Session ID</th>
                    <th>Timestamp</th>
                    <th>Time</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Note</th>
                    <th>Door Count</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <h1>Local Unsynced Transactions</h1>
        <table id="localLogTable" class="local-table">
            <thead>
                <tr>
                    <th>Session ID</th>
                    <th>Timestamp</th>
                    <th>Time</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Note</th>
                    <th>Door Count</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
        <div id="errorMessage" class="error-message"></div>
    </div>

    <script>
        const SPREADSHEET_ID = '1dJ0NuByJCDgnIRKhsmKrWFyBtCHRgR7ujfGDRb9jhMY';
        const API_KEY = 'AIzaSyAS_wlduCCcRSDA3Hjt3hMPRg3olegY2Ic';
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const CLIENT_ID = '251850742586-r8lci00j14guero2hd0austoj73jl8mm.apps.googleusercontent.com';
        const SCOPE = "https://www.googleapis.com/auth/spreadsheets";

        class LogApp {
            constructor() {
                this.db = null;
                this.initGoogleAPI();
                this.initDB();
            }

            initGoogleAPI() {
                gapi.load('client:auth2', () => {
                    gapi.client.init({
                        apiKey: API_KEY,
                        clientId: CLIENT_ID,
                        discoveryDocs: DISCOVERY_DOCS,
                        scope: SCOPE
                    }).then(() => {
                        gapi.auth2.getAuthInstance().isSignedIn.listen(() => this.updateUI());
                        this.updateUI();
                    }).catch(err => this.showError('Google API initialization failed: ' + err.message));
                });
            }

            initDB() {
                const request = indexedDB.open('SalesDB', 2);
                request.onupgradeneeded = (event) => {
                    this.db = event.target.result;
                    if (!this.db.objectStoreNames.contains('sessions')) {
                        this.db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!this.db.objectStoreNames.contains('transactions')) {
                        const transactionStore = this.db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        transactionStore.createIndex('sessionId', 'sessionId', { unique: false });
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    this.loadLocalTransactions();
                };
                request.onerror = () => this.showError('Failed to open database.');
            }

            updateUI() {
                if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
                    gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'Sheet1!A:H'
                    }).then(response => {
                        const values = response.result.values || [];
                        const tbody = $('#logTable tbody');
                        tbody.empty();
                        values.forEach(row => {
                            const [type, sessionId, timestamp, time, items, total, note, doorCount] = row;
                            const itemsParsed = items ? JSON.parse(items) : [];
                            const itemsText = itemsParsed.map(i => `${i.item} (x${i.quantity})`).join(', ');
                            tbody.append(`
                                <tr>
                                    <td>${type || ''}</td>
                                    <td>${sessionId || ''}</td>
                                    <td>${timestamp || ''}</td>
                                    <td>${time || ''}</td>
                                    <td>${itemsText}</td>
                                    <td>${total || ''}</td>
                                    <td>${note || ''}</td>
                                    <td>${doorCount || ''}</td>
                                </tr>
                            `);
                        });
                    }).catch(err => this.showError('Error fetching data: ' + err.message));
                }
            }

            loadLocalTransactions() {
                const tx = this.db.transaction(['transactions'], 'readonly');
                const store = tx.objectStore('transactions');
                const request = store.getAll();
                request.onsuccess = (event) => {
                    const transactions = event.target.result;
                    const tbody = $('#localLogTable tbody');
                    tbody.empty();
                    transactions.forEach(t => {
                        const itemsText = t.itemList.map(i => `${i.item} (x${i.quantity})`).join(', ');
                        tbody.append(`
                            <tr>
                                <td>${t.sessionId}</td>
                                <td>${t.timestamp}</td>
                                <td>${t.time}</td>
                                <td>${itemsText}</td>
                                <td>${t.total.toFixed(2)}</td>
                                <td>${t.note || ''}</td>
                                <td>${this.calculateDoorCount(t.itemList)}</td>
                            </tr>
                        `);
                    });
                };
            }

            calculateDoorCount(itemList) {
                return itemList.reduce((sum, item) => sum + (item.item === 'TICKET' ? item.quantity : 0), 0);
            }

            showError(message) {
                $('#errorMessage').text(message).show();
                setTimeout(() => $('#errorMessage').hide(), 3000);
            }
        }

        const logApp = new LogApp();
    </script>
</body>
</html>
