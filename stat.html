<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Log</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #1e1e1e;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            max-width: 1000px;
            width: 100%;
            background-color: #2d2d2d;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        h1 {
            text-align: center;
            color: #bb86fc;
        }
        #log {
            margin-top: 20px;
            padding: 10px;
            background-color: #3c3c3c;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        .chart-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #3c3c3c;
            border-radius: 4px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sales Log</h1>
        <div class="chart-container">
            <canvas id="thruDoorChart"></canvas>
        </div>
        <div id="log"></div>
    </div>

    <script>
        class SalesLog {
            constructor() {
                this.db = null;
                this.chart = null;
                this.initDB();
            }

            initDB() {
                const request = indexedDB.open('SalesDB', 1);
                request.onupgradeneeded = () => {
                    const db = request.result;
                    db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                };
                request.onsuccess = () => {
                    this.db = request.result;
                    this.loadTransactions();
                };
                request.onerror = () => console.error('Database error');
            }

            async loadTransactions() {
                const tx = this.db.transaction('transactions', 'readonly');
                const store = tx.objectStore('transactions');
                const request = store.getAll();
                request.onsuccess = () => {
                    const transactions = request.result;
                    this.displayLog(transactions);
                    this.displayThruDoorGraph(transactions);
                };
            }

            displayLog(transactions) {
                const log = document.getElementById('log');
                log.innerHTML = transactions
                    .map(t => `<p>[${new Date(t.timestamp).toLocaleString()}] Session ${t.sessionId}: ${t.items} | Cash: $${t.cashTotal.toFixed(2)} | Thru Door: ${t.doorCount}</p>`)
                    .join('');
            }

            parseItems(items) {
                const counts = { cash: 0, cc: 0, ticket: 0, comp: 0 };
                const parts = items.split(', ');
                parts.forEach(part => {
                    const [item, details] = part.split(': ');
                    const count = parseInt(details.split(' @ ')[0]);
                    if (item.startsWith('CASH')) counts.cash += count;
                    else if (item === 'CC TRANS') counts.cc += count;
                    else if (item === 'TICKET') counts.ticket += count;
                    else if (item === 'COMP') counts.comp += count;
                });
                return counts;
            }

            displayThruDoorGraph(transactions) {
                let cashCumulative = 0, ccCumulative = 0, ticketCumulative = 0, compCumulative = 0;
                const labels = transactions.map(t => new Date(t.timestamp).toLocaleTimeString());
                const cashData = [], ccData = [], ticketData = [], compData = [], totalData = [];

                transactions.forEach(t => {
                    const counts = this.parseItems(t.items);
                    cashCumulative += counts.cash;
                    ccCumulative += counts.cc;
                    ticketCumulative += counts.ticket;
                    compCumulative += counts.comp;
                    cashData.push(cashCumulative);
                    ccData.push(ccCumulative);
                    ticketData.push(ticketCumulative);
                    compData.push(compCumulative);
                    totalData.push(t.doorCount); // Cumulative total from register
                });

                const ctx = document.getElementById('thruDoorChart').getContext('2d');
                if (this.chart) this.chart.destroy();
                this.chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Cash Thru Door', data: cashData, borderColor: '#2e7d32', fill: false },
                            { label: 'CC Thru Door', data: ccData, borderColor: '#d32f2f', fill: false },
                            { label: 'Ticket Thru Door', data: ticketData, borderColor: '#1a73e8', fill: false },
                            { label: 'Comp Thru Door', data: compData, borderColor: '#ffa500', fill: false },
                            { label: 'Total Thru Door', data: totalData, borderColor: '#9c27b0', borderWidth: 2, fill: false }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Thru Door Count', color: '#e0e0e0' } },
                            x: { title: { display: true, text: 'Time', color: '#e0e0e0' } }
                        },
                        plugins: {
                            legend: { labels: { color: '#e0e0e0' } }
                        }
                    }
                });
            }
        }

        new SalesLog();
    </script>
</body>
</html>
