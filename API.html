<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales API</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>Sales API</h1>
    <p>Load this page to sync sales data to Google Sheets.</p>
    <div id="status"></div>

    <script>
        const CLIENT_ID = 'YOUR_CLIENT_ID'; // Replace with your Google Cloud Client ID
        const API_KEY = 'YOUR_API_KEY'; // Replace with your Google Cloud API Key
        const SPREADSHEET_ID = 'YOUR_SPREADSHEET_ID'; // Replace with your Spreadsheet ID
        const SHEET_NAME = 'LIVE REGISTER';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        let db;

        function init() {
            const request = indexedDB.open('SalesDB', 2);
            request.onsuccess = (event) => {
                db = event.target.result;
                gapi.load('client:auth2', initClient);
            };
            request.onerror = () => {
                $('#status').text('Failed to open database.');
            };
        }

        function initClient() {
            gapi.client.init({
                apiKey: API_KEY,
                clientId: CLIENT_ID,
                scope: SCOPES,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            }).then(() => {
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
                updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
            }, (error) => {
                $('#status').text('Error initializing Google API: ' + JSON.stringify(error));
            });
        }

        function updateSigninStatus(isSignedIn) {
            if (isSignedIn) {
                syncToGoogleSheets();
            } else {
                gapi.auth2.getAuthInstance().signIn();
            }
        }

        function syncToGoogleSheets() {
            const tx = db.transaction(['transactions'], 'readonly');
            const store = tx.objectStore('transactions');
            const request = store.getAll();

            request.onsuccess = (event) => {
                const transactions = event.target.result;
                const data = transactions.map(t => [
                    t.sessionId,
                    t.timestamp,
                    t.time,
                    t.itemList.map(i => `${i.item} (x${i.quantity})`).join(', '),
                    t.total,
                    t.note || '',
                    t.doorCount || 0
                ]);

                const headers = ['Session ID', 'Timestamp', 'Time', 'Items', 'Total', 'Note', 'Door Count'];
                const values = [headers, ...data];

                gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${SHEET_NAME}!A1`,
                    valueInputOption: 'RAW',
                    resource: { values: values }
                }).then((response) => {
                    $('#status').text(`Successfully synced ${transactions.length} transactions to Google Sheets.`);
                }, (error) => {
                    $('#status').text('Error syncing to Google Sheets: ' + error.result.error.message);
                });
            };

            request.onerror = () => {
                $('#status').text('Failed to fetch transactions.');
            };
        }

        $(document).ready(() => {
            init();
        });
    </script>
</body>
</html>
