<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://code.jquery.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://unpkg.com https://html2canvas.hertzen.com;
        connect-src 'self' https://nnbevkohcjnzyxgkzgna.supabase.co wss://nnbevkohcjnzyxgkzgna.supabase.co;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
    ">
    <title>Sales Log</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 10px; background-color: #1e1e1e; color: #e0e0e0; overflow: hidden; }
        .container { width: 98.5%; height: 98.5vh; }
        .grid { display: grid; grid-template-columns: 2fr 2fr 1fr; grid-template-rows: auto; gap: 10px; height: 100%; transition: grid-template-columns 0.2s ease; }
        .header { grid-column: 1 / -1; text-align: center; font-size: 24px; display: none; }
        .graph { grid-column: 1; background-color: #2e2e2e; padding: 20px; border-radius: 5px; display: flex; flex-direction: column; position: relative; }
        .middle-panel { grid-column: 2; display: flex; flex-direction: column; gap: 10px; }
        .tally-sheet { flex: 0 0 300px; background-color: #2e2e2e; padding: 20px; border-radius: 5px; }
        .totals { background-color: #2e2e2e; padding: 10px; border-radius: 5px; }
        .transaction-log { flex: 1; background-color: #2e2e2e; padding: 20px; border-radius: 5px; }
        .right-panel { grid-column: 3; display: flex; flex-direction: column; gap: 10px; }
        .filters { flex: 0 0 auto; background-color: #2e2e2e; padding: 20px; border-radius: 5px; }
        .summary { flex: 1; overflow-y: auto; background-color: #2e2e2e; padding: 20px; border-radius: 5px; }
        .graph-wrapper { flex: 1; min-height: 0; }
        #doorCountChart { width: 100%; height: 100%; }
        .tally-sheet table, .transaction-log table, .totals table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .tally-sheet table, .totals table { table-layout: fixed; }
        .tally-sheet th:nth-child(1), .tally-sheet td:nth-child(1), .totals td:nth-child(1) { width: 25%; }
        .tally-sheet th:nth-child(2), .tally-sheet td:nth-child(2), .totals td:nth-child(2) { width: 25%; }
        .tally-sheet th:nth-child(3), .tally-sheet td:nth-child(3), .totals td:nth-child(3) { width: 25%; }
        .tally-sheet th:nth-child(4), .tally-sheet td:nth-child(4), .totals td:nth-child(4) { width: 25%; }
        .tally-sheet th, .transaction-log th { background-color: #3e3e3e; position: static; }
        .tally-sheet td, .transaction-log td { padding: 10px; text-align: left; border-bottom: 1px solid #444; }
        th { background-color: #3e3e3e; color: #ffffff; }
        .tally-sheet .scrollable-body { max-height: 200px; overflow-y: auto; } /* Added for scrolling */
        .transaction-log .scrollable-body { max-height: 300px; overflow-y: auto; }
        .summary h3 { font-size: 18px; }
        .filters label, .filters select, .filters button { display: block; margin: 10px 0; width: 100%; padding: 8px; font-size: 16px; }
        .filters select { background-color: #333; color: #e0e0e0; border: 1px solid #555; max-width: 300px; }
        .filters button { background-color: #0288d1; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #exportBtn { background-color: #2e7d32; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; padding: 8px; font-size: 16px; margin-top: 10px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: #2e2e2e; margin: 15% auto; padding: 20px; width: 300px; border-radius: 5px; text-align: center; }
        .modal-content input { width: 100%; padding: 10px; margin: 10px 0; background-color: #333; color: #e0e0e0; border: 1px solid #555; font-size: 16px; }
        .modal-content button { padding: 10px 20px; background-color: #2e7d32; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .error { color: #d32f2f; margin-top: 10px; }
        .graph.fullscreen { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1000; background-color: #1e1e1e; padding: 20px; box-sizing: border-box; }
        .grid.fullscreen { grid-template-columns: 1fr; }
        .middle-panel.fullscreen, .right-panel.fullscreen { display: none; }
        .resize-handle { height: 10px; background-color: #444; cursor: ns-resize; position: absolute; bottom: 0; left: 0; right: 0; }
        .cash-header { color: #2e7d32; }
        .credit-card-header { color: #d32f2f; }
        .comp-header { color: #ffa500; }
        .ticket-header { color: #1a73e8; }
        .summary h3 span { color: orange; }
        .total-row td { color: orange; }
    </style>
</head>
<body>
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>Admin Login</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button id="loginBtn">Login</button>
            <p id="errorMsg" class="error"></p>
        </div>
    </div>

    <div class="container" id="salesLogContainer">
        <div class="grid">
            <h1 class="header">Sales Log</h1>
            <div class="graph">
                <h2>Sales Log</h2>
                <button id="toggleGraphSize">Toggle Full Screen</button>
                <div class="graph-wrapper">
                    <canvas id="doorCountChart"></canvas>
                </div>
                <div class="resize-handle"></div>
            </div>
            <div class="middle-panel">
                <div class="tally-sheet">
                    <h2>Tally Sheet</h2>
                    <table>
                        <thead>
                            <tr>
                                <th class="payment-type-header">Payment Type</th>
                                <th>People</th>
                                <th>Total Amount</th>
                                <th>Price per Person</th>
                            </tr>
                        </thead>
                    </table>
                    <div class="scrollable-body">
                        <table>
                            <tbody id="summaryBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="totals">
                    <table>
                        <tbody id="totalsBody"></tbody>
                    </table>
                </div>
                <div class="transaction-log">
                    <h2>Transaction Log</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Items</th>
                                <th>Cash Total</th>
                                <th>Door Count</th>
                                <th>Cashier</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                    </table>
                    <div class="scrollable-body">
                        <table>
                            <tbody id="transactionLogBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="right-panel">
                <div class="filters">
                    <h2>Filters</h2>
                    <label>Cashier Session:
                        <select id="sessionSelect">
                            <option value="">Select Cashier Session</option>
                        </select>
                    </label>
                    <button id="applyFilters">Apply</button>
                </div>
                <div class="summary">
                    <h2>Summary</h2>
                    <div id="sessionInfo"></div>
                    <h3 style="color: pink;">Total Thru Door: <span id="totalDoorCount">0</span></h3>
                    <h3 style="color: pink;">Total Cash Sales: $<span id="totalSales">0.00</span></h3>
                    <h3 style="color: pink;">Total Transactions: <span id="totalTransactions">0</span></h3>
                    <button id="exportBtn">Export to PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nnbevkohcjnzyxgkzgna.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uYmV2a29oY2puenl4Z2t6Z25hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5OTU5NTksImV4cCI6MjA1NzU3MTk1OX0.azv5XuUBxoyvr19-eGxnl37X7u0GOlCRj3L0jZ_8JHY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const adminUsername = "admin";
        const adminPassword = "password123";
        const LOGIN_TIMEOUT = 8 * 60 * 60 * 1000;
        const channel = new BroadcastChannel('transaction_channel');

        const loginModal = document.getElementById('loginModal');
        const salesLogContainer = document.getElementById('salesLogContainer');
        const errorMsg = document.getElementById('errorMsg');

        let sessionTimeoutId;
        let salesLogInstance;
        let chart;
        let selectedSessionId = null;

        function formatItems(items) {
            return Object.entries(items).map(([key, data]) => `${key}: ${data.count} @ $${data.price.toFixed(2)}`).join('; ');
        }

        function colorCodeItems(items) {
            const types = ['Cash', 'Credit Card', 'Comp', 'Ticket'];
            return items.split('; ').map(item => {
                const type = types.find(t => item.startsWith(t));
                if (type) {
                    const rest = item.slice(type.length);
                    return `<span class="${type.toLowerCase().replace(' ', '-')}-header">${type}</span>${rest}`;
                }
                return item;
            }).join('; ');
        }

        class SalesLog {
            constructor() {
                this.transactions = [];
                const urlParams = new URLSearchParams(window.location.search);
                const sessionIdFromUrl = urlParams.get('sessionId');
                const exportFlag = urlParams.get('export');

                if (sessionIdFromUrl) selectedSessionId = sessionIdFromUrl;

                this.updateInterval = null;
                this.init().then(() => {
                    this.updateLog();
                    if (exportFlag === 'true') this.exportPDF();
                    this.updateInterval = setInterval(() => this.updateLog(), 5000);
                    channel.onmessage = (event) => {
                        if (event.data.type === 'new_transaction') this.updateLog();
                        else if (event.data.type === 'new_session') {
                            selectedSessionId = event.data.sessionId;
                            this.updateLog();
                        }
                    };
                    supabase
                        .channel('public:transactions')
                        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'transactions' }, () => this.updateLog())
                        .subscribe(status => console.log('Subscription status:', status));
                });

                document.getElementById('exportBtn').addEventListener('click', () => this.exportPDF());
                document.getElementById('applyFilters').addEventListener('click', () => {
                    selectedSessionId = document.getElementById('sessionSelect').value || null;
                    this.updateLog();
                });
                document.getElementById('sessionSelect').addEventListener('change', (event) => {
                    selectedSessionId = event.target.value || null;
                    this.updateLog();
                });
                document.getElementById('toggleGraphSize').addEventListener('click', () => {
                    const graph = document.querySelector('.graph');
                    const grid = document.querySelector('.grid');
                    const middlePanel = document.querySelector('.middle-panel');
                    const rightPanel = document.querySelector('.right-panel');
                    
                    if (!graph.dataset.originalHeight) {
                        graph.dataset.originalHeight = window.getComputedStyle(graph).height;
                    }
                    
                    graph.classList.toggle('fullscreen');
                    grid.classList.toggle('fullscreen');
                    middlePanel.classList.toggle('fullscreen');
                    rightPanel.classList.toggle('fullscreen');
                    
                    if (!graph.classList.contains('fullscreen')) {
                        graph.style.height = graph.dataset.originalHeight;
                    }
                    
                    if (chart) setTimeout(() => chart.resize(), 100);
                });

                let isResizing = false;
                let startY, startHeight;
                const resizeHandle = document.querySelector('.resize-handle');
                const graph = document.querySelector('.graph');

                resizeHandle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startY = e.clientY;
                    startHeight = parseInt(window.getComputedStyle(graph).height, 10);
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                });

                function resize(e) {
                    if (!isResizing) return;
                    const dy = e.clientY - startY;
                    const newHeight = startHeight + dy;
                    if (newHeight > 100 && newHeight < window.innerHeight * 0.8) {
                        graph.style.height = `${newHeight}px`;
                        chart.resize();
                    }
                }

                function stopResize() {
                    isResizing = false;
                    document.removeEventListener('mousemove', resize);
                    document.removeEventListener('mouseup', stopResize);
                }
            }

            async init() {
                await this.updateLog();
            }

            stop() {
                if (this.updateInterval) clearInterval(this.updateInterval);
            }

            async updateLog() {
                try {
                    const { data: allTransactions, error } = await supabase
                        .from('transactions')
                        .select('*')
                        .order('sessionId', { ascending: false });
                    if (error) throw new Error(`Error fetching transactions: ${error.message}`);

                    const validTransactions = allTransactions.filter(t => t.sessionId != null);
                    
                    const allSessionIds = [...new Set(validTransactions.map(t => t.sessionId))];
                    const sessionSelect = document.getElementById('sessionSelect');
                    sessionSelect.innerHTML = '<option value="">Select Cashier Session</option>' +
                        allSessionIds.map(id => {
                            const sessionTx = validTransactions.find(t => t.sessionId === id);
                            const cashier = sessionTx ? sessionTx.cashierName : 'Unknown';
                            return `<option value="${id}" ${id === selectedSessionId ? 'selected' : ''}>${cashier} - ${id}</option>`;
                        }).join('');

                    if (!selectedSessionId && allSessionIds.length > 0) selectedSessionId = allSessionIds[0];
                    if (!selectedSessionId) {
                        document.getElementById('sessionInfo').innerHTML = '<p>No session available</p>';
                        if (chart) {
                            chart.data.datasets = [];
                            chart.update();
                        }
                        document.getElementById('summaryBody').innerHTML = '';
                        document.getElementById('totalsBody').innerHTML = '';
                        document.getElementById('transactionLogBody').innerHTML = '';
                        document.getElementById('totalDoorCount').textContent = '0';
                        document.getElementById('totalSales').textContent = '0.00';
                        document.getElementById('totalTransactions').textContent = '0';
                        return;
                    }

                    const transactions = validTransactions.filter(t => t.sessionId.toString() === selectedSessionId.toString());
                    this.transactions = transactions;
                    sessionSelect.value = selectedSessionId;
                    transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    const eventName = transactions.length > 0 ? transactions[0].eventName : 'No Event';
                    const uniqueCashiers = [...new Set(transactions.map(t => t.cashierName))];
                    document.getElementById('sessionInfo').innerHTML = `<p>Event Name: ${eventName}</p><p>Cashier(s): ${uniqueCashiers.join(', ')}</p>`;

                    const itemSummary = {};
                    let totalDoorCount = 0;
                    let totalSales = 0;

                    transactions.forEach(t => {
                        Object.entries(t.items).forEach(([key, data]) => {
                            const count = data.count || 0;
                            const price = data.price || 0;
                            if (!itemSummary[key]) itemSummary[key] = { people: 0, total: 0, price };
                            itemSummary[key].people += count;
                            itemSummary[key].total += count * price;
                        });
                        totalDoorCount += t.doorCount || 0;
                        totalSales += t.cashTotal || 0;
                    });

                    document.getElementById('totalDoorCount').textContent = totalDoorCount;
                    document.getElementById('totalSales').textContent = totalSales.toFixed(2);
                    document.getElementById('totalTransactions').textContent = transactions.length;

                    const summaryRows = Object.entries(itemSummary)
                        .map(([key, data]) => `
                            <tr>
                                <td>${key}</td>
                                <td>${data.people}</td>
                                <td>$${data.total.toFixed(2)}</td>
                                <td>$${data.price.toFixed(2)}</td>
                            </tr>
                        `).join('');
                    document.getElementById('summaryBody').innerHTML = summaryRows;

                    const totalsRow = `
                        <tr class="total-row">
                            <td><strong>TOTALS</strong></td>
                            <td><strong>${totalDoorCount}</strong></td>
                            <td><strong>$${totalSales.toFixed(2)}</strong></td>
                            <td>${totalDoorCount ? (totalSales / totalDoorCount).toFixed(2) : '#DIV/0!'}</td>
                        </tr>
                    `;
                    document.getElementById('totalsBody').innerHTML = totalsRow;

                    const transactionLogBody = document.getElementById('transactionLogBody');
                    transactionLogBody.innerHTML = transactions.map(t => `
                        <tr>
                            <td>${new Date(t.timestamp).toLocaleString()}</td>
                            <td>${colorCodeItems(formatItems(t.items))}</td>
                            <td>$${t.cashTotal.toFixed(2)}</td>
                            <td>${t.doorCount}</td>
                            <td>${t.cashierName}</td>
                            <td>${t.note || ''}</td>
                        </tr>
                    `).join('');

                    const types = ['Cash', 'Credit Card', 'Comp', 'Ticket'];
                    const transactionCounts = {};
                    const interval = 30 * 60 * 1000; // 30 minutes in milliseconds

                    transactions.forEach(t => {
                        const txTime = new Date(t.timestamp).getTime();
                        const bin = Math.floor(txTime / interval) * interval;
                        if (!transactionCounts[bin]) {
                            transactionCounts[bin] = { total: 0 };
                            types.forEach(type => transactionCounts[bin][type] = 0);
                        }
                        transactionCounts[bin].total++;
                        Object.entries(t.items).forEach(([key, data]) => {
                            let type;
                            if (key.startsWith('Cash')) type = 'Cash';
                            else if (key.startsWith('Credit Card')) type = 'Credit Card';
                            else if (key.startsWith('Comp')) type = 'Comp';
                            else if (key.startsWith('Ticket')) type = 'Ticket';
                            if (types.includes(type)) transactionCounts[bin][type] += data.count;
                        });
                    });

                    const labels = Object.keys(transactionCounts).map(bin => new Date(parseInt(bin)));
                    const datasets = types.map(type => ({
                        label: type,
                        data: labels.map(label => ({ x: label, y: transactionCounts[label.getTime()][type] || 0 })),
                        borderColor: getColorForType(type),
                        fill: false
                    }));
                    datasets.push({
                        label: 'Total',
                        data: labels.map(label => ({ x: label, y: transactionCounts[label.getTime()].total || 0 })),
                        borderColor: '#808080',
                        fill: false
                    });

                    if (chart) {
                        chart.data.labels = labels;
                        chart.data.datasets = datasets;
                        chart.update();
                    } else {
                        chart = new Chart(document.getElementById('doorCountChart'), {
                            type: 'line',
                            data: { labels, datasets },
                            options: {
                                maintainAspectRatio: false,
                                scales: {
                                    x: { type: 'time', time: { unit: 'minute', stepSize: 30 }, title: { display: true, text: 'Time' } },
                                    y: { beginAtZero: true, title: { display: true, text: 'Number of Transactions' } }
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error updating log:', error);
                }
            }

            async exportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'in', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 0.5;
                const graphWidth = pageWidth - 2 * margin;
                const graphHeight = graphWidth * (11.69 / 8.27) / 2;
                const dpi = 150;

                if (!chart || !chart.data || !chart.data.datasets || chart.data.datasets.length === 0) {
                    console.error('No chart data available for export.');
                    return;
                }

                doc.setFontSize(16);
                doc.text('Sales Log Summary', pageWidth / 2, margin, { align: 'center' });

                const sessionInfo = document.getElementById('sessionInfo').innerText;
                doc.setFontSize(12);
                doc.text(sessionInfo, margin, margin + 0.2);

                const summaryData = [
                    ['Total Thru Door', document.getElementById('totalDoorCount').innerText],
                    ['Total Cash Sales', '$' + document.getElementById('totalSales').innerText],
                    ['Total Transactions', document.getElementById('totalTransactions').innerText]
                ];
                doc.autoTable({
                    startY: margin + 0.4,
                    head: [['Metric', 'Value']],
                    body: summaryData,
                    theme: 'grid',
                    styles: { fontSize: 12 }
                });

                const tallyData = Array.from(document.querySelectorAll('.tally-sheet .scrollable-body tr')).map(row => 
                    Array.from(row.cells).map(cell => cell.innerText)
                );
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 0.2,
                    head: [['Payment Type', 'People', 'Total Amount', 'Price per Person']],
                    body: tallyData,
                    theme: 'grid',
                    styles: { fontSize: 10 }
                });

                const totalsData = Array.from(document.querySelector('.totals table tr')).map(row => 
                    Array.from(row.cells).map(cell => cell.innerText)
                );
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 0.2,
                    head: [['', 'People', 'Total Amount', 'Price per Person']],
                    body: totalsData,
                    theme: 'grid',
                    styles: { fontSize: 10 }
                });

                const transactionData = Array.from(document.querySelectorAll('.transaction-log .scrollable-body tr')).map(row => 
                    Array.from(row.cells).map(cell => cell.innerText)
                );
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 0.2,
                    head: [['Timestamp', 'Items', 'Cash Total', 'Door Count', 'Cashier', 'Note']],
                    body: transactionData,
                    theme: 'grid',
                    styles: { fontSize: 8 }
                });

                // Start interval bar charts on a new page
                doc.addPage();

                const startTime = new Date(Math.min(...this.transactions.map(t => new Date(t.timestamp))));
                const endTime = new Date(Math.max(...this.transactions.map(t => new Date(t.timestamp))));
                const interval = 30 * 60 * 1000; // 30 minutes in milliseconds
                const types = ['Cash', 'Credit Card', 'Comp', 'Ticket'];

                for (let time = startTime.getTime(); time < endTime.getTime(); time += interval) {
                    const intervalStart = new Date(time);
                    const intervalEnd = new Date(time + interval);
                    const intervalTransactions = this.transactions.filter(t => {
                        const txTime = new Date(t.timestamp);
                        return txTime >= intervalStart && txTime < intervalEnd;
                    });

                    if (intervalTransactions.length > 0) {
                        const intervalSummary = {};
                        types.forEach(type => intervalSummary[type] = 0);
                        let intervalTotal = 0;

                        intervalTransactions.forEach(t => {
                            Object.entries(t.items).forEach(([key, data]) => {
                                let type;
                                if (key.startsWith('Cash')) type = 'Cash';
                                else if (key.startsWith('Credit Card')) type = 'Credit Card';
                                else if (key.startsWith('Comp')) type = 'Comp';
                                else if (key.startsWith('Ticket')) type = 'Ticket';
                                if (types.includes(type)) intervalSummary[type] += data.count;
                            });
                            intervalTotal += t.doorCount || 0;
                        });

                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = graphWidth * dpi;
                        tempCanvas.height = graphHeight * dpi;
                        document.body.appendChild(tempCanvas);
                        const tempCtx = tempCanvas.getContext('2d');
                        const barChart = new Chart(tempCtx, {
                            type: 'bar',
                            data: {
                                labels: types.concat('Total'),
                                datasets: [{
                                    label: 'Count',
                                    data: types.map(type => intervalSummary[type]).concat(intervalTotal),
                                    backgroundColor: types.map(type => getColorForType(type)).concat('#808080'),
                                }]
                            },
                            options: {
                                animation: { duration: 0 },
                                scales: {
                                    y: { beginAtZero: true, title: { display: true, text: 'Count', font: { size: 16 } }, ticks: { font: { size: 14 } } },
                                    x: { title: { display: true, text: 'Type', font: { size: 16 } }, ticks: { font: { size: 14 } } }
                                },
                                plugins: {
                                    legend: { labels: { font: { size: 14 } } }
                                }
                            }
                        });
                        barChart.update();
                        await new Promise(resolve => setTimeout(resolve, 100));
                        doc.setFontSize(16);
                        doc.text(`Sales Summary for ${intervalStart.toLocaleTimeString()} - ${intervalEnd.toLocaleTimeString()}`, pageWidth / 2, margin, { align: 'center' });
                        doc.addImage(tempCanvas, 'PNG', margin, margin + 0.2, graphWidth, graphHeight);
                        document.body.removeChild(tempCanvas);
                        barChart.destroy();
                        doc.addPage();
                    }
                }

                // Main chart on the last page
                const mainCanvas = document.createElement('canvas');
                mainCanvas.width = graphWidth * dpi;
                mainCanvas.height = graphHeight * dpi;
                document.body.appendChild(mainCanvas);
                const mainCtx = mainCanvas.getContext('2d');
                const tempChart = new Chart(mainCtx, {
                    type: 'line',
                    data: chart.data,
                    options: {
                        animation: { duration: 0 },
                        maintainAspectRatio: false,
                        scales: {
                            x: { type: 'time', time: { unit: 'minute', stepSize: 30 }, title: { display: true, text: 'Time', font: { size: 16 } } },
                            y: { beginAtZero: true, title: { display: true, text: 'Number of Transactions', font: { size: 16 } }, ticks: { font: { size: 14 } } }
                        },
                        plugins: {
                            legend: { labels: { font: { size: 14 } } }
                        }
                    }
                });
                tempChart.update();
                await new Promise(resolve => setTimeout(resolve, 100));
                doc.setFontSize(16);
                doc.text('Sales Log (Full Session)', pageWidth / 2, margin, { align: 'center' });
                doc.addImage(mainCanvas, 'PNG', margin, margin + 0.2, graphWidth, graphHeight);
                document.body.removeChild(mainCanvas);
                tempChart.destroy();

                doc.save(`sales_log_${selectedSessionId || 'latest'}.pdf`);
            }
        }

        function getColorForType(type) {
            const colors = {
                'Cash': '#2e7d32',
                'Credit Card': '#d32f2f',
                'Comp': '#ffa500',
                'Ticket': '#1a73e8',
                'Total': '#808080'
            };
            return colors[type] || '#888888';
        }

        function waitForChartRender(chart) {
            return new Promise(resolve => {
                if (chart.options.animation && chart.options.animation.duration > 0) {
                    chart.options.animation.onComplete = () => resolve();
                } else {
                    resolve();
                }
            });
        }

        function isLoggedIn() {
            return localStorage.getItem('isLoggedIn') === 'true';
        }

        function setLoggedIn(value) {
            localStorage.setItem('isLoggedIn', value ? 'true' : 'false');
        }

        function logout() {
            clearTimeout(sessionTimeoutId);
            setLoggedIn(false);
            if (salesLogInstance) salesLogInstance.stop();
            salesLogContainer.style.display = 'none';
            loginModal.style.display = 'block';
        }

        const loginTime = parseInt(localStorage.getItem('loginTime'), 10);
        if (isLoggedIn() && loginTime && (Date.now() - loginTime < LOGIN_TIMEOUT)) {
            salesLogContainer.style.display = 'block';
            loginModal.style.display = 'none';
            salesLogInstance = new SalesLog();
            const remainingTime = LOGIN_TIMEOUT - (Date.now() - loginTime);
            sessionTimeoutId = setTimeout(logout, remainingTime);
        } else {
            setLoggedIn(false);
            salesLogContainer.style.display = 'none';
            loginModal.style.display = 'block';
        }

        document.getElementById('loginBtn').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === adminUsername && password === adminPassword) {
                setLoggedIn(true);
                localStorage.setItem('loginTime', Date.now().toString());
                sessionTimeoutId = setTimeout(logout, LOGIN_TIMEOUT);
                loginModal.style.display = 'none';
                salesLogContainer.style.display = 'block';
                salesLogInstance = new SalesLog();
                errorMsg.textContent = '';
            } else {
                errorMsg.textContent = 'Invalid username or password';
            }
        });
    </script>
</body>
</html>
