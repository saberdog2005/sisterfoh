<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transaction Log</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 10px;
        }
        .container {
            display: flex;
            justify-content: space-between;
            max-width: 1200px;
            margin: 0 auto;
        }
        .left-column, .right-column {
            width: 48%;
        }
        #transactionList {
            max-height: 400px;
            overflow-y: scroll;
            background-color: #1e1e1e;
            padding: 10px;
            border-radius: 5px;
        }
        .transaction {
            margin-bottom: 5px;
        }
        .transaction.cash { color: #4caf50; }
        .transaction.cc-trans { color: #f44336; }
        .transaction.ticket { color: #2196f3; }
        .transaction.comp { color: #ff9800; }
        canvas {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-column">
            <canvas id="thruDoorChart"></canvas>
        </div>
        <div class="right-column">
            <div id="transactionList"></div>
        </div>
    </div>

    <script>
        let chart;
        let db;

        // Open IndexedDB
        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SalesDB', 2);
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // Fetch all transactions from IndexedDB
        async function fetchTransactions(db) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction('transactions', 'readonly');
                const store = tx.objectStore('transactions');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Render the top 20 transactions in the scrolling list
        function renderTransactionList(transactions) {
            const listContainer = document.getElementById('transactionList');
            listContainer.innerHTML = '';
            transactions.forEach(tx => {
                const item = document.createElement('div');
                item.className = `transaction ${tx.type.toLowerCase().replace(' ', '-')}`;
                item.textContent = `[${new Date(tx.timestamp).toLocaleString()}] ${tx.type}`;
                listContainer.appendChild(item);
            });
        }

        // Update the real-time graph with cumulative counts
        function updateGraph(transactions) {
            transactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const types = ['CASH', 'CC TRANS', 'TICKET', 'COMP'];
            const datasets = types.map(type => ({
                label: type,
                data: [],
                borderColor: getColor(type),
                fill: false
            }));
            const totalData = { label: 'Total', data: [], borderColor: '#ffff00', fill: false };
            let counts = { 'CASH': 0, 'CC TRANS': 0, 'TICKET': 0, 'COMP': 0, 'Total': 0 };

            transactions.forEach(tx => {
                if (types.includes(tx.type)) {
                    counts[tx.type]++;
                    datasets.find(ds => ds.label === tx.type).data.push({ x: tx.timestamp, y: counts[tx.type] });
                }
                counts.Total++;
                totalData.data.push({ x: tx.timestamp, y: counts.Total });
            });

            if (chart) {
                chart.data.datasets = [...datasets, totalData];
                chart.update();
            } else {
                const ctx = document.getElementById('thruDoorChart').getContext('2d');
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [...datasets, totalData]
                    },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'minute' },
                                title: { display: true, text: 'Time', color: '#e0e0e0' },
                                ticks: { color: '#e0e0e0' }
                            },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Count', color: '#e0e0e0' },
                                ticks: { color: '#e0e0e0' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#e0e0e0' } }
                        }
                    }
                });
            }
        }

        // Assign colors for transaction types and graph lines
        function getColor(type) {
            const colors = {
                'CASH': '#4caf50',     // Green
                'CC TRANS': '#f44336', // Red
                'TICKET': '#2196f3',   // Blue
                'COMP': '#ff9800'      // Orange
            };
            return colors[type] || 'gray';
        }

        // Update the display (graph and transaction list)
        async function updateDisplay() {
            try {
                const transactions = await fetchTransactions(db);
                transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                const top20 = transactions.slice(0, 20);
                renderTransactionList(top20);
                updateGraph(transactions);
            } catch (error) {
                console.error('Update failed:', error);
            }
        }

        // Initialize the page and set up real-time updates
        async function init() {
            db = await openDB();
            await updateDisplay();
            // Listen for new transactions via storage events
            window.addEventListener('storage', (event) => {
                if (event.key === 'transactionLogged') {
                    updateDisplay();
                }
            });
        }

        init().catch(error => console.error('Initialization failed:', error));
    </script>
</body>
</html>
