<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Sales Log</title>
 <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
 <script src="https://apis.google.com/js/api.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
 <style>
 body {
 font-family: Arial, sans-serif;
 margin: 0;
 padding: 20px;
 background-color: #121212;
 color: #e0e0e0;
 }
 .modal {
 display: none;
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background: rgba(0,0,0,0.5);
 justify-content: center;
 align-items: center;
 }
 .modal-content {
 background: #2c3e50;
 padding: 20px;
 border-radius: 8px;
 text-align: center;
 width: 300px;
 }
 .modal-content input {
 width: 80%;
 padding: 8px;
 margin: 5px 0;
 background: #34495e;
 color: #e0e0e0;
 border: 1px solid #bdc3c7;
 border-radius: 4px;
 }
 .log-container {
 background: #1e1e1e;
 padding: 20px;
 border-radius: 8px;
 box-shadow: 0 2px 5px rgba(0,0,0,0.3);
 margin-bottom: 20px;
 }
 .graph-container {
 max-width: 800px;
 margin: 0 auto;
 }
 .summary-grid {
 display: grid;
 grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
 gap: 10px;
 margin-top: 20px;
 }
 .summary-item.cash { background: #2e7d32; color: white; }
 .summary-item.card { background: #d32f2f; color: white; }
 .summary-item.comp { background: #ffa500; color: white; }
 .summary-item.tickets { background: #1a73e8; color: white; }
 .summary-item.total { background: #9c27b0; color: white; }
 .summary-item.door { background: #00bcd4; color: white; }
 .summary-item {
 padding: 10px;
 border-radius: 5px;
 text-align: center;
 }
 button, select {
 padding: 8px 16px;
 margin: 5px;
 border: none;
 border -radius: 4px;
 background: #4CAF50;
 color: white;
 cursor: pointer;
 }
 button:hover {
 background: #45a049;
 }
 select {
 background: #2196F3;
 }
 #logoutBtn {
 background: #e74c3c;
 color: white;
 border: none;
 padding: 8px 16px;
 cursor: pointer;
 margin-top: 10px;
 }
 </style>
</head>
<body>
 <div id="loginModal" class="modal">
 <div class="modal-content">
 <h2>Login</h2>
 <input type="text" id="username" placeholder="Username" required>
 <input type="password" id="password" placeholder="Password" required>
 <button id="loginBtn">Login</button>
 <button id="cancelBtn">Cancel</button>
 <div class="forgot-password">Forgot Password?</div>
 </div>
 </div>
 <div class="log-container graph-container" style="display: none;">
 <h2>Sales Over Time</h2>
 <canvas id="salesGraph"></canvas>
 </div>
 <div class="log-container" style="display: none;">
 <h2>Live Sales Summary</h2>
 <select id="sessionSelect"><option value="">Select a session</option></select>
 <button id="refreshBtn">Refresh</button>
 <label><input type="checkbox" id="autoRefresh"> Auto-Refresh (every 10s)</label>
 <div class="summary-grid" id="summaryGrid"></div>
 </div>
 <div class="log-container" style="display: none;">
 <h2>Transaction Log</h2>
 <div id="transactionLog"></div>
 <button id="logoutBtn">Logout</button>
 </div>
 <script>
 const SPREADSHEET_ID = '1dJ0NuByJCDgnIRKhsmKrWFyBtCHRgR7ujfGDRb9jhMY';
 const CLIENT_ID = '251850742586-mqcsongr4qc28peshpejmhd5iuiak835.apps.googleusercontent.com';
 const API_KEY = 'AIzaSyAS_wlduCCcRSDA3Hjt3hMPRg3olegY2Ic';
 const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

 let salesChart, autoRefreshInterval;

 function handleClientLoad() {
 gapi.load('client', initClient);
 }

 function initClient() {
 gapi.client.init({
 apiKey: API_KEY,
 discoveryDocs: DISCOVERY_DOCS
 }).then(() => {
 if (localStorage.getItem('adminLoggedIn') === 'true') {
 $('.log-container').show();
 const activeSessionId = localStorage.getItem('activeSessionId');
 if (activeSessionId) {
 loadSessions(activeSessionId);
 } else {
 loadSessions();
 }
 } else {
 $('#loginModal').show();
 }
 }, error => console.error('Error initializing client:', error));
 }

 function loadSessions(selectedSessionId = null) {
 gapi.client.sheets.spreadsheets.values.get({
 spreadsheetId: SPREADSHEET_ID,
 range: 'Sheet1!B2:B'
 }).then(response => {
 const sessionIds = [...new Set((response.result.values || []).flat())].filter(id => id);
 const select = $('#sessionSelect');
 select.html('<option value="">Select a session</option>' + sessionIds.map(id => `<option value="${id}">${id}</option>`).join(''));
 if (selectedSessionId && sessionIds.includes(selectedSessionId)) {
 select.val(selectedSessionId);
 updateLog(selectedSessionId);
 } else if (sessionIds.length > 0) {
 select.val(sessionIds[0]);
 updateLog(sessionIds[0]);
 }
 }, error => console.error('Error loading sessions:', error));
 }

 function updateLog(sessionId) {
 if (!sessionId) return;
 gapi.client.sheets.spreadsheets.values.get({
 spreadsheetId: SPREADSHEET_ID,
 range: 'Sheet1!A2:H'
 }).then(response => {
 const rows = response.result.values || [];
 const transactions = rows.filter(tr => tr[1] === sessionId && tr[0] === 'TRANSACTION');

 if (!transactions.length) {
 resetDisplay();
 return;
 }

 let cashSales = 0, cardSales = 0, compCount = 0, ticketCount = 0, totalSales = 0, totalDoorCount = 0, cumulativeTotal = 0;
 const doorData = { labels: [], cash: [], card: [], comp: [], tickets: [], total: [] };
 let cumulativeCash = 0, cumulativeCard = 0, cumulativeComp = 0, cumulativeTickets = 0;

 transactions.forEach((tr, index) => {
 const items = JSON.parse(tr[4] || '[]');
 items.forEach(item => {
 if (item.type === 'cash') {
 cashSales += item.price * item.quantity;
 cumulativeCash += item.quantity;
 } else if (item.type === 'card') {
 cardSales += item.price * item.quantity;
 cumulativeCard += item.quantity;
 } else if (item.type === 'comp') {
 compCount += item.quantity;
 cumulativeComp += item.quantity;
 } else if (item.type === 'ticket') {
 ticketCount += item.quantity;
 cumulativeTickets += item.quantity;
 }
 });
 totalSales += parseFloat(tr[5] || 0);
 totalDoorCount += parseInt(tr[7] || 0);
 cumulativeTotal += parseFloat(tr[5] || 0);

 doorData.labels.push(`T${index + 1}`);
 doorData.cash.push(cumulativeCash);
 doorData.card.push(cumulativeCard);
 doorData.comp.push(cumulativeComp);
 doorData.tickets.push(cumulativeTickets);
 doorData.total.push(cumulativeTotal);
 });

 $('#summaryGrid').html(`
 <div class="summary-item cash">Cash: $${cashSales.toFixed(2)}</div>
 <div class="summary-item card">Card: $${cardSales.toFixed(2)}</div>
 <div class="summary-item comp">Comp: ${compCount}</div>
 <div class="summary-item tickets">Tickets: ${ticketCount}</div>
 <div class="summary-item total">Total: $${totalSales.toFixed(2)}</div>
 <div class="summary-item door">Thru Door: ${totalDoorCount}</div>
 `);

 if (salesChart) salesChart.destroy();
 salesChart = new Chart(document.getElementById('salesGraph').getContext('2d'), {
 type: 'line',
 data: {
 labels: doorData.labels,
 datasets: [
 { label: 'Cash', data: doorData.cash, borderColor: '#2e7d32', fill: true },
 { label: 'Card', data: doorData.card, borderColor: '#d32f2f', fill: true },
 { label: 'Comp', data: doorData.comp, borderColor: '#ffa500', fill: true },
 { label: 'Tickets', data: doorData.tickets, borderColor: '#1a73e8', fill: true },
 { label: 'Total', data: doorData.total, borderColor: '#ffffff', fill: false } // White cumulative total
 ]
 },
 options: {
 responsive: true,
 scales: { y: { beginAtZero: true, title: { display: true, text: 'Cumulative Counts' } } }
 }
 });
 }, error => console.error('Error updating log:', error));
 }

 function resetDisplay() {
 $('#summaryGrid').empty().html('<div class="summary-item">No data available</div>');
 if (salesChart) salesChart.destroy();
 salesChart = null;
 }

 function toggleAutoRefresh() {
 const sessionId = $('#sessionSelect').val();
 if ($('#autoRefresh').is(':checked') && sessionId) {
 autoRefreshInterval = setInterval(() => updateLog(sessionId), 10000);
 } else {
 clearInterval(autoRefreshInterval);
 }
 }

 $(document).ready(() => {
 handleClientLoad();
 if (localStorage.getItem('adminLoggedIn') === 'true') {
 $('.log-container').show();
 }
 $('#loginBtn').on('click', () => {
 const user = $('#username').val().trim();
 const pass = $('#password').val().trim();
 if (user === 'admin' && pass === 'password123') {
 localStorage.setItem('adminLoggedIn', 'true');
 $('#loginModal').hide();
 $('.log-container').show();
 const activeSessionId = localStorage.getItem('activeSessionId');
 if (activeSessionId) {
 loadSessions(activeSessionId);
 } else {
 loadSessions();
 }
 } else {
 alert('Incorrect credentials');
 }
 });
 $('#cancelBtn').on('click', () => $('#username, #password').val(''));
 $('#logoutBtn').on('click', () => {
 localStorage.removeItem('adminLoggedIn');
 clearInterval(autoRefreshInterval);
 location.reload();
 });
 $('#refreshBtn').on('click', () => {
 const activeSessionId = localStorage.getItem('activeSessionId');
 if (activeSessionId) {
 $('#sessionSelect').val(activeSessionId);
 updateLog(activeSessionId);
 } else {
 updateLog($('#sessionSelect').val());
 }
 });
 $('#autoRefresh').on('change', toggleAutoRefresh);
 $('#sessionSelect').on('change', function() {
 const sessionId = $(this).val();
 if (sessionId) updateLog(sessionId);
 });
 });
 </script>
</body>
</html>
