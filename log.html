<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' https://code.jquery.com https://unpkg.com https://cdn.jsdelivr.net 'unsafe-inline'; object-src 'none';">
    <title>Sister Bar Log</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #1e1e2e;
            color: #e0e0e0;
            font-size: 16px;
        }
        select {
            padding: 5px;
            font-size: 16px;
            background-color: #2e2e2e;
            color: #e0e0e0;
            border: 1px solid #444;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background-color: #2e2e2e;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #444;
        }
        th {
            background-color: #3e3e4e;
        }
        .total-row {
            background-color: #3e3e4e;
            font-weight: bold;
        }
        #doorCountChart {
            max-height: 300px;
            background-color: #2e2e2e;
            padding: 10px;
            border-radius: 5px;
            margin-top: 20px;
        }
        #eventDateDisplay {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <select id="sessionSelect"></select>
    <div id="sessionInfo"></div>
    <div id="eventDateDisplay"></div>
    <h3>Summary</h3>
    <table>
        <thead>
            <tr>
                <th>Payment Type</th>
                <th>People</th>
                <th>Total</th>
                <th>Average</th>
            </tr>
        </thead>
        <tbody id="summaryBody"></tbody>
        <tbody id="totalsBody"></tbody>
    </table>
    <h3>Transaction Log</h3>
    <table>
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Items</th>
                <th>Cash Total</th>
                <th>Door Count</th>
                <th>Cashier</th>
                <th>Note</th>
            </tr>
        </thead>
        <tbody id="transactionLogBody"></tbody>
    </table>
    <div>Total Door Count: <span id="totalDoorCount">0</span></div>
    <div>Total Sales: $<span id="totalSales">0.00</span></div>
    <div>Total Transactions: <span id="totalTransactions">0</span></div>
    <canvas id="doorCountChart"></canvas>

    <script>
        const supabase = Supabase.createClient(
            'https://nnbevkohcjnzyxgkzgna.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uYmV2a29oY2puenl4Z2t6Z25hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5OTU5NTksImV4cCI6MjA1NzU3MTk1OX0.azv5XuUBxoyvr19-eGxnl37X7u0GOlCRj3L0jZ_8JHY'
        );
        let selectedSessionId = null;
        let chart = null;
        const channel = new BroadcastChannel('transaction_channel');

        function getColorForType(type) {
            switch (type.toLowerCase()) {
                case 'cash': return '#2e7d32';
                case 'credit card': return '#d32f2f';
                case 'comp': return '#ffa500';
                case 'ticket': return '#1a73e8';
                default: return '#808080';
            }
        }

        function colorCodeItems(items) {
            return items.split('; ').map(item => {
                const [type] = item.split(' ');
                const color = getColorForType(type);
                return `<span style="color: ${color}">${item}</span>`;
            }).join('; ');
        }

        async function updateLog() {
            try {
                const { data: allTransactions, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .order('sessionId', { ascending: false });
                if (error) throw new Error(`Error fetching transactions: ${error.message}`);

                const allSessionIds = [...new Set(allTransactions.map(t => t.sessionId))];
                const activeSessionId = localStorage.getItem('activeSessionId');
                if (!selectedSessionId && activeSessionId && allSessionIds.includes(activeSessionId)) {
                    selectedSessionId = activeSessionId;
                }
                const sessionSelect = document.getElementById('sessionSelect');
                sessionSelect.innerHTML = '<option value="">Select Cashier Session</option>' +
                    allSessionIds.map(id => {
                        const sessionTx = allTransactions.find(t => t.sessionId === id);
                        const cashier = sessionTx ? sessionTx.cashierName : 'Unknown';
                        const activeText = id === activeSessionId ? ' (Active)' : '';
                        const displayText = `${cashier} - ${id}${activeText}`;
                        return `<option value="${id}" ${id === selectedSessionId ? 'selected' : ''}>${displayText}</option>`;
                    }).join('');

                if (!selectedSessionId && allSessionIds.length > 0) selectedSessionId = allSessionIds[0];
                if (!selectedSessionId) {
                    document.getElementById('sessionInfo').innerHTML = '<p>No session available</p>';
                    document.getElementById('eventDateDisplay').innerHTML = '';
                    if (chart) {
                        chart.data.datasets = [];
                        chart.update();
                    }
                    document.getElementById('summaryBody').innerHTML = '';
                    document.getElementById('totalsBody').innerHTML = '';
                    document.getElementById('transactionLogBody').innerHTML = '';
                    document.getElementById('totalDoorCount').textContent = '0';
                    document.getElementById('totalSales').textContent = '0.00';
                    document.getElementById('totalTransactions').textContent = '0';
                    return;
                }

                const transactions = allTransactions.filter(t => t.sessionId.toString() === selectedSessionId.toString());
                this.transactions = transactions;
                sessionSelect.value = selectedSessionId;
                transactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                const eventName = transactions.length > 0 ? transactions[0].eventName : 'No Event';
                const eventDate = transactions.length > 0 ? transactions[0].eventDate : 'No Date';
                const uniqueCashiers = [...new Set(transactions.map(t => t.cashierName))];
                document.getElementById('sessionInfo').innerHTML = `<p>Event Name: ${eventName}</p><p>Cashier(s): ${uniqueCashiers.join(', ')}</p>`;
                document.getElementById('eventDateDisplay').innerHTML = `<p>Event Date: ${eventDate}</p>`;

                const itemSummary = {};
                let totalDoorCount = 0;
                let totalSales = 0;

                transactions.forEach(t => {
                    const items = t.items.split('; ');
                    items.forEach(item => {
                        const [key, value] = item.split(': ');
                        if (key && value) {
                            const [countStr, priceStr] = value.split(' @ ');
                            const count = parseInt(countStr, 10) || 0;
                            const price = priceStr ? parseFloat(priceStr.replace('$', '')) : 0;
                            if (!itemSummary[key]) itemSummary[key] = { people: 0, total: 0, price };
                            itemSummary[key].people += count;
                            itemSummary[key].total += count * price;
                            totalDoorCount += count;
                        }
                    });
                    totalSales += t.cashTotal || 0;
                });

                document.getElementById('totalDoorCount').textContent = totalDoorCount;
                document.getElementById('totalSales').textContent = totalSales.toFixed(2);
                document.getElementById('totalTransactions').textContent = transactions.length;

                const summaryRows = Object.entries(itemSummary)
                    .map(([key, data]) => `
                        <tr>
                            <td>${key}</td>
                            <td>${data.people}</td>
                            <td>$${data.total.toFixed(2)}</td>
                            <td>$${data.price.toFixed(2)}</td>
                        </tr>
                    `).join('');
                document.getElementById('summaryBody').innerHTML = summaryRows;

                const totalsRow = `
                    <tr class="total-row">
                        <td><strong>TOTALS</strong></td>
                        <td><strong>${totalDoorCount}</strong></td>
                        <td><strong>$${totalSales.toFixed(2)}</strong></td>
                        <td>${totalDoorCount ? (totalSales / totalDoorCount).toFixed(2) : '#DIV/0!'}</td>
                    </tr>
                `;
                document.getElementById('totalsBody').innerHTML = totalsRow;

                const transactionLogBody = document.getElementById('transactionLogBody');
                transactionLogBody.innerHTML = transactions.map(t => `
                    <tr>
                        <td>${new Date(t.timestamp).toLocaleString()}</td>
                        <td>${colorCodeItems(t.items)}</td>
                        <td>$${t.cashTotal.toFixed(2)}</td>
                        <td>${t.doorCount}</td>
                        <td>${t.cashierName}</td>
                        <td>${t.note || ''}</td>
                    </tr>
                `).join('');

                const types = ['Cash', 'Credit Card', 'Comp', 'Ticket'];
                const cumulative = {};
                types.forEach(type => cumulative[type] = 0);
                cumulative.total = 0;

                const dataPoints = {};
                types.forEach(type => dataPoints[type] = []);
                dataPoints.total = [];

                transactions.forEach(t => {
                    const items = t.items.split('; ');
                    items.forEach(item => {
                        const [key, value] = item.split(': ');
                        if (key && value) {
                            const [countStr] = value.split(' @ ');
                            const count = parseInt(countStr, 10) || 0;
                            let type;
                            if (key.startsWith('Cash')) type = 'Cash';
                            else if (key.startsWith('Credit Card')) type = 'Credit Card';
                            else if (key.startsWith('Comp')) type = 'Comp';
                            else if (key.startsWith('Ticket')) type = 'Ticket';
                            if (types.includes(type)) {
                                cumulative[type] += count;
                                cumulative.total += count;
                            }
                        }
                    });
                    const timestamp = new Date(t.timestamp);
                    types.forEach(type => {
                        dataPoints[type].push({ x: timestamp, y: cumulative[type] });
                    });
                    dataPoints.total.push({ x: timestamp, y: cumulative.total });
                });

                const datasets = types.map(type => ({
                    label: type,
                    data: dataPoints[type],
                    borderColor: getColorForType(type),
                    fill: false,
                    stepped: true
                }));
                datasets.push({
                    label: 'Total',
                    data: dataPoints.total,
                    borderColor: '#808080',
                    fill: false,
                    stepped: true
                }));

                if (chart) {
                    chart.data.datasets = datasets;
                    chart.update();
                } else {
                    chart = new Chart(document.getElementById('doorCountChart'), {
                        type: 'line',
                        data: { datasets },
                        options: {
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'time',
                                    time: { unit: 'minute' },
                                    title: { display: true, text: 'Time', font: { size: 16 } },
                                    ticks: { font: { size: 14 } }
                                },
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Door Count', font: { size: 16 } },
                                    ticks: { font: { size: 14 } }
                                }
                            },
                            plugins: {
                                legend: { labels: { font: { size: 14 } } }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error updating log:', error);
            }
        }

        document.getElementById('sessionSelect').addEventListener('change', (e) => {
            selectedSessionId = e.target.value;
            updateLog();
        });

        channel.onmessage = (event) => {
            if (event.data.type === 'transaction') {
                updateLog();
            }
        };

        document.addEventListener('DOMContentLoaded', updateLog);
    </script>
</body>
</html>
