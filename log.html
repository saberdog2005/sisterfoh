<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Log</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            width: 100%;
            max-width: none;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 5px;
        }
        h1 {
            color: #bb86fc;
            text-align: center;
        }
        h2 {
            color: #e0e0e0;
            text-align: center;
            margin-bottom: 10px;
        }
        h3 {
            color: #e0e0e0;
            text-align: center;
            margin: 5px 0;
        }
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-bottom: 20px;
        }
        .individual-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .individual-chart {
            position: relative;
            height: 200px;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        th {
            background-color: #2a2a2a;
        }
        tr:hover {
            background-color: #333;
        }
        #exportBtn {
            margin-top: 20px;
            padding: 10px 20px;
            background: #0288d1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #exportBtn:hover {
            background: #026aa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sales Log</h1>
        <h2 id="totalCount">Total Thru Door: 0</h2>
        <div class="chart-container">
            <canvas id="cumulativeChart"></canvas>
        </div>
        <div class="individual-charts">
            <div>
                <h3>CASH</h3>
                <div class="individual-chart">
                    <canvas id="cashChart"></canvas>
                </div>
            </div>
            <div>
                <h3>CC TRANS</h3>
                <div class="individual-chart">
                    <canvas id="ccChart"></canvas>
                </div>
            </div>
            <div>
                <h3>TICKET</h3>
                <div class="individual-chart">
                    <canvas id="ticketChart"></canvas>
                </div>
            </div>
            <div>
                <h3>COMP</h3>
                <div class="individual-chart">
                    <canvas id="compChart"></canvas>
                </div>
            </div>
        </div>
        <table id="transactionTable">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Session ID</th>
                    <th>Items</th>
                    <th>Cash Total</th>
                    <th>Thru Door</th>
                </tr>
            </thead>
            <tbody id="log"></tbody>
        </table>
        <button id="exportBtn">Export to PDF</button>
    </div>

    <script>
        let charts = {
            cumulative: null,
            cash: null,
            cc: null,
            ticket: null,
            comp: null
        };

        class SalesLog {
            constructor() {
                this.db = null;
                this.initDB()
                    .then(() => {
                        this.updateChart();
                        setInterval(() => this.updateChart(), 5000);
                    })
                    .catch((error) => console.error('Database initialization failed:', error));
                document.getElementById('exportBtn').addEventListener('click', () => this.exportPDF());
            }

            initDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('SalesDB', 2);
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        const oldVersion = event.oldVersion;
                        if (oldVersion < 1) {
                            if (!db.objectStoreNames.contains('transactions')) {
                                db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                            }
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };
                    request.onerror = (event) => {
                        reject(event.target.error);
                    };
                });
            }

            parseItems(itemsString) {
                const counts = { CASH: 0, 'CC TRANS': 0, TICKET: 0, COMP: 0 };
                const items = itemsString.split('; ');
                items.forEach((item) => {
                    const [keyPart, valuePart] = item.split(': ');
                    if (keyPart && valuePart) {
                        if (keyPart === 'CASH (CUSTOM)') {
                            const amounts = valuePart.split(', ');
                            counts.CASH += amounts.length;
                        } else {
                            const count = parseInt(valuePart.split(' @')[0], 10) || 0;
                            if (keyPart.startsWith('CASH')) {
                                counts.CASH += count;
                            } else if (keyPart === 'CC TRANS') {
                                counts['CC TRANS'] += count;
                            } else if (keyPart === 'TICKET') {
                                counts.TICKET += count;
                            } else if (keyPart === 'COMP') {
                                counts.COMP += count;
                            }
                        }
                    }
                });
                return counts;
            }

            updateChart() {
                const activeSessionId = localStorage.getItem('activeSessionId');
                if (!activeSessionId) {
                    Object.values(charts).forEach((chart) => {
                        if (chart) {
                            chart.data.datasets.forEach((dataset) => (dataset.data = []));
                            chart.update();
                        }
                    });
                    document.getElementById('totalCount').textContent = 'Total Thru Door: 0';
                    document.getElementById('log').innerHTML = '<tr><td colspan="5">No active session</td></tr>';
                    return;
                }
                const tx = this.db.transaction(['transactions'], 'readonly');
                const store = tx.objectStore('transactions');
                const request = store.getAll();
                request.onsuccess = () => {
                    const allTransactions = request.result;
                    const sessionTransactions = allTransactions.filter((t) => t.sessionId === activeSessionId);
                    sessionTransactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    let cumulative = { CASH: 0, 'CC TRANS': 0, TICKET: 0, COMP: 0, TOTAL: 0 };
                    let dataPoints = {
                        CASH: [],
                        'CC TRANS': [],
                        TICKET: [],
                        COMP: [],
                        TOTAL: []
                    };

                    sessionTransactions.forEach((transaction) => {
                        const counts = this.parseItems(transaction.items);
                        for (const type in counts) {
                            cumulative[type] += counts[type];
                            dataPoints[type].push({ x: transaction.timestamp, y: cumulative[type] });
                        }
                        cumulative.TOTAL += transaction.doorCount;
                        dataPoints.TOTAL.push({ x: transaction.timestamp, y: cumulative.TOTAL });
                    });

                    document.getElementById('totalCount').textContent = `Total Thru Door: ${cumulative.TOTAL}`;

                    // Update cumulative chart
                    if (!charts.cumulative) {
                        charts.cumulative = new Chart(document.getElementById('cumulativeChart'), {
                            type: 'line',
                            data: {
                                datasets: [
                                    { label: 'CASH', data: dataPoints.CASH, borderColor: 'green', backgroundColor: 'rgba(0, 255, 0, 0.1)', fill: false },
                                    { label: 'CC TRANS', data: dataPoints['CC TRANS'], borderColor: 'red', backgroundColor: 'rgba(255, 0, 0, 0.1)', fill: false },
                                    { label: 'TICKET', data: dataPoints.TICKET, borderColor: 'blue', backgroundColor: 'rgba(0, 0, 255, 0.1)', fill: false },
                                    { label: 'COMP', data: dataPoints.COMP, borderColor: 'orange', backgroundColor: 'rgba(255, 165, 0, 0.1)', fill: false },
                                    { label: 'Total Thru Door', data: dataPoints.TOTAL, borderColor: 'purple', backgroundColor: 'rgba(128, 0, 128, 0.1)', fill: false }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: { type: 'time', time: { unit: 'minute' }, title: { display: true, text: 'Time' } },
                                    y: { beginAtZero: true, title: { display: true, text: 'Count' } }
                                },
                                plugins: { legend: { display: true } }
                            }
                        });
                    } else {
                        charts.cumulative.data.datasets[0].data = dataPoints.CASH;
                        charts.cumulative.data.datasets[1].data = dataPoints['CC TRANS'];
                        charts.cumulative.data.datasets[2].data = dataPoints.TICKET;
                        charts.cumulative.data.datasets[3].data = dataPoints.COMP;
                        charts.cumulative.data.datasets[4].data = dataPoints.TOTAL;
                        charts.cumulative.update();
                    }

                    // Update individual charts
                    const types = ['CASH', 'CC TRANS', 'TICKET', 'COMP'];
                    types.forEach((type) => {
                        const chartId = type.toLowerCase().replace(' ', '') + 'Chart';
                        if (!charts[chartId]) {
                            charts[chartId] = new Chart(document.getElementById(chartId), {
                                type: 'line',
                                data: {
                                    datasets: [{
                                        label: type,
                                        data: dataPoints[type],
                                        borderColor: type === 'CASH' ? 'green' : type === 'CC TRANS' ? 'red' : type === 'TICKET' ? 'blue' : 'orange',
                                        backgroundColor: type === 'CASH' ? 'rgba(0, 255, 0, 0.1)' : type === 'CC TRANS' ? 'rgba(255, 0, 0, 0.1)' : type === 'TICKET' ? 'rgba(0, 0, 255, 0.1)' : 'rgba(255, 165, 0, 0.1)',
                                        fill: false
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        x: { type: 'time', time: { unit: 'minute' }, title: { display: true, text: 'Time' } },
                                        y: { beginAtZero: true, title: { display: true, text: 'Count' } }
                                    },
                                    plugins: { legend: { display: false } }
                                }
                            });
                        } else {
                            charts[chartId].data.datasets[0].data = dataPoints[type];
                            charts[chartId].update();
                        }
                    });

                    this.displayLog(sessionTransactions);
                };
                request.onerror = (event) => console.error('Error fetching transactions:', event.target.error);
            }

            displayLog(transactions) {
                const log = document.getElementById('log');
                log.innerHTML = transactions.map(t => {
                    return `
                        <tr>
                            <td>${new Date(t.timestamp).toLocaleString()}</td>
                            <td>${t.sessionId}</td>
                            <td>${t.items}</td>
                            <td>$${t.cashTotal.toFixed(2)}</td>
                            <td>${t.doorCount}</td>
                        </tr>
                    `;
                }).join('');
            }

            async exportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 10;

                // Total Thru Door
                const totalThruDoor = document.getElementById('totalCount').textContent;
                doc.text(totalThruDoor, 10, y);
                y += 10;

                // Cumulative Chart
                const cumulativeCanvas = document.getElementById('cumulativeChart');
                const cumulativeImg = await html2canvas(cumulativeCanvas);
                const cumulativeData = cumulativeImg.toDataURL('image/png');
                doc.addImage(cumulativeData, 'PNG', 10, y, 180, 90);
                y += 100;

                // Individual Charts
                const individualCharts = ['cashChart', 'ccChart', 'ticketChart', 'compChart'];
                for (const chartId of individualCharts) {
                    const chartCanvas = document.getElementById(chartId);
                    const chartImg = await html2canvas(chartCanvas);
                    const chartData = chartImg.toDataURL('image/png');
                    doc.addImage(chartData, 'PNG', 10, y, 90, 45);
                    y += 50;
                    if (y > 250) {
                        doc.addPage();
                        y = 10;
                    }
                }

                // Transaction Table
                const table = document.getElementById('transactionTable');
                const tableCanvas = await html2canvas(table);
                const tableData = tableCanvas.toDataURL('image/png');
                doc.addImage(tableData, 'PNG', 10, y, 180, 0);

                doc.save('sales_log.pdf');
            }
        }

        new SalesLog();
    </script>
</body>
</html>
