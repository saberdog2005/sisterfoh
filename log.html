<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log</title>
    <!-- Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- jQuery for DOM manipulation -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Google Sign-In and Sheets API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <!-- Chart.js for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-3">
        <!-- Session selection dropdown -->
        <select id="sessionSelect" class="form-select mb-3">
            <option value="">Select Session</option>
        </select>
        <!-- Current Transaction section -->
        <div class="log-container">
            <h2>Current Transaction</h2>
            <ul id="currentTransactionList" class="list-group mb-3"></ul>
        </div>
        <!-- Completed Transactions section -->
        <div class="log-container">
            <h2>Completed Transactions</h2>
            <div id="summary"></div>
            <canvas id="doorChart" height="100"></canvas>
        </div>
    </div>

    <script>
        // Configuration constants (replace with your own if needed)
        const CLIENT_ID = '251850742586-mqcsongr4qc28peshpejmhd5iuiak835.apps.google.com';
        const API_KEY = 'AIzaSyAS_wlduCCcRSDA3Hjt3hMPRg3olegY2Ic';
        const SPREADSHEET_ID = '1dJ0NuByJCDgnIRKhsmKrWFyBtCHRgR7ujfGDRb9jhMY';
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPE = 'https://www.googleapis.com/auth/spreadsheets.readonly';

        let updateInterval; // To manage the 3-second updates
        let doorChart; // Global reference to the chart instance

        // Update the Current Transaction display from localStorage
        function updateCurrentTransactionDisplay(itemsJson) {
            const items = JSON.parse(itemsJson || '{}');
            const list = $('#currentTransactionList').empty();
            for (const [item, quantity] of Object.entries(items)) {
                list.append(`<li class="list-group-item">${item}: ${quantity}</li>`);
            }
        }

        // Listen for localStorage changes to update Current Transaction in real-time
        window.addEventListener('storage', (e) => {
            if (e.key === 'currentTransaction') {
                updateCurrentTransactionDisplay(e.newValue);
            }
        });

        // Fetch and update the log for the selected session
        function updateLog(sessionId) {
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Sheet1!A2:K' // Adjust range based on your sheet structure
            }).then(response => {
                const rows = response.result.values || [];
                const sessionRows = rows.filter(row => row[1] === sessionId);

                // Group data into transactions
                const transactions = {};
                sessionRows.forEach(row => {
                    if (row[0] === 'TRANSACTION') {
                        transactions[row[2]] = { // Assuming column C (index 2) is transaction ID
                            timestamp: row[3],
                            cashier: row[1], // Session ID also used as cashier for simplicity
                            total: row[4],
                            note: row[5] || 'No note',
                            items: []
                        };
                    } else if (row[0] === 'ITEM' && transactions[row[2]]) {
                        transactions[row[2]].items.push({
                            type: row[6],
                            item: row[7],
                            quantity: row[8],
                            price: row[9],
                            itemTotal: row[10]
                        });
                    }
                });

                // Display completed transactions
                const summary = $('#summary').empty();
                Object.values(transactions).forEach(t => {
                    const itemList = t.items.map(i => `${i.item} x${i.quantity}`).join(', ');
                    summary.append(
                        `<p>${t.timestamp} - ${t.cashier}: ${itemList} - $${t.total} - ${t.note}</p>`
                    );
                });

                // Prepare data for the graph (cumulative door count)
                const doorData = { labels: [], values: [] };
                let cumulativeDoorCount = 0;
                Object.values(transactions)
                    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp))
                    .forEach(t => {
                        cumulativeDoorCount += t.items
                            .filter(i => i.type === 'ticket') // Adjust based on your data
                            .reduce((sum, i) => sum + parseInt(i.quantity), 0);
                        doorData.labels.push(t.timestamp);
                        doorData.values.push(cumulativeDoorCount);
                    });
                updateChart(doorData);
            }).catch(err => {
                console.error('Error fetching sheet data:', err);
                $('#summary').html('<p>Error loading data. Please try again.</p>');
            });
        }

        // Update the Chart.js graph
        function updateChart(data) {
            const ctx = $('#doorChart')[0].getContext('2d');
            if (doorChart) doorChart.destroy(); // Destroy existing chart to prevent overlap
            doorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Cumulative Door Count',
                        data: data.values,
                        borderColor: 'blue',
                        fill: false
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        // Initialize the page
        $(document).ready(() => {
            // Load Google API client and authenticate
            gapi.load('client:auth2', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    clientId: CLIENT_ID,
                    discoveryDocs: DISCOVERY_DOCS,
                    scope: SCOPE
                }).then(() => {
                    gapi.auth2.getAuthInstance().signIn().then(() => {
                        // Populate session dropdown
                        gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: SPREADSHEET_ID,
                            range: 'Sheet1!B2:B' // Assuming session IDs are in column B
                        }).then(response => {
                            const values = response.result.values || [];
                            const sessions = [...new Set(values.map(row => row[0]))];
                            const select = $('#sessionSelect');
                            sessions.forEach(s => {
                                select.append(`<option value="${s}">${s}</option>`);
                            });
                        }).catch(err => {
                            console.error('Error fetching sessions:', err);
                            $('#sessionSelect').after('<p>Error loading sessions.</p>');
                        });
                    }).catch(err => {
                        console.error('Sign-in failed:', err);
                        $('body').prepend('<p>Please sign in to access the log.</p>');
                    });
                });
            });

            // Load initial Current Transaction from localStorage
            const currentTransaction = localStorage.getItem('currentTransaction');
            if (currentTransaction) updateCurrentTransactionDisplay(currentTransaction);

            // Handle session selection and live updates
            $('#sessionSelect').on('change', function() {
                const sessionId = $(this).val();
                if (sessionId) {
                    updateLog(sessionId);
                    clearInterval(updateInterval);
                    updateInterval = setInterval(() => updateLog(sessionId), 3000);
                } else {
                    clearInterval(updateInterval);
                    $('#summary').empty();
                    if (doorChart) doorChart.destroy();
                }
            });
        });
    </script>
</body>
</html>
