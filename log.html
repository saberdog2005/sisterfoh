<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Transaction Log</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        table { border-collapse: collapse; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <canvas id="doorCountChart"></canvas>
    <div id="summaryTables"></div>
    <div>Total Door Count: <span id="totalDoorCount">0</span></div>

    <script>
        const supabase = Supabase.createClient('YOUR_SUPABASE_URL', 'YOUR_SUPABASE_KEY');
        let chart;

        const typeMapping = {
            'Cash $5': 'Cash',
            'Cash $7': 'Cash',
            'Cash $10': 'Cash',
            'Cash $12': 'Cash',
            'Cash $15': 'Cash',
            'Cash $20': 'Cash',
            'Credit Card': 'Card',
            'Tickets': 'Ticket',
            'Comps': 'Comp'
        };

        const generalTypes = ['Cash', 'Card', 'Ticket', 'Comp'];

        const typeColors = {
            'Cash': '#2e7d32',
            'Card': '#d32f2f',
            'Ticket': '#1a73e8',
            'Comp': '#ffa500',
            'Total': '#800080'
        };

        async function updateLog() {
            const { data: transactions, error } = await supabase
                .from('transactions')
                .select('*')
                .order('timestamp', { ascending: true });

            if (error) {
                console.error('Error fetching transactions:', error);
                return;
            }

            transactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            const cumulativeCounts = {};
            generalTypes.forEach(type => cumulativeCounts[type] = 0);
            cumulativeCounts['Total'] = 0;

            const datasets = generalTypes.map(type => ({
                label: type,
                data: [],
                borderColor: typeColors[type],
                fill: false
            }));
            datasets.push({
                label: 'Total',
                data: [],
                borderColor: typeColors['Total'],
                fill: false
            });

            transactions.forEach(t => {
                const typeCounts = {};
                generalTypes.forEach(type => typeCounts[type] = 0);

                const items = t.items.split('; ').filter(item => item);
                items.forEach(item => {
                    const [key, value] = item.split(': ');
                    if (key && value) {
                        const generalType = typeMapping[key] || 'Other';
                        if (generalTypes.includes(generalType)) {
                            const count = parseInt(value.split(' @ ')[0], 10) || 0;
                            typeCounts[generalType] += count;
                        }
                    }
                });

                generalTypes.forEach(type => {
                    cumulativeCounts[type] += typeCounts[type];
                    datasets.find(d => d.label === type).data.push({
                        x: t.timestamp,
                        y: cumulativeCounts[type]
                    });
                });

                cumulativeCounts['Total'] += t.doorCount;
                datasets.find(d => d.label === 'Total').data.push({
                    x: t.timestamp,
                    y: cumulativeCounts['Total']
                });
            });

            if (chart) {
                chart.data.datasets = datasets;
                chart.update();
            } else {
                chart = new Chart(document.getElementById('doorCountChart'), {
                    type: 'line',
                    data: { datasets },
                    options: {
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'minute' },
                                title: { display: true, text: 'Time' }
                            },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Count' }
                            }
                        },
                        plugins: {
                            legend: { display: true }
                        }
                    }
                });
            }

            const summary = {};
            let totalDoorCount = 0;
            transactions.forEach(t => {
                if (!summary[t.cashier]) {
                    summary[t.cashier] = { items: {}, total: 0, people: 0 };
                }
                const itemSummary = summary[t.cashier].items;
                const items = t.items.split('; ').filter(item => item);
                items.forEach(item => {
                    const [key, value] = item.split(': ');
                    if (key && value) {
                        const [countStr, priceStr] = value.split(' @ ');
                        const count = parseInt(countStr, 10) || 0;
                        const price = priceStr ? parseFloat(priceStr.replace('$', '')) || 0 : 0;
                        if (!itemSummary[key]) {
                            itemSummary[key] = { people: 0, total: 0, price };
                        }
                        itemSummary[key].people += count;
                        itemSummary[key].total += count * price;
                    }
                });
                summary[t.cashier].total += t.total;
                summary[t.cashier].people += t.doorCount;
                totalDoorCount += t.doorCount;
            });

            let html = '<table><tr><th>Cashier</th><th>Item</th><th>People</th><th>Total</th></tr>';
            for (const [cashier, data] of Object.entries(summary)) {
                for (const [item, itemData] of Object.entries(data.items)) {
                    html += `<tr><td>${cashier}</td><td>${item}</td><td>${itemData.people}</td><td>$${itemData.total.toFixed(2)}</td></tr>`;
                }
                html += `<tr><td>${cashier} Total</td><td></td><td>${data.people}</td><td>$${data.total.toFixed(2)}</td></tr>`;
            }
            html += `<tr><td><strong>Total</strong></td><td></td><td>${totalDoorCount}</td><td></td></tr></table>`;
            document.getElementById('summaryTables').innerHTML = html;

            document.getElementById('totalDoorCount').textContent = totalDoorCount;
        }

        // Initial call and real-time subscription
        updateLog();
        supabase
            .channel('transactions')
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'transactions' }, payload => {
                updateLog();
            })
            .subscribe();
    </script>
</body>
</html>
