<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Log</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body{font-family:Arial,sans-serif;background:#1e1e1e;color:#e0e0e0;margin:0;padding:20px;display:flex;flex-direction:column;min-height:100vh;overflow:hidden}
        .grid-container{display:grid;grid-template-columns:1fr 1fr;grid-template-rows:1fr 1fr;gap:20px;flex-grow:1;width:100%;max-height:calc(100vh-60px);overflow:auto}
        .log-container{background:#2d2d2d;padding:15px;border-radius:5px;display:flex;flex-direction:column;box-shadow:0 2px 5px rgba(0,0,0,.3);overflow-y:auto}
        .table-wrapper{overflow-y:auto;flex-grow:1}
        select,button{padding:8px;font-size:14px;margin:5px 0;border-radius:4px;background:#3c3c3c;border:1px solid #555;color:#e0e0e0}
        .graph-container{flex-grow:1;position:relative;width:100%}
        canvas{width:100%!important;height:100%!important}
        table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
        th,td{padding:10px;text-align:left;border-bottom:1px solid #444}
        th{background:#3d3d3d;font-weight:bold}
        #transactionTable td:nth-child(1){width:15%}
        #transactionTable td:nth-child(2){width:50%;word-wrap:break-word}
        #transactionTable td:nth-child(3){width:15%}
        #transactionTable td:nth-child(4){width:20%;word-wrap:break-word}
        .item-cash{color:#2e7d32}
        .item-cc{color:#d32f2f}
        .item-ticket{color:#1a73e8}
        .item-comp{color:#ffa500}
        .summary-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;flex-grow:1}
        .summary-value{font-weight:bold}
        #grandTotal{font-size:18px;font-weight:bold;margin-top:10px;color:#e0e0e0}
    </style>
</head>
<body>
    <div class="grid-container">
        <div class="log-container">
            <h2>Select Session</h2>
            <select id="sessionSelect">
                <option value="">Select a session</option>
            </select>
        </div>
        <div class="log-container">
            <h2>Sales Summary</h2>
            <div class="summary-grid">
                <p>CASH: $<span class="summary-value" id="cashSales">0.00</span></p>
                <p>CARD: $<span class="summary-value" id="cardSales">0.00</span></p>
                <p>COMP: $<span class="summary-value" id="compSales">0.00</span></p>
                <p>Tickets: $<span class="summary-value" id="ticketSales">0.00</span></p>
                <p>TOTAL IN: $<span class="summary-value" id="totalIn">0.00</span></p>
            </div>
        </div>
        <div class="log-container">
            <h2>Sales Over Time</h2>
            <div class="graph-container">
                <canvas id="transactionGraph"></canvas>
            </div>
        </div>
        <div class="log-container">
            <h2>Transaction Log</h2>
            <div class="table-wrapper">
                <table id="transactionTable">
                    <thead><tr><th>Time</th><th>Items</th><th>Total</th><th>Note</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="grandTotal">Total Sales: $0.00</div>
        </div>
    </div>
    <script>
        let db, transactionChart;
        $(document).ready(() => {
            const request = indexedDB.open('SalesDB', 2);
            request.onupgradeneeded = e => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('sessions')) db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
                if (!db.objectStoreNames.contains('transactions')) db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true }).createIndex('sessionId', 'sessionId', { unique: false });
            };
            request.onsuccess = e => { db = e.target.result; loadSessions(); };
            $('#sessionSelect').on('change', function() { updateLog($(this).val()); });
        });
        function loadSessions() {
            const tx = db.transaction(['sessions'], 'readonly');
            const store = tx.objectStore('sessions');
            store.getAll().onsuccess = e => {
                const sessions = e.target.result;
                const $select = $('#sessionSelect');
                $select.empty().append('<option value="">Select a session</option>');
                sessions.forEach(s => $select.append(`<option value="${s.id}">${s.date} - ${s.venue} - ${s.eventName} - ${s.cashier}${s.status === 'open' ? ' (Current)' : ''}</option>`));
            };
        }
        function updateLog(sessionId) {
            if (!sessionId) return resetDisplay();
            const tx = db.transaction(['transactions'], 'readonly');
            const store = tx.objectStore('transactions');
            const index = store.index('sessionId');
            index.getAll(Number(sessionId)).onsuccess = e => {
                const transactions = e.target.result.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                let cashTotal = 0, cardTotal = 0, compTotal = 0, ticketTotal = 0, totalIn = 0;
                const cashData = [], cardData = [], compData = [], ticketData = [];
                transactions.forEach(t => {
                    t.itemList.forEach(item => {
                        const value = item.price * item.quantity;
                        if (item.type === 'CASH') cashTotal += value;
                        else if (item.type === 'CARD') cardTotal += value;
                        else if (item.type === 'COMP') compTotal += value;
                        else if (item.type === 'Tickets') ticketTotal += value;
                    });
                    totalIn += t.total;
                    cashData.push({ x: new Date(t.timestamp), y: cashTotal });
                    cardData.push({ x: new Date(t.timestamp), y: cardTotal });
                    compData.push({ x: new Date(t.timestamp), y: compTotal });
                    ticketData.push({ x: new Date(t.timestamp), y: ticketTotal });
                });
                $('#cashSales').text(cashTotal.toFixed(2));
                $('#cardSales').text(cardTotal.toFixed(2));
                $('#compSales').text(compTotal.toFixed(2));
                $('#ticketSales').text(ticketTotal.toFixed(2));
                $('#totalIn').text(totalIn.toFixed(2));
                updateGraph(cashData, cardData, compData, ticketData);
                const $tbody = $('#transactionTable tbody').empty();
                transactions.forEach(t => {
                    const itemsHtml = t.itemList.map(i => `<span class="item-${i.type.toLowerCase()}">${i.item} (${i.quantity})</span>`).join(', ');
                    $tbody.append(`<tr><td>${t.time}</td><td>${itemsHtml}</td><td>$${t.total.toFixed(2)}</td><td>${t.note || ''}</td></tr>`);
                });
                $('#grandTotal').text(`Total Sales: $${totalIn.toFixed(2)}`);
            };
        }
        function resetDisplay() {
            $('#cashSales, #cardSales, #compSales, #ticketSales, #totalIn').text('0.00');
            if (transactionChart) transactionChart.data.datasets.forEach(d => d.data = []);
            $('#transactionTable tbody').empty();
            $('#grandTotal').text('Total Sales: $0.00');
        }
        function updateGraph(cashData, cardData, compData, ticketData) {
            const ctx = document.getElementById('transactionGraph').getContext('2d');
            if (!transactionChart) {
                transactionChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [
                            { label: 'CASH', data: cashData, borderColor: '#2e7d32', fill: false },
                            { label: 'CARD', data: cardData, borderColor: '#d32f2f', fill: false },
                            { label: 'COMP', data: compData, borderColor: '#ffa500', fill: false },
                            { label: 'Tickets', data: ticketData, borderColor: '#1a73e8', fill: false }
                        ]
                    },
                    options: { scales: { x: { type: 'time', time: { unit: 'minute' } }, y: { beginAtZero: true } } }
                });
            } else {
                transactionChart.data.datasets[0].data = cashData;
                transactionChart.data.datasets[1].data = cardData;
                transactionChart.data.datasets[2].data = compData;
                transactionChart.data.datasets[3].data = ticketData;
                transactionChart.update();
            }
        }
    </script>
</body>
</html>
