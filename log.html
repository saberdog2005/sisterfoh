<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Log</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container mt-3">
        <select id="sessionSelect" class="form-select mb-3"></select>
        <div class="log-container">
            <h2>Current Transaction</h2>
            <ul id="currentTransactionList" class="list-group mb-3"></ul>
        </div>
        <div class="log-container">
            <h2>Completed Transactions</h2>
            <div id="summary"></div>
            <canvas id="doorChart" height="100"></canvas>
        </div>
    </div>
    <script>
        const CLIENT_ID = '251850742586-mqcsongr4qc28peshpejmhd5iuiak835.apps.google.com';
        const API_KEY = 'AIzaSyAS_wlduCCcRSDA3Hjt3hMPRg3olegY2Ic';
        const SPREADSHEET_ID = '1dJ0NuByJCDgnIRKhsmKrWFyBtCHRgR7ujfGDRb9jhMY';
        const SCOPE = 'https://www.googleapis.com/auth/spreadsheets';

        function updateCurrentTransactionDisplay(itemsJson) {
            const items = JSON.parse(itemsJson || '{}');
            const list = $('#currentTransactionList').empty();
            for (const [item, quantity] of Object.entries(items)) {
                list.append(`<li class="list-group-item">${item}: ${quantity}</li>`);
            }
        }

        window.addEventListener('storage', (e) => {
            if (e.key === 'currentTransaction') {
                updateCurrentTransactionDisplay(e.newValue);
            }
        });

        function updateLog(sessionId) {
            if (!sessionId) return;
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: 'Sheet1!A2:K'
            }).then(response => {
                const rows = response.result.values || [];
                const sessionRows = rows.filter(tr => tr[1] === sessionId || tr[2] === sessionId);

                const transactions = {};
                const items = [];
                sessionRows.forEach(row => {
                    if (row[0] === 'TRANSACTION') {
                        transactions[row[2]] = { cashier: row[1], timestamp: row[3], total: row[4], note: row[5] };
                    } else if (row[0] === 'ITEM') {
                        items.push({ transactionId: row[2], type: row[6], item: row[7], quantity: parseInt(row[8]), price: parseFloat(row[9]), itemTotal: parseFloat(row[10]) });
                    }
                });

                // Display completed transactions
                const summary = $('#summary').empty();
                Object.entries(transactions).forEach(([tid, t]) => {
                    const tItems = items.filter(i => i.transactionId === tid);
                    const itemList = tItems.map(i => `${i.item} (${i.quantity})`).join(', ');
                    summary.append(`<p>${t.timestamp} - ${t.cashier}: ${itemList} - $${t.total} - ${t.note || 'No note'}</p>`);
                });

                // Update chart
                const sortedItems = items.map(item => ({
                    ...item,
                    timestamp: transactions[item.transactionId].timestamp
                })).sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                const doorData = { labels: [], cash: [], card: [], comp: [], tickets: [] };
                let cumulativeCash = 0, cumulativeCard = 0, cumulativeComp = 0, cumulativeTickets = 0;
                let currentTime = null;
                sortedItems.forEach(item => {
                    const time = new Date(item.timestamp).toLocaleTimeString();
                    if (time !== currentTime) {
                        if (currentTime) {
                            doorData.labels.push(currentTime);
                            doorData.cash.push(cumulativeCash);
                            doorData.card.push(cumulativeCard);
                            doorData.comp.push(cumulativeComp);
                            doorData.tickets.push(cumulativeTickets);
                        }
                        currentTime = time;
                    }
                    if (item.type === 'cash') cumulativeCash += item.quantity;
                    else if (item.type === 'card') cumulativeCard += item.quantity;
                    else if (item.type === 'comp') cumulativeComp += item.quantity;
                    else if (item.type === 'ticket') cumulativeTickets += item.quantity;
                });
                if (currentTime) {
                    doorData.labels.push(currentTime);
                    doorData.cash.push(cumulativeCash);
                    doorData.card.push(cumulativeCard);
                    doorData.comp.push(cumulativeComp);
                    doorData.tickets.push(cumulativeTickets);
                }
                updateChart(doorData);
            });
        }

        function updateChart(data) {
            const ctx = $('#doorChart')[0].getContext('2d');
            if (window.doorChart) window.doorChart.destroy(); // Destroy previous chart instance
            window.doorChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [
                        { label: 'Cash', data: data.cash, borderColor: 'blue', fill: false },
                        { label: 'Card', data: data.card, borderColor: 'green', fill: false },
                        { label: 'Comp', data: data.comp, borderColor: 'red', fill: false },
                        { label: 'Tickets', data: data.tickets, borderColor: 'purple', fill: false }
                    ]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        $(document).ready(() => {
            gapi.load('client:auth2', () => {
                gapi.client.init({ apiKey: API_KEY, clientId: CLIENT_ID, scope: SCOPE })
                    .then(() => gapi.auth2.getAuthInstance().signIn())
                    .then(() => gapi.client.load('sheets', 'v4'))
                    .then(() => {
                        gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: SPREADSHEET_ID,
                            range: 'Sheet1!A2:B'
                        }).then(response => {
                            const rows = response.result.values || [];
                            const sessions = [...new Set(rows.filter(r => r[0] === 'SALES OPEN').map(r => r[1]))];
                            const select = $('#sessionSelect').empty().append('<option value="">Select Session</option>');
                            sessions.forEach(s => select.append(`<option value="${s}">${s}</option>`));
                            select.on('change', () => updateLog(select.val()));
                        });
                    });
            });

            const currentTransaction = localStorage.getItem('currentTransaction');
            if (currentTransaction) updateCurrentTransactionDisplay(currentTransaction);
        });
    </script>
</body>
</html>
