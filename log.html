<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        #buttonList li { margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginForm">
            <h1 class="my-4">Admin Login</h1>
            <input type="text" id="username" class="form-control my-2" placeholder="Username">
            <input type="password" id="password" class="form-control my-2" placeholder="Password">
            <button id="loginBtn" class="btn btn-primary">Log In</button>
            <p id="loginError" style="color: red; display: none;">Failed log in, try again!</p>
        </div>
        <div id="mainContent" style="display: none;">
            <h1 class="my-4">Sales Log</h1>
            <button id="logoutBtn" class="btn btn-danger mb-3">Log Out</button>
            <select id="sessionSelect" class="form-select mb-3"></select>
            <div id="salesSummary" class="mb-3">
                <p>Total Sales: $<span id="totalSales">0</span></p>
                <p>Thru Door: <span id="doorCount">0</span></p>
            </div>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Items</th>
                        <th>Total</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody id="transactionLog"></tbody>
            </table>
            <div id="buttonVisibilitySection">
                <h2>Button Visibility</h2>
                <ul id="buttonList" class="list-unstyled"></ul>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let db;

        $(document).ready(() => {
            const request = indexedDB.open('SalesDB', 2);
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains('sessions')) {
                    db.createObjectStore('sessions', { keyPath: 'id', autoIncrement: true });
                }
                if (!db.objectStoreNames.contains('transactions')) {
                    const transactionStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                    transactionStore.createIndex('sessionId', 'sessionId', { unique: false });
                }
                if (!db.objectStoreNames.contains('permissions')) {
                    db.createObjectStore('permissions', { keyPath: 'username' });
                }
                if (!db.objectStoreNames.contains('buttonVisibility')) {
                    db.createObjectStore('buttonVisibility', { keyPath: 'item' });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                if (localStorage.getItem('isAdminLoggedIn') === 'true') {
                    $('#mainContent').show();
                    loadSessions();
                    loadButtonVisibility();
                } else {
                    $('#loginForm').show();
                }
            };

            request.onerror = () => alert('Failed to open database.');

            $('#loginBtn').on('click', () => {
                const username = $('#username').val().trim();
                const password = $('#password').val().trim();
                const tx = db.transaction(['permissions'], 'readonly');
                const store = tx.objectStore('permissions');
                const request = store.get(username);
                request.onsuccess = (event) => {
                    const user = event.target.result;
                    if (user && user.password === password) {
                        localStorage.setItem('isAdminLoggedIn', 'true');
                        $('#loginForm').hide();
                        $('#mainContent').show();
                        loadSessions();
                        loadButtonVisibility();
                    } else {
                        $('#loginError').show();
                    }
                };
            });

            $('#logoutBtn').on('click', () => {
                localStorage.setItem('isAdminLoggedIn', 'false');
                $('#mainContent').hide();
                $('#loginForm').show();
            });

            $('#sessionSelect').on('change', () => updateLog());
        });

        function loadSessions() {
            const tx = db.transaction('sessions', 'readonly');
            const store = tx.objectStore('sessions');
            const request = store.getAll();
            request.onsuccess = (event) => {
                const sessions = event.target.result;
                const $select = $('#sessionSelect').empty();
                $select.append('<option value="">Select a session</option>');
                sessions.forEach(session => {
                    const status = session.endTime ? 'Closed' : 'Open';
                    $select.append(`<option value="${session.id}">${session.cashier} - ${status}</option>`);
                });
            };
        }

        function updateLog() {
            const sessionId = parseInt($('#sessionSelect').val());
            if (!sessionId) {
                $('#salesSummary').hide();
                $('#transactionLog').empty();
                return;
            }
            const tx = db.transaction('transactions', 'readonly');
            const store = tx.objectStore('transactions');
            const index = store.index('sessionId');
            const request = index.getAll(sessionId);
            request.onsuccess = (event) => {
                const transactions = event.target.result;
                let totalSales = 0;
                let doorCount = 0;
                const $tbody = $('#transactionLog').empty();
                transactions.forEach(tx => {
                    totalSales += tx.total;
                    tx.items.forEach(item => {
                        if (item.item === 'TICKET') doorCount += 1;
                    });
                    const items = tx.items.map(i => `${i.item}: $${i.amount.toFixed(2)}`).join(', ');
                    $tbody.append(`
                        <tr>
                            <td>${tx.id}</td>
                            <td>${items}</td>
                            <td>$${tx.total.toFixed(2)}</td>
                            <td>${new Date(tx.timestamp).toLocaleString()}</td>
                        </tr>
                    `);
                });
                $('#totalSales').text(totalSales.toFixed(2));
                $('#doorCount').text(doorCount);
                $('#salesSummary').show();
            };
        }

        function loadButtonVisibility() {
            const tx = db.transaction(['buttonVisibility'], 'readonly');
            const store = tx.objectStore('buttonVisibility');
            const request = store.getAll();
            request.onsuccess = (event) => {
                const buttons = event.target.result;
                const $list = $('#buttonList').empty();
                buttons.forEach(button => {
                    const $li = $('<li>');
                    const $checkbox = $('<input type="checkbox">').prop('checked', button.visible);
                    $checkbox.on('change', () => {
                        button.visible = $checkbox.prop('checked');
                        const updateTx = db.transaction(['buttonVisibility'], 'readwrite');
                        const updateStore = updateTx.objectStore('buttonVisibility');
                        updateStore.put(button);
                    });
                    $li.append($checkbox).append(` ${button.item}`);
                    $list.append($li);
                });
            };
        }
    </script>
</body>
</html>
