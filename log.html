<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Log</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .container {
            width: 99%;
            height: calc(100vh - 20px); /* Fits viewport minus padding */
        }
        .grid {
            display: grid;
            grid-template-columns: 2fr 2fr 1.5fr;
            grid-template-rows: auto; /* No fixed header row */
            gap: 10px;
            height: 100%; /* Fills container */
        }
        .graph {
            grid-column: 1;
            grid-row: 1;
            background-color: #2e2e2e;
            padding: 20px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease;
        }
        .middle-panel {
            grid-column: 2;
            grid-row: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .tally-sheet {
            height: 300px; /* Fixed height, adjustable if needed */
            background-color: #2e2e2e;
            padding: 20px;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
        }
        .tally-table-wrapper {
            flex: 1;
            overflow-y: auto;
        }
        .tally-sheet table {
            table-layout: fixed;
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .tally-sheet th, .tally-sheet td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        .transaction-log {
            flex: 1;
            overflow-y: auto;
            background-color: #2e2e2e;
            padding: 20px;
            border-radius: 5px;
        }
        .right-panel {
            grid-column: 3;
            grid-row: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 10px;
        }
        .filters, .summary {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden; /* Prevents horizontal scrolling */
            background-color: #2e2e2e;
            padding: 20px;
            border-radius: 5px;
        }
        .filters select {
            max-width: 100%; /* Ensures select fits container */
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
        }
        .graph-wrapper {
            flex: 1;
            min-height: 0;
        }
        #doorCountChart {
            width: 100%;
            height: 100%;
        }
        .transaction-log table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        .transaction-log th, .transaction-log td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        th {
            background-color: #3e3e3e;
            color: #ffffff;
        }
        .summary h3 {
            font-size: 18px;
        }
        .filters label, .filters select, .filters button {
            display: block;
            margin: 10px 0;
            width: 100%;
            padding: 8px;
            font-size: 16px;
        }
        .filters button {
            background-color: #0288d1;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #exportBtn {
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            padding: 8px;
            font-size: 16px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #2e2e2e;
            margin: 15% auto;
            padding: 20px;
            width: 300px;
            border-radius: 5px;
            text-align: center;
        }
        .modal-content input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background-color: #333;
            color: #e0e0e0;
            border: 1px solid #555;
            font-size: 16px;
        }
        .modal-content button {
            padding: 10px 20px;
            background-color: #2e7d32;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .error {
            color: #d32f2f;
            margin-top: 10px;
        }
        .graph.fullscreen {
            height: 100%; /* Expands within column */
        }
        .cash-header { color: #2e7d32; }
        .credit-card-header { color: #d32f2f; }
        .comp-header { color: #ffdab9; }
        .ticket-header { color: #1a73e8; }
        .summary h3 span { color: orange; }
        .total-row td { color: orange; }
    </style>
</head>
<body>
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <h2>Admin Login</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password">
            <button id="loginBtn">Login</button>
            <p id="errorMsg" class="error"></p>
        </div>
    </div>

    <div class="container" id="salesLogContainer">
        <div class="grid">
            <div class="graph">
                <h2>Customer Count Over Time</h2>
                <button id="toggleGraphSize">Toggle Full Screen</button>
                <div class="graph-wrapper">
                    <canvas id="doorCountChart"></canvas>
                </div>
            </div>
            <div class="middle-panel">
                <div class="tally-sheet">
                    <h2>Tally Sheet</h2>
                    <div class="tally-table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th class="col-payment-type">Payment Type</th>
                                    <th class="col-people">People</th>
                                    <th class="col-total-amount">Total Amount</th>
                                    <th class="col-price-per-person">Price per Person</th>
                                </tr>
                            </thead>
                            <tbody id="summaryBody"></tbody>
                        </table>
                    </div>
                    <table class="tally-totals">
                        <tbody id="summaryTotals">
                            <tr class="total-row">
                                <td class="col-payment-type"><strong>TOTALS</strong></td>
                                <td class="col-people"><strong>0</strong></td>
                                <td class="col-total-amount"><strong>$0.00</strong></td>
                                <td class="col-price-per-person">#DIV/0!</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="transaction-log">
                    <h2>Transaction Log</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th class="items-header">Items</th>
                                <th class="cash-header">Cash Total</th>
                                <th>Door Count</th>
                                <th>Cashier</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody id="transactionLogBody"></tbody>
                    </table>
                </div>
            </div>
            <div class="right-panel">
                <div class="filters">
                    <h2>Filters</h2>
                    <label>Cashier Session:
                        <select id="sessionSelect">
                            <option value="">Select Cashier Session</option>
                        </select>
                    </label>
                    <button id="applyFilters">Apply</button>
                </div>
                <div class="summary">
                    <h2>Summary</h2>
                    <div id="sessionInfo"></div>
                    <h3 style="color: pink;">Total Thru Door: <span id="totalDoorCount">0</span></h3>
                    <h3 style="color: pink;">Total Cash Sales: $<span id="totalSales">0.00</span></h3>
                    <h3 style="color: pink;">Total Transactions: <span id="totalTransactions">0</span></h3>
                    <button id="exportBtn">Export to PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://nnbevkohcjnzyxgkzgna.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uYmV2a29oY2puenl4Z2t6Z25hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDE5OTU5NTksImV4cCI6MjA1NzU3MTk1OX0.azv5XuUBxoyvr19-eGxnl37X7u0GOlCRj3L0jZ_8JHY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const adminUsername = "admin";
        const adminPassword = "password123";
        const LOGIN_TIMEOUT = 8 * 60 * 60 * 1000;
        const channel = new BroadcastChannel('transaction_channel');

        const loginModal = document.getElementById('loginModal');
        const salesLogContainer = document.getElementById('salesLogContainer');
        const errorMsg = document.getElementById('errorMsg');

        let sessionTimeoutId;
        let salesLogInstance;
        let chart;
        let selectedSessionId = null;

        class SalesLog {
            constructor() {
                this.transactions = [];
                const urlParams = new URLSearchParams(window.location.search);
                const sessionIdFromUrl = urlParams.get('sessionId');
                const exportFlag = urlParams.get('export');

                if (sessionIdFromUrl) selectedSessionId = sessionIdFromUrl;

                this.updateInterval = null;
                this.init().then(() => {
                    this.updateLog();
                    if (exportFlag === 'true') this.exportPDF();
                    this.updateInterval = setInterval(() => this.updateLog(), 5000);
                    channel.onmessage = (event) => {
                        if (event.data.type === 'new_transaction') this.updateLog();
                        else if (event.data.type === 'new_session') {
                            selectedSessionId = event.data.sessionId;
                            this.updateLog();
                        }
                    };
                    supabase
                        .channel('public:transactions')
                        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'transactions' }, () => this.updateLog())
                        .subscribe(status => console.log('Subscription status:', status));
                });

                document.getElementById('exportBtn').addEventListener('click', () => this.exportPDF());
                document.getElementById('applyFilters').addEventListener('click', () => {
                    selectedSessionId = document.getElementById('sessionSelect').value || null;
                    this.updateLog();
                });
                document.getElementById('sessionSelect').addEventListener('change', (event) => {
                    selectedSessionId = event.target.value || null;
                    this.updateLog();
                });
                document.getElementById('toggleGraphSize').addEventListener('click', () => {
                    const graph = document.querySelector('.graph');
                    graph.classList.toggle('fullscreen');
                    if (chart) requestAnimationFrame(() => chart.resize());
                });
            }

            async init() {
                await this.updateLog();
            }

            stop() {
                if (this.updateInterval) clearInterval(this.updateInterval);
            }

            async updateLog() {
                try {
                    const { data: allTransactions, error } = await supabase
                        .from('transactions')
                        .select('*')
                        .order('sessionId', { ascending: false });
                    if (error) throw new Error(`Error fetching transactions: ${error.message}`);

                    const allSessionIds = [...new Set(allTransactions.map(t => t.sessionId))];
                    const sessionSelect = document.getElementById('sessionSelect');
                    sessionSelect.innerHTML = '<option value="">Select Cashier Session</option>' +
                        allSessionIds.map(id => {
                            const sessionTx = allTransactions.find(t => t.sessionId === id);
                            const cashier = sessionTx ? sessionTx.cashierName : 'Unknown';
                            return `<option value="${id}" ${id === selectedSessionId ? 'selected' : ''}>${cashier} - ${id}</option>`;
                        }).join('');

                    if (!selectedSessionId && allSessionIds.length > 0) selectedSessionId = allSessionIds[0];
                    if (!selectedSessionId) {
                        document.getElementById('sessionInfo').innerHTML = '<p>No session available</p>';
                        if (chart) {
                            chart.data.datasets = [];
                            chart.update();
                        }
                        document.getElementById('summaryBody').innerHTML = '';
                        document.getElementById('summaryTotals').innerHTML = `
                            <tr class="total-row">
                                <td class="col-payment-type"><strong>TOTALS</strong></td>
                                <td class="col-people"><strong>0</strong></td>
                                <td class="col-total-amount"><strong>$0.00</strong></td>
                                <td class="col-price-per-person">#DIV/0!</td>
                            </tr>
                        `;
                        document.getElementById('transactionLogBody').innerHTML = '';
                        document.getElementById('totalDoorCount').textContent = '0';
                        document.getElementById('totalSales').textContent = '0.00';
                        document.getElementById('totalTransactions').textContent = '0';
                        return;
                    }

                    const transactions = allTransactions.filter(t => t.sessionId.toString() === selectedSessionId.toString());
                    this.transactions = transactions;
                    sessionSelect.value = selectedSessionId;
                    transactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    const uniqueCashiers = [...new Set(transactions.map(t => t.cashierName))];
                    document.getElementById('sessionInfo').innerHTML = `<p>Event Name: ${selectedSessionId}</p><p>Cashier(s): ${uniqueCashiers.join(', ')}</p>`;

                    const itemSummary = {};
                    let totalDoorCount = 0;
                    let totalSales = 0;

                    transactions.forEach(t => {
                        const items = t.items.split('; ');
                        items.forEach(item => {
                            const [key, value] = item.split(': ');
                            if (key && value) {
                                const [countStr, priceStr] = value.split(' @ ');
                                const count = parseInt(countStr, 10) || 0;
                                const price = priceStr ? parseFloat(priceStr.replace('$', '')) : 0;
                                if (!itemSummary[key]) itemSummary[key] = { people: 0, total: 0, price };
                                itemSummary[key].people += count;
                                itemSummary[key].total += count * price;
                            }
                        });
                        totalDoorCount += t.doorCount || 0;
                        totalSales += t.cashTotal || 0;
                    });

                    document.getElementById('totalDoorCount').textContent = totalDoorCount;
                    document.getElementById('totalSales').textContent = totalSales.toFixed(2);
                    document.getElementById('totalTransactions').textContent = transactions.length;

                    const summaryRows = Object.entries(itemSummary)
                        .map(([key, data]) => `
                            <tr>
                                <td class="col-payment-type">${key}</td>
                                <td class="col-people">${data.people}</td>
                                <td class="col-total-amount">$${data.total.toFixed(2)}</td>
                                <td class="col-price-per-person">$${data.price.toFixed(2)}</td>
                            </tr>
                        `).join('');
                    const totalsRow = `
                        <tr class="total-row">
                            <td class="col-payment-type"><strong>TOTALS</strong></td>
                            <td class="col-people"><strong>${totalDoorCount}</strong></td>
                            <td class="col-total-amount"><strong>$${totalSales.toFixed(2)}</strong></td>
                            <td class="col-price-per-person">${totalDoorCount ? (totalSales / totalDoorCount).toFixed(2) : '#DIV/0!'}</td>
                        </tr>
                    `;

                    document.getElementById('summaryBody').innerHTML = summaryRows;
                    document.getElementById('summaryTotals').innerHTML = totalsRow;

                    const transactionLogBody = document.getElementById('transactionLogBody');
                    transactionLogBody.innerHTML = transactions.map(t => `
                        <tr>
                            <td>${new Date(t.timestamp).toLocaleString()}</td>
                            <td>${colorCodeItems(t.items)}</td>
                            <td class="cash-header">$${t.cashTotal.toFixed(2)}</td>
                            <td>${t.doorCount}</td>
                            <td>${t.cashierName}</td>
                            <td>${t.note || ''}</td>
                        </tr>
                    `).join('');

                    const types = ['Cash', 'Credit Card', 'Comp', 'Ticket'];
                    const datasets = types.map(type => ({
                        label: type,
                        data: [],
                        borderColor: getColorForType(type),
                        fill: false
                    }));
                    const totalDataset = {
                        label: 'Total',
                        data: [],
                        borderColor: '#808080',
                        fill: false
                    };
                    let cumulativeCounts = {};
                    types.forEach(type => cumulativeCounts[type] = 0);
                    let cumulativeTotal = 0;

                    transactions.forEach(t => {
                        const items = t.items.split('; ');
                        let transactionDoorCount = 0;
                        items.forEach(item => {
                            const [key, value] = item.split(': ');
                            if (key && value) {
                                const [countStr] = value.split(' @ ');
                                const count = parseInt(countStr, 10) || 0;
                                transactionDoorCount += count;
                                let type;
                                if (key.startsWith('Cash')) type = 'Cash';
                                else if (key.startsWith('Credit Card')) type = 'Credit Card';
                                else if (key.startsWith('Comp')) type = 'Comp';
                                else if (key.startsWith('Ticket')) type = 'Ticket';
                                if (types.includes(type)) cumulativeCounts[type] += count;
                            }
                        });
                        cumulativeTotal += transactionDoorCount;
                        types.forEach(type => {
                            datasets.find(d => d.label === type).data.push({
                                x: t.timestamp,
                                y: cumulativeCounts[type]
                            });
                        });
                        totalDataset.data.push({
                            x: t.timestamp,
                            y: cumulativeTotal
                        });
                    });

                    datasets.push(totalDataset);

                    if (chart) {
                        chart.data.datasets = datasets;
                        chart.update();
                    } else {
                        chart = new Chart(document.getElementById('doorCountChart'), {
                            type: 'line',
                            data: { datasets },
                            options: {
                                maintainAspectRatio: false,
                                scales: {
                                    x: { type: 'time', time: { unit: 'minute', stepSize: 15 }, title: { display: true, text: 'Time' } },
                                    y: { beginAtZero: true, title: { display: true, text: 'Cumulative Customer Count' } }
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.error('Error updating log:', error);
                }
            }

            async exportPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });
                const pageWidth = doc.internal.pageSize.getWidth();
                const margin = 10;
                const graphWidth = pageWidth - 2 * margin;
                const graphHeight = (400 * graphWidth) / 800;

                doc.setFontSize(16);
                doc.text('Sales Log Summary', pageWidth / 2, margin, { align: 'center' });

                const sessionInfo = document.getElementById('sessionInfo').innerText;
                doc.setFontSize(12);
                doc.text(sessionInfo, margin, margin + 10);

                const summaryData = [
                    ['Total Thru Door', document.getElementById('totalDoorCount').innerText],
                    ['Total Cash Sales', '$' + document.getElementById('totalSales').innerText],
                    ['Total Transactions', document.getElementById('totalTransactions').innerText]
                ];
                doc.autoTable({
                    startY: margin + 20,
                    head: [['Metric', 'Value']],
                    body: summaryData,
                    theme: 'grid',
                    styles: { fontSize: 10 }
                });

                const tallyTable = document.querySelector('.tally-sheet table');
                const tallyTotalsTable = document.querySelector('.tally-totals');
                const tallyData = Array.from(tallyTable.querySelectorAll('tr')).map(row => 
                    Array.from(row.cells).map(cell => cell.innerText)
                ).concat(
                    Array.from(tallyTotalsTable.querySelectorAll('tr')).map(row => 
                        Array.from(row.cells).map(cell => cell.innerText)
                    )
                );
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 10,
                    head: [tallyData[0]],
                    body: tallyData.slice(1),
                    theme: 'grid',
                    styles: { fontSize: 8 }
                });

                const transactionTable = document.querySelector('.transaction-log table');
                const transactionData = Array.from(transactionTable.querySelectorAll('tr')).map(row => 
                    Array.from(row.cells).map(cell => cell.innerText)
                );
                doc.autoTable({
                    startY: doc.lastAutoTable.finalY + 10,
                    head: [transactionData[0]],
                    body: transactionData.slice(1),
                    theme: 'grid',
                    styles: { fontSize: 8 }
                });

                const canvas = document.getElementById('doorCountChart');
                await waitForChartRender(chart);
                const mainGraphImage = canvas.toDataURL('image/png');

                const startTime = new Date(Math.min(...this.transactions.map(t => new Date(t.timestamp))));
                const endTime = new Date(Math.max(...this.transactions.map(t => new Date(t.timestamp))));
                const interval = 15 * 60 * 1000;
                const types = ['Cash', 'Credit Card', 'Comp', 'Ticket'];

                for (let time = startTime.getTime(); time < endTime.getTime(); time += interval) {
                    const intervalStart = new Date(time);
                    const intervalEnd = new Date(time + interval);
                    const intervalTransactions = this.transactions.filter(t => {
                        const txTime = new Date(t.timestamp);
                        return txTime >= intervalStart && txTime < intervalEnd;
                    });

                    if (intervalTransactions.length > 0) {
                        const intervalSummary = {};
                        types.forEach(type => intervalSummary[type] = 0);
                        let intervalTotal = 0;

                        intervalTransactions.forEach(t => {
                            const items = t.items.split('; ');
                            items.forEach(item => {
                                const [key, value] = item.split(': ');
                                if (key && value) {
                                    const [countStr] = value.split(' @ ');
                                    const count = parseInt(countStr, 10) || 0;
                                    let type;
                                    if (key.startsWith('Cash')) type = 'Cash';
                                    else if (key.startsWith('Credit Card')) type = 'Credit Card';
                                    else if (key.startsWith('Comp')) type = 'Comp';
                                    else if (key.startsWith('Ticket')) type = 'Ticket';
                                    if (types.includes(type)) intervalSummary[type] += count;
                                }
                            });
                            intervalTotal += t.doorCount || 0;
                        });

                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = 800;
                        tempCanvas.height = 400;
                        document.body.appendChild(tempCanvas);

                        const barChart = new Chart(tempCanvas, {
                            type: 'bar',
                            data: {
                                labels: types.concat('Total'),
                                datasets: [{
                                    label: 'Count',
                                    data: types.map(type => intervalSummary[type]).concat(intervalTotal),
                                    backgroundColor: types.map(type => getColorForType(type)).concat('#808080'),
                                }]
                            },
                            options: {
                                scales: {
                                    y: { beginAtZero: true }
                                }
                            }
                        });

                        await waitForChartRender(barChart);
                        const barChartImage = tempCanvas.toDataURL('image/png');
                        doc.addPage();
                        doc.text(`Sales Summary for ${intervalStart.toLocaleTimeString()} - ${intervalEnd.toLocaleTimeString()}`, pageWidth / 2, margin, { align: 'center' });
                        doc.addImage(barChartImage, 'PNG', margin, margin + 10, graphWidth, graphHeight);

                        barChart.destroy();
                        tempCanvas.remove();
                    }
                }

                doc.addPage();
                doc.text('Customer Count Over Time (Full Session)', pageWidth / 2, margin, { align: 'center' });
                doc.addImage(mainGraphImage, 'PNG', margin, margin + 10, graphWidth, graphHeight);

                doc.save(`sales_log_${selectedSessionId || 'latest'}.pdf`);
            }
        }

        function getColorForType(type) {
            const colors = {
                'Cash': '#2e7d32',
                'Credit Card': '#d32f2f',
                'Comp': '#ffdab9',
                'Ticket': '#1a73e8',
                'Total': '#808080'
            };
            return colors[type] || '#888888';
        }

        function colorCodeItems(items) {
            const types = ['Cash', 'Credit Card', 'Comp', 'Ticket'];
            return items.split('; ').map(item => {
                const type = types.find(t => item.startsWith(t));
                if (type) {
                    const rest = item.slice(type.length);
                    return `<span class="${type.toLowerCase().replace(' ', '-')}-header">${type}</span>${rest}`;
                }
                return item;
            }).join('; ');
        }

        function waitForChartRender(chart) {
            return new Promise(resolve => {
                chart.update();
                setTimeout(resolve, 200);
            });
        }

        function isLoggedIn() {
            return localStorage.getItem('isLoggedIn') === 'true';
        }

        function setLoggedIn(value) {
            localStorage.setItem('isLoggedIn', value ? 'true' : 'false');
        }

        function logout() {
            clearTimeout(sessionTimeoutId);
            setLoggedIn(false);
            if (salesLogInstance) salesLogInstance.stop();
            salesLogContainer.style.display = 'none';
            loginModal.style.display = 'block';
        }

        const loginTime = parseInt(localStorage.getItem('loginTime'), 10);
        if (isLoggedIn() && loginTime && (Date.now() - loginTime < LOGIN_TIMEOUT)) {
            salesLogContainer.style.display = 'block';
            loginModal.style.display = 'none';
            salesLogInstance = new SalesLog();
            const remainingTime = LOGIN_TIMEOUT - (Date.now() - loginTime);
            sessionTimeoutId = setTimeout(logout, remainingTime);
        } else {
            setLoggedIn(false);
            salesLogContainer.style.display = 'none';
            loginModal.style.display = 'block';
        }

        document.getElementById('loginBtn').addEventListener('click', () => {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            if (username === adminUsername && password === adminPassword) {
                setLoggedIn(true);
                localStorage.setItem('loginTime', Date.now().toString());
                sessionTimeoutId = setTimeout(logout, LOGIN_TIMEOUT);
                loginModal.style.display = 'none';
                salesLogContainer.style.display = 'block';
                salesLogInstance = new SalesLog();
                errorMsg.textContent = '';
            } else {
                errorMsg.textContent = 'Invalid username or password';
            }
        });
    </script>
</body>
</html>
