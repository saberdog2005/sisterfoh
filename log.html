<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Log</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            display: flex;
            justify-content: space-between;
            max-width: 1200px;
            margin: 20px auto;
        }
        .left-column, .right-column {
            width: 48%;
        }
        #salesStatus {
            margin-bottom: 10px;
            font-size: 18px;
        }
        #transactionTable {
            width: 100%;
            border-collapse: collapse;
        }
        #transactionTable th, #transactionTable td {
            border: 1px solid #444;
            padding: 8px;
            text-align: left;
        }
        #transactionTable th {
            background-color: #333;
        }
        canvas {
            max-width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="left-column">
            <div id="salesStatus">Sales Closed</div>
            <canvas id="thruDoorChart"></canvas>
        </div>
        <div class="right-column">
            <table id="transactionTable">
                <thead>
                    <tr>
                        <th>Timestamp</th>
                        <th>Category</th>
                        <th>Door Count</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let chart;
        let db;

        // Open IndexedDB
        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SalesDB', 2);
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        // Fetch all transactions
        async function fetchTransactions(db) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction('transactions', 'readonly');
                const store = tx.objectStore('transactions');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // Process transactions for graph
        function processData(transactions) {
            transactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            const categories = ['Cash', 'CC TRANS', 'TICKET', 'COMP'];
            const data = {
                labels: [],
                datasets: categories.map(cat => ({ label: cat, data: [], borderColor: getColor(cat), fill: false })),
                total: { label: 'Total', data: [], borderColor: '#ffff00', fill: false } // Yellow for visibility
            };
            let counts = { 'Cash': 0, 'CC TRANS': 0, 'TICKET': 0, 'COMP': 0 };

            transactions.forEach(tx => {
                data.labels.push(new Date(tx.timestamp).toLocaleTimeString());
                if (categories.includes(tx.category)) {
                    counts[tx.category]++;
                }
                categories.forEach((cat, index) => {
                    data.datasets[index].data.push(counts[cat]);
                });
                data.total.data.push(tx.doorCount);
            });

            return data;
        }

        // Assign colors for graph lines
        function getColor(category) {
            const colors = {
                'Cash': '#00bfff',     // Light blue
                'CC TRANS': '#7cfc00', // Light green
                'TICKET': '#ff4500',   // Orange red
                'COMP': '#da70d6'      // Orchid
            };
            return colors[category] || 'gray';
        }

        // Update Chart.js graph
        function updateChart(data) {
            const ctx = document.getElementById('thruDoorChart').getContext('2d');
            if (chart) {
                chart.data.labels = data.labels;
                chart.data.datasets = [...data.datasets, data.total];
                chart.update();
            } else {
                chart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [...data.datasets, data.total]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Count', color: '#e0e0e0' },
                                ticks: { color: '#e0e0e0' }
                            },
                            x: {
                                title: { display: true, text: 'Time', color: '#e0e0e0' },
                                ticks: { color: '#e0e0e0' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#e0e0e0' } }
                        }
                    }
                });
            }
        }

        // Update transaction table
        function updateTable(transactions) {
            const tbody = document.querySelector('#transactionTable tbody');
            tbody.innerHTML = '';
            transactions.forEach(tx => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(tx.timestamp).toLocaleString()}</td>
                    <td>${tx.category}</td>
                    <td>${tx.doorCount}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update sales status
        function updateSalesStatus() {
            const salesOpen = localStorage.getItem('salesOpen') === 'true';
            const cashierName = localStorage.getItem('cashierName') || 'Unknown';
            const eventName = localStorage.getItem('eventName') || 'Unknown';
            const statusDiv = document.getElementById('salesStatus');
            statusDiv.textContent = salesOpen 
                ? `Sales Open - Cashier: ${cashierName} - Event: ${eventName}`
                : 'Sales Closed';
        }

        // Main update function
        async function updateDisplay() {
            try {
                const transactions = await fetchTransactions(db);
                const data = processData(transactions);
                updateChart(data);
                updateTable(transactions);
                updateSalesStatus();
            } catch (error) {
                console.error('Update failed:', error);
            }
        }

        // Initialize and set real-time updates
        async function init() {
            db = await openDB();
            await updateDisplay();
            setInterval(updateDisplay, 5000); // Update every 5 seconds
        }

        init().catch(error => console.error('Initialization failed:', error));
    </script>
</body>
</html>
