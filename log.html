<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Log</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; }
        #doorCountChart { margin-bottom: 20px; }
        .transaction { padding: 10px; background: #fff; margin: 5px 0; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .cash { color: green; }
        .cc { color: blue; }
        .ticket { color: orange; }
        .comp { color: red; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sales Log</h1>
        <canvas id="doorCountChart" width="400" height="200"></canvas>
        <div id="log"></div>
    </div>

    <script>
        let chart;

        class SalesLog {
            constructor() {
                this.db = null;
                this.initDB();
            }

            initDB() {
                const request = indexedDB.open('SalesDB', 2);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('transactions')) {
                        db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    this.updateChart();
                    setInterval(() => this.updateChart(), 5000);
                };
                request.onerror = (event) => console.error('Database error:', event.target.error);
            }

            updateChart() {
                const activeSessionId = localStorage.getItem('activeSessionId');
                if (!activeSessionId) {
                    if (chart) {
                        chart.data.datasets[0].data = [];
                        chart.update();
                    }
                    document.getElementById('log').innerHTML = '<p>No active session</p>';
                    return;
                }
                const tx = this.db.transaction(['transactions'], 'readonly');
                const store = tx.objectStore('transactions');
                const request = store.getAll();
                request.onsuccess = () => {
                    const allTransactions = request.result;
                    const sessionTransactions = allTransactions.filter(t => t.sessionId === activeSessionId);
                    sessionTransactions.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                    const dataPoints = sessionTransactions.map(t => ({ x: t.timestamp, y: t.doorCount }));
                    if (chart) {
                        chart.data.datasets[0].data = dataPoints;
                        chart.update();
                    } else {
                        chart = new Chart(document.getElementById('doorCountChart'), {
                            type: 'line',
                            data: {
                                datasets: [{
                                    label: 'Thru Door Count',
                                    data: dataPoints,
                                    borderColor: 'purple',
                                    backgroundColor: 'rgba(128, 0, 128, 0.1)',
                                    fill: true
                                }]
                            },
                            options: {
                                scales: {
                                    x: { type: 'time', time: { unit: 'minute' } },
                                    y: { beginAtZero: true }
                                }
                            }
                        });
                    }
                    this.displayLog(sessionTransactions);
                };
            }

            displayLog(transactions) {
                const log = document.getElementById('log');
                log.innerHTML = transactions.map(t => {
                    const items = t.items.split(', ').map(item => {
                        const [key] = item.split(': ');
                        let className = '';
                        if (key.startsWith('CASH')) className = 'cash';
                        else if (key === 'CC TRANS') className = 'cc';
                        else if (key === 'TICKET') className = 'ticket';
                        else if (key === 'COMP') className = 'comp';
                        return `<span class="${className}">${item}</span>`;
                    }).join(', ');
                    return `<div class="transaction">[${new Date(t.timestamp).toLocaleString()}] Session ${t.sessionId}: ${items} | Cash: $${t.cashTotal.toFixed(2)} | Thru Door: ${t.doorCount}</div>`;
                }).join('');
            }
        }

        new SalesLog();
    </script>
</body>
</html>
