<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Log</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1e1e1e;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            font-size: 16px;
        }
        .log-container {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }
        select, button {
            padding: 5px;
            font-size: 16px;
            background: #424242;
            color: #e0e0e0;
            border: none;
            border-radius: 4px;
            margin-right: 10px;
        }
        h2 {
            margin-top: 0;
        }
        .message {
            color: #ff6b6b;
            margin-top: 10px;
        }
        #transactions p {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="log-container">
        <h2>Select Session</h2>
        <select id="sessionSelect"><option value="">Select a session</option></select>
        <button id="refreshBtn">Refresh</button>
    </div>
    <div class="log-container" id="sessionDetails">
        <h2>Session Details</h2>
        <p>Date: <span id="sessionDate"></span></p>
        <p>Venue: <span id="sessionVenue"></span></p>
        <p>Event Name: <span id="sessionEventName"></span></p>
        <p>Cashier: <span id="sessionCashier"></span></p>
    </div>
    <div class="log-container" id="transactionLog">
        <h2>Transaction Log</h2>
        <div id="transactions"></div>
    </div>
    <div class="log-container" id="grandTotal">
        <h2>Grand Total</h2>
        <p>$<span id="sessionGrandTotal">0.00</span></p>
    </div>
    <div id="message" class="message"></div>
    <script>
        const API_KEY = 'AIzaSyAS_wlduCCcRSDA3Hjt3hMPRg3olegY2Ic';
        const SPREADSHEET_ID = '1dJ0NuByJCDgnIRKhsmKrWFyBtCHRgR7ujfGDRb9jhMY';
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

        async function loadSessions() {
            try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A:F'
                });
                const rows = response.result.values || [];
                const sessions = rows.filter(row => row[0] === 'SESSION_START').map(row => row[1]);
                const uniqueSessions = [...new Set(sessions)];
                const $select = $('#sessionSelect');
                $select.empty().append('<option value="">Select a session</option>');
                uniqueSessions.forEach(id => $select.append(`<option value="${id}">${id}</option>`));
            } catch (error) {
                console.error('Error loading sessions:', error);
                $('#message').text('Failed to load sessions. Check console.');
            }
        }

        async function updateLog(sessionId) {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: 'Sheet1!A:I'
                });
                const rows = response.result.values || [];
                let sessionInfo = { transactions: [], grandTotal: null };
                rows.forEach(row => {
                    if (row[1] === sessionId) {
                        if (row[0] === 'SESSION_START') {
                            sessionInfo.date = row[2];
                            sessionInfo.venue = row[3];
                            sessionInfo.eventName = row[4];
                            sessionInfo.cashier = row[5];
                        } else if (row[0] === 'TRANSACTION') {
                            try {
                                const itemList = JSON.parse(row[4]);
                                sessionInfo.transactions.push({
                                    time: row[3],
                                    items: itemList,
                                    total: row[5],
                                    note: row[6],
                                    doorCount: row[7]
                                });
                            } catch (e) {
                                console.error('Error parsing item list:', e);
                            }
                        } else if (row[0] === 'SESSION_CLOSE') {
                            sessionInfo.grandTotal = row[2];
                        }
                    }
                });

                $('#sessionDate').text(sessionInfo.date || '');
                $('#sessionVenue').text(sessionInfo.venue || '');
                $('#sessionEventName').text(sessionInfo.eventName || '');
                $('#sessionCashier').text(sessionInfo.cashier || '');

                const $transactions = $('#transactions').empty();
                if (sessionInfo.transactions.length === 0) {
                    $transactions.append('<p>No transactions found.</p>');
                } else {
                    sessionInfo.transactions.forEach(tr => {
                        const items = tr.items.map(item => `${item.item} (${item.quantity})`).join(', ');
                        $transactions.append(`<p>${tr.time} - ${items} - $${tr.total} - Door: ${tr.doorCount} ${tr.note ? '(' + tr.note + ')' : ''}</p>`);
                    });
                }

                $('#sessionGrandTotal').text(sessionInfo.grandTotal ? sessionInfo.grandTotal : 'Not closed');
            } catch (error) {
                console.error('Error updating log:', error);
                $('#message').text('Failed to update log. Check console.');
            }
        }

        $(document).ready(() => {
            gapi.load('client', loadSessions);
            $('#sessionSelect').on('change', function() {
                const sessionId = $(this).val();
                if (sessionId) updateLog(sessionId);
                else {
                    $('#sessionDate, #sessionVenue, #sessionEventName, #sessionCashier').text('');
                    $('#transactions').empty();
                    $('#sessionGrandTotal').text('0.00');
                }
            });
            $('#refreshBtn').on('click', () => {
                const sessionId = $('#sessionSelect').val();
                if (sessionId) updateLog(sessionId);
                else loadSessions();
            });
        });
    </script>
</body>
</html>
